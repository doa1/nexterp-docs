<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exodus</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><h1 id="exodus-hospital-management-information-system-hmis">Exodus Hospital Management Information System (HMIS)</h1>
<h1 id="comprehensive-technical-document">Comprehensive Technical Document</h1>
<p><strong>Version:</strong> 1.0<br>
<strong>Date:</strong> February 2026<br>
<strong>Status:</strong> Specification — Ready for Implementation</p>
<hr>
<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="#1-executive-overview">Executive Overview</a></li>
<li><a href="#2-architecture--technology-stack">Architecture &amp; Technology Stack</a></li>
<li><a href="#3-core-architectural-patterns">Core Architectural Patterns</a></li>
<li><a href="#4-system-architecture-deep-dive">System Architecture Deep Dive</a></li>
<li><a href="#5-database-design--models">Database Design &amp; Models</a></li>
<li><a href="#6-module-breakdown--api-design">Module Breakdown &amp; API Design</a></li>
<li><a href="#7-frontend-architecture">Frontend Architecture</a></li>
<li><a href="#8-security--compliance">Security &amp; Compliance</a></li>
<li><a href="#9-integrations">Integrations</a></li>
<li><a href="#10-development-roadmap">Development Roadmap</a></li>
<li><a href="#11-project-structure">Project Structure</a></li>
<li><a href="#12-non-functional-requirements">Non-Functional Requirements</a></li>
</ol>
<hr>
<h2 id="executive-overview">1. Executive Overview</h2>
<h3 id="product-definition">Product Definition</h3>
<p>A <strong>purpose-built Hospital Management Information System</strong> designed to run the complete clinical, administrative, financial, and operational workflows of a hospital or clinic — from <em>patient walk-in → diagnosis → treatment → billing → discharge → follow-up</em>.</p>
<h3 id="what-makes-this-different">What Makes This Different</h3>
<p>Unlike generic ERP systems adapted for healthcare, Exodus HMIS is built <strong>clinical-first</strong>. Every architectural decision prioritizes:</p>
<ul>
<li><strong>Patient safety</strong> — audit trails on every clinical action</li>
<li><strong>Clinical workflow continuity</strong> — a patient’s journey is seamless across departments</li>
<li><strong>Financial accuracy</strong> — all clinical events auto-generate correct billing entries</li>
<li><strong>Regulatory compliance</strong> — MOH/HMIS reporting, NHIF insurance, Kenya health standards</li>
</ul>
<h3 id="core-innovation-clinical-financial-bridge">Core Innovation: Clinical-Financial Bridge</h3>
<p>Exodus HMIS uses a <strong>Clinical Encounter Model</strong> as the single source of truth for all patient interactions, which automatically flows to billing, inventory consumption, lab orders, and pharmacy. Every clinical event is simultaneously a financial event, eliminating revenue leakage and manual billing.</p>
<pre><code>CLINICAL ENCOUNTER (Single Entry Point)
    ↓
    ├─ OPD Consultation    → Billing: Consultation fee
    │                      → Pharmacy: Prescription
    │                      → Lab: Test orders
    │
    ├─ Admission (IPD)     → Billing: Bed charges (daily)
    │                      → Nursing: Medication admin
    │                      → Pharmacy: Drug dispensing
    │                      → Lab: Ongoing tests
    │
    ├─ Lab Test            → Billing: Lab fees
    │                      → Inventory: Reagent consumption
    │
    └─ Drug Dispensing     → Billing: Drug costs
                           → Inventory: Stock deduction
                           → GL: Revenue posting
</code></pre>
<h3 id="target-users">Target Users</h3>

<table>
<thead>
<tr>
<th>Role</th>
<th>Primary Module</th>
<th>Key Actions</th>
</tr>
</thead>
<tbody>
<tr>
<td>Patient</td>
<td>Patient Portal</td>
<td>Book appointments, view records, pay via M-Pesa, treatment history</td>
</tr>
<tr>
<td>Doctor/Clinician</td>
<td>EMR</td>
<td>Consultations, diagnoses, prescriptions, lab/imaging orders, follow-ups</td>
</tr>
<tr>
<td>Nurse</td>
<td>Ward Management</td>
<td>Vitals, triage, medication admin, patient notes</td>
</tr>
<tr>
<td>Receptionist / Admin</td>
<td>Registration</td>
<td>Patient registration + QR, appointments, billing oversight, queues</td>
</tr>
<tr>
<td>Lab Technician</td>
<td>LIS</td>
<td>Process orders, enter results, specimen tracking</td>
</tr>
<tr>
<td>Pharmacist</td>
<td>Pharmacy</td>
<td>Dispense drugs, batch/expiry management, stock</td>
</tr>
<tr>
<td>Dentist</td>
<td>Dental</td>
<td>Dental procedures, notes, charting, billing codes</td>
</tr>
<tr>
<td>Physiotherapist</td>
<td>Physiotherapy</td>
<td>Sessions, care plans, session notes, appointments</td>
</tr>
<tr>
<td>Finance/Billing</td>
<td>Billing</td>
<td>Invoices, insurance claims, payments, void/refunds</td>
</tr>
<tr>
<td>Accountant</td>
<td>Accounting</td>
<td>Income/expenses, P&amp;L, daily cashflow, data export, period close</td>
</tr>
<tr>
<td>Hospital Admin</td>
<td>Dashboard</td>
<td>Users, permissions, KPIs, all reports, impersonation</td>
</tr>
</tbody>
</table><h3 id="mvp-scope">MVP Scope</h3>
<pre><code>Phase 1 (Months 1-6):  OPD → EMR → Pharmacy → Lab → Billing → Patient Portal
Phase 2 (Months 7-12): IPD → Ward → Insurance → Dental → Physiotherapy → Accounting
Phase 3 (Month 13+):   Mobile App → Radiology → HMIS Integration → AI Features
</code></pre>
<hr>
<h2 id="architecture--technology-stack">2. Architecture &amp; Technology Stack</h2>
<h3 id="architecture-pattern-modular-monolith">Architecture Pattern: Modular Monolith</h3>
<p>The HMIS follows a <strong>modular monolith</strong> architecture: a single deployable backend application with clearly separated internal module boundaries (Patient, EMR, Pharmacy, Lab, Billing, etc.). Each module owns its models, schemas, services, and routes. Modules communicate through service calls — never through direct cross-module DB queries.</p>
<p>This pattern is chosen over microservices for a clinical system because:</p>
<ul>
<li><strong>Transactional integrity</strong> — billing, inventory, and GL updates happen in a single DB transaction</li>
<li><strong>Operational simplicity</strong> — one deployment, one database, one log stream</li>
<li><strong>Clear boundaries</strong> — module structure enforces separation without the operational cost of distributed services</li>
<li>Modules can be split into independent services in future if scale demands it</li>
</ul>
<h3 id="backend">Backend</h3>

<table>
<thead>
<tr>
<th>Component</th>
<th>Technology</th>
<th>Reason</th>
</tr>
</thead>
<tbody>
<tr>
<td>Framework</td>
<td><strong>Litestar 2.x</strong> (Python async)</td>
<td>Async-native, high-performance, excellent OpenAPI support</td>
</tr>
<tr>
<td>Database</td>
<td><strong>PostgreSQL 15+</strong></td>
<td>JSONB for clinical data, partitioning for history, proven reliability</td>
</tr>
<tr>
<td>ORM</td>
<td><strong>SQLAlchemy 2.0+ async</strong></td>
<td>Type-safe, async-native, mature ecosystem</td>
</tr>
<tr>
<td>Validation</td>
<td><strong>Pydantic 2.0+</strong></td>
<td>Schema validation, automatic OpenAPI generation</td>
</tr>
<tr>
<td>Auth</td>
<td><strong>JWT + bcrypt</strong></td>
<td>Stateless auth, industry standard, easy horizontal scaling</td>
</tr>
<tr>
<td>Cache</td>
<td><strong>Redis</strong></td>
<td>Sessions, queues, real-time notifications</td>
</tr>
<tr>
<td>Background Jobs</td>
<td><strong>APScheduler</strong></td>
<td>Reliable cron-style jobs (bed charges, reminders, claim submission)</td>
</tr>
<tr>
<td>WebSockets</td>
<td><strong>Litestar WebSocket</strong></td>
<td>Real-time: nurse call, queue management, ward display</td>
</tr>
<tr>
<td>File Storage</td>
<td><strong>S3-compatible</strong></td>
<td>Lab reports, X-rays, patient documents</td>
</tr>
<tr>
<td>Task Queue</td>
<td><strong>Redis + background jobs</strong></td>
<td>Insurance claim submission, SMS reminders</td>
</tr>
</tbody>
</table><h3 id="frontend">Frontend</h3>

<table>
<thead>
<tr>
<th>Component</th>
<th>Technology</th>
<th>Reason</th>
</tr>
</thead>
<tbody>
<tr>
<td>Framework</td>
<td><strong>Vue 3 + TypeScript</strong></td>
<td>Reactive, component-based, excellent for complex clinical UIs</td>
</tr>
<tr>
<td>Build Tool</td>
<td><strong>Vite</strong></td>
<td>Fast builds, instant HMR for development speed</td>
</tr>
<tr>
<td>Styling</td>
<td><strong>Tailwind CSS</strong></td>
<td>Utility-first, fully customizable to design system</td>
</tr>
<tr>
<td>State Management</td>
<td><strong>Pinia</strong></td>
<td>Lightweight, TypeScript-native, composable stores</td>
</tr>
<tr>
<td>HTTP Client</td>
<td><strong>Axios</strong></td>
<td>Interceptor support, consistent error handling</td>
</tr>
<tr>
<td>Data Grid</td>
<td><strong>rv-grid</strong></td>
<td>High-performance Vue 3 data grid for all tabular clinical data</td>
</tr>
<tr>
<td>Charts</td>
<td><strong>Chart.js + vue-chartjs</strong></td>
<td>Flexible charting for analytics dashboards</td>
</tr>
<tr>
<td>Icons</td>
<td><strong>Lucide Vue</strong></td>
<td>Stroke-based icon set, consistent weight and medical-friendly</td>
</tr>
<tr>
<td>PDF Generation</td>
<td><strong>jsPDF</strong></td>
<td>Prescriptions, lab reports, invoices</td>
</tr>
<tr>
<td>Real-time</td>
<td><strong>WebSocket composable</strong></td>
<td>Queue display, ward notifications</td>
</tr>
</tbody>
</table><h3 id="infrastructure">Infrastructure</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    LOAD BALANCER (Nginx)                     │
└──────────────┬──────────────────────────┬───────────────────┘
               │                          │
    ┌──────────▼──────────┐   ┌───────────▼──────────┐
    │   FRONTEND          │   │   BACKEND API         │
    │   Vue 3 SPA         │   │   Litestar (Python)   │
    │   (Static / CDN)    │   │   Port 8000           │
    └─────────────────────┘   └───────────┬───────────┘
                                          │
                    ┌─────────────────────┼──────────────────┐
                    │                     │                  │
          ┌─────────▼────┐    ┌───────────▼──────┐  ┌───────▼─────┐
          │  PostgreSQL   │    │     Redis         │  │  S3/MinIO   │
          │  (Primary DB) │    │  (Cache/Sessions) │  │  (Files)    │
          └──────────────┘    └──────────────────┘  └─────────────┘
</code></pre>
<hr>
<h2 id="core-architectural-patterns">3. Core Architectural Patterns</h2>
<h3 id="basemodel-pattern">3.1 BaseModel Pattern</h3>
<p>Every database model inherits from a shared <code>BaseModel</code> that provides consistent audit fields:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">BaseModel</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __abstract__ <span class="token operator">=</span> <span class="token boolean">True</span>

    <span class="token builtin">id</span><span class="token punctuation">:</span> UUID <span class="token punctuation">(</span>primary key<span class="token punctuation">,</span> auto<span class="token operator">-</span>generated<span class="token punctuation">)</span>
    created_at<span class="token punctuation">:</span> datetime <span class="token punctuation">(</span>timezone<span class="token operator">-</span>aware<span class="token punctuation">)</span>
    updated_at<span class="token punctuation">:</span> datetime <span class="token punctuation">(</span>auto<span class="token operator">-</span>updated<span class="token punctuation">)</span>
    is_deleted<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token punctuation">(</span>soft deletes — NEVER hard delete clinical data<span class="token punctuation">)</span>
    deleted_at<span class="token punctuation">:</span> datetime
    created_by_id<span class="token punctuation">:</span> UUID
    updated_by_id<span class="token punctuation">:</span> UUID
    deleted_by_id<span class="token punctuation">:</span> UUID
</code></pre>
<p><strong>Why this matters for HMIS:</strong> Clinical records must NEVER be hard-deleted. The <code>is_deleted</code> flag plus <code>deleted_by_id</code> creates a compliant soft-delete audit trail required for medical-legal compliance.</p>
<h3 id="organization-→-entity-→-multi-tenancy">3.2 Organization → Entity → Multi-Tenancy</h3>
<pre><code>Organization (Hospital Group / Network)
    └── Entity (Individual Hospital / Clinic / Branch)
            └── All clinical data scoped to Entity
</code></pre>
<p>Every model carries <code>organization_id</code> and <code>entity_id</code> foreign keys, enabling full multi-tenancy. A hospital group with 5 branches = 1 Organization, 5 Entities. All queries are scoped to the authenticated entity, preventing cross-tenant data leakage.</p>
<h3 id="unified-transaction-model-financial-side">3.3 Unified Transaction Model (Financial Side)</h3>
<p>All billing events flow through a central <code>Transaction</code> model with healthcare-specific types, which drives automatic General Ledger (GL) entries:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">TransactionType</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> Enum<span class="token punctuation">)</span><span class="token punctuation">:</span>
    CONSULTATION_FEE <span class="token operator">=</span> <span class="token string">"consultation_fee"</span>
    PROCEDURE_CHARGE <span class="token operator">=</span> <span class="token string">"procedure_charge"</span>
    LAB_CHARGE <span class="token operator">=</span> <span class="token string">"lab_charge"</span>
    PHARMACY_SALE <span class="token operator">=</span> <span class="token string">"pharmacy_sale"</span>
    BED_CHARGE <span class="token operator">=</span> <span class="token string">"bed_charge"</span>
    INSURANCE_CLAIM <span class="token operator">=</span> <span class="token string">"insurance_claim"</span>
    INSURANCE_PAYMENT <span class="token operator">=</span> <span class="token string">"insurance_payment"</span>
    PATIENT_PAYMENT <span class="token operator">=</span> <span class="token string">"patient_payment"</span>
    PATIENT_REFUND <span class="token operator">=</span> <span class="token string">"patient_refund"</span>
</code></pre>
<p>Each <code>TransactionType</code> is mapped to a GL rule (<code>TransactionTypeGLRule</code>) that specifies which GL accounts to debit and credit, ensuring <strong>all hospital revenue automatically posts to the correct GL accounts</strong> without manual journal entries.</p>
<h3 id="controller-pattern-routes">3.4 Controller Pattern (Routes)</h3>
<p>All API routes are organized using Litestar’s <code>Controller</code> class pattern, grouping related endpoints with shared guards and path prefixes:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">PatientController</span><span class="token punctuation">(</span>Controller<span class="token punctuation">)</span><span class="token punctuation">:</span>
    path <span class="token operator">=</span> <span class="token string">"/api/patients"</span>
    tags <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"Patients"</span><span class="token punctuation">]</span>

    @post<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> guards<span class="token operator">=</span><span class="token punctuation">[</span>require_auth<span class="token punctuation">,</span> require_permission<span class="token punctuation">(</span><span class="token string">'patient'</span><span class="token punctuation">,</span> <span class="token string">'create'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_patient</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">:</span> CreatePatientRequest<span class="token punctuation">,</span> db<span class="token punctuation">:</span> AsyncSession<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> PatientResponse<span class="token punctuation">:</span>
        service <span class="token operator">=</span> PatientService<span class="token punctuation">(</span>db<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> service<span class="token punctuation">.</span>create_patient<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</code></pre>
<h3 id="service-layer-pattern">3.5 Service Layer Pattern</h3>
<p>All business logic lives in dedicated service classes, keeping controllers thin and business rules testable:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">PatientService</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> db<span class="token punctuation">:</span> AsyncSession<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>db <span class="token operator">=</span> db

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_patient</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">:</span> CreatePatientRequest<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> PatientResponse<span class="token punctuation">:</span>
        <span class="token comment"># Business logic here</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
<h3 id="rbac-permission-system">3.6 RBAC Permission System</h3>
<p>A <code>require_permission('resource', 'action')</code> guard pattern protects all routes. Permissions are granular per clinical domain:</p>
<pre class=" language-python"><code class="prism  language-python">require_permission<span class="token punctuation">(</span><span class="token string">'patient'</span><span class="token punctuation">,</span> <span class="token string">'read'</span><span class="token punctuation">)</span>        <span class="token comment"># View patient records</span>
require_permission<span class="token punctuation">(</span><span class="token string">'emr'</span><span class="token punctuation">,</span> <span class="token string">'write'</span><span class="token punctuation">)</span>           <span class="token comment"># Write clinical notes</span>
require_permission<span class="token punctuation">(</span><span class="token string">'prescription'</span><span class="token punctuation">,</span> <span class="token string">'create'</span><span class="token punctuation">)</span> <span class="token comment"># Issue prescriptions</span>
require_permission<span class="token punctuation">(</span><span class="token string">'billing'</span><span class="token punctuation">,</span> <span class="token string">'approve'</span><span class="token punctuation">)</span>     <span class="token comment"># Approve invoices</span>
require_permission<span class="token punctuation">(</span><span class="token string">'lab_result'</span><span class="token punctuation">,</span> <span class="token string">'release'</span><span class="token punctuation">)</span>  <span class="token comment"># Release lab results to patient</span>
</code></pre>
<h3 id="jsonb-for-flexible-clinical-data">3.7 JSONB for Flexible Clinical Data</h3>
<p>PostgreSQL’s JSONB column type is used for clinical data that varies by specialty or context, avoiding schema migrations for every new field while keeping data fully queryable:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># In clinical models:</span>
vital_signs<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">dict</span> <span class="token operator">|</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>JSONB<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment"># Structure: {"bp_systolic": 120, "bp_diastolic": 80, "temp": 36.5, "pulse": 72, "spo2": 98}</span>

lab_results<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">dict</span> <span class="token operator">|</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>JSONB<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment"># Structure: {"hb": 12.5, "wbc": 8.2, "plt": 250, "reference_ranges": {...}}</span>
</code></pre>
<h3 id="background-jobs-pattern">3.8 Background Jobs Pattern</h3>
<p>APScheduler handles all time-based automated tasks using a <code>cron</code>-style interface:</p>
<pre class=" language-python"><code class="prism  language-python">scheduler<span class="token punctuation">.</span>add_job<span class="token punctuation">(</span>generate_daily_bed_charges<span class="token punctuation">,</span> <span class="token string">'cron'</span><span class="token punctuation">,</span> hour<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> minute<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
scheduler<span class="token punctuation">.</span>add_job<span class="token punctuation">(</span>send_appointment_reminders<span class="token punctuation">,</span> <span class="token string">'cron'</span><span class="token punctuation">,</span> hour<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> minute<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
scheduler<span class="token punctuation">.</span>add_job<span class="token punctuation">(</span>check_drug_expiries<span class="token punctuation">,</span> <span class="token string">'cron'</span><span class="token punctuation">,</span> hour<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> minute<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
scheduler<span class="token punctuation">.</span>add_job<span class="token punctuation">(</span>submit_pending_insurance_claims<span class="token punctuation">,</span> <span class="token string">'cron'</span><span class="token punctuation">,</span> hour<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">,</span> minute<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="pinia-store-pattern-frontend">3.9 Pinia Store Pattern (Frontend)</h3>
<p>State management follows a composable Pinia store convention, keeping related state and actions co-located:</p>
<pre class=" language-typescript"><code class="prism  language-typescript"><span class="token keyword">export</span> <span class="token keyword">const</span> usePatientStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">'patient'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> currentPatient <span class="token operator">=</span> ref<span class="token operator">&lt;</span>Patient <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> patientQueue <span class="token operator">=</span> ref<span class="token operator">&lt;</span>Patient<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fetchPatient</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">registerPatient</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> CreatePatientRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span> currentPatient<span class="token punctuation">,</span> patientQueue<span class="token punctuation">,</span> fetchPatient<span class="token punctuation">,</span> registerPatient <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<hr>
<h2 id="system-architecture-deep-dive">4. System Architecture Deep Dive</h2>
<h3 id="the-clinical-encounter-as-central-entity">4.1 The Clinical Encounter as Central Entity</h3>
<pre><code>PATIENT
    │
    ├── ENCOUNTER (every visit/admission)
    │       │
    │       ├── TRIAGE (vital signs, chief complaint)
    │       │
    │       ├── CONSULTATION (doctor's notes, diagnosis)
    │       │       ├── ICD-10 Diagnosis codes
    │       │       ├── SOAP Notes
    │       │       └── Treatment plan
    │       │
    │       ├── ORDERS
    │       │       ├── LAB ORDERS → Lab Results → EMR
    │       │       ├── RADIOLOGY ORDERS → Reports → EMR
    │       │       └── PRESCRIPTION → Pharmacy → Dispensing
    │       │
    │       ├── PROCEDURES (performed treatments)
    │       │
    │       ├── NURSING NOTES (ward rounds, observations)
    │       │
    │       └── BILL
    │               ├── Consultation fee
    │               ├── Lab charges
    │               ├── Drug charges
    │               ├── Bed charges (IPD)
    │               └── Procedure charges
    │
    └── BILLING (linked to encounter)
            ├── Patient payment
            ├── Insurance claim
            └── GL posting (via Transaction model)
</code></pre>
<h3 id="data-flow-opd-patient-visit">4.2 Data Flow: OPD Patient Visit</h3>
<pre><code>1. REGISTRATION
   Front Desk creates/finds Patient record
   Creates Encounter (type=OPD, status=registered)
   Assigns queue number

2. TRIAGE
   Nurse records vital signs on Encounter
   Assigns triage priority (emergency, urgent, routine)
   Encounter status → triaged

3. CONSULTATION
   Doctor opens Encounter
   Views medical history, current vitals
   Records SOAP notes, ICD-10 diagnosis
   Creates:
     - Prescription (→ Pharmacy queue)
     - Lab orders (→ Lab queue)
   Encounter status → consultation_done

4. PHARMACY
   Pharmacist sees prescription in queue
   Verifies stock availability
   Dispenses drugs → StockMovement created
   → Transaction(type=pharmacy_sale) created
   → BillLineItem added to Encounter bill

5. LAB
   Lab tech sees test order in queue
   Records specimen collection
   Enters results
   Results auto-linked to Encounter → EMR
   → Transaction(type=lab_charge) created

6. BILLING
   Cashier sees Encounter with all charges
   Calculates total (consultation + drugs + labs)
   Patient pays (cash/card/NHIF/insurance)
   → Transaction(type=patient_payment) created
   → GL posting automatic
   Encounter status → completed, paid
</code></pre>
<h3 id="data-flow-ipd-admission">4.3 Data Flow: IPD Admission</h3>
<pre><code>1. ADMISSION
   Doctor/Front Desk creates Admission
   Bed allocated from Bed Management
   Admission linked to Encounter (type=IPD)

2. WARD NURSING
   Nurse administers medications → MedicationAdministration records
   Records vital signs every shift
   Writes nursing progress notes
   → Each drug admin → Transaction + StockMovement

3. DAILY BED CHARGES
   Background job runs at midnight
   For each active admission: create Transaction(type=bed_charge)
   → Automatic GL posting

4. WARD ROUNDS
   Doctor reviews patient
   Updates treatment plan, prescriptions, orders

5. DISCHARGE
   Doctor writes discharge summary
   Discharge instructions, follow-up date
   Pharmacy provides discharge drugs
   Final bill generated:
     - All bed charges (daily accumulation)
     - All drugs dispensed
     - All procedures performed
     - All lab tests done

6. BILLING &amp; DISCHARGE
   Insurance claim submitted (if insured)
   Patient settles balance
   Encounter closed
</code></pre>
<hr>
<h2 id="database-design--models">5. Database Design &amp; Models</h2>
<h3 id="model-overview">5.1 Model Overview</h3>
<pre><code>PATIENT MANAGEMENT
├── patients                    (core patient demographics)
├── patient_identifiers         (ID types: national ID, NHIF, passport)
├── patient_contacts            (emergency contacts, next of kin)
├── patient_insurance           (insurance coverage details)
├── patient_allergies           (drug allergies, food allergies)
└── patient_medical_history     (past diagnoses, surgeries, conditions)

APPOINTMENTS &amp; SCHEDULING
├── departments                 (hospital departments: OPD, Pediatrics, Surgery)
├── doctor_schedules            (doctor availability by day/time)
├── appointment_slots           (available slots per doctor per day)
├── appointments                (booked patient-doctor appointments)
└── opd_queues                  (walk-in + appointment queue management)

CLINICAL ENCOUNTERS (EMR Core)
├── encounters                  (every patient visit - OPD or IPD)
├── triage_records              (vital signs + triage priority)
├── consultations               (SOAP notes, diagnoses, treatment plans)
├── encounter_diagnoses         (ICD-10 codes linked to encounter)
├── prescriptions               (prescription headers)
├── prescription_items          (individual drug lines in prescription)
├── clinical_orders             (lab, radiology, procedure orders)
├── clinical_notes              (nursing notes, progress notes, summaries)
└── encounter_attachments       (scans, images, documents)

LABORATORY (LIS)
├── lab_test_catalog            (all available tests with reference ranges)
├── lab_test_panels             (grouped tests e.g. Full Blood Count)
├── lab_orders                  (test requests from doctors)
├── lab_order_items             (individual tests within an order)
├── lab_specimens               (specimen collection tracking)
├── lab_results                 (test results per item)
└── lab_result_flags            (abnormal/critical value tracking)

RADIOLOGY
├── radiology_modalities        (X-Ray, CT, MRI, Ultrasound)
├── radiology_orders            (imaging requests)
├── radiology_studies           (performed imaging sessions)
└── radiology_reports           (radiologist findings)

PHARMACY MANAGEMENT
├── drug_catalog                (drug master: generic name, brand, dosage)
├── drug_interactions           (known dangerous drug pairs)
├── pharmacy_batches            (per-batch tracking: batch number, expiry, quantity)
├── pharmacy_dispensing         (fulfillment of prescriptions)
├── dispensing_items            (individual drugs dispensed, linked to batch)
└── pharmacy_stock              (current stock level per drug per entity)

DENTAL
├── dental_procedures           (procedure catalog with codes and default fees)
├── dental_encounter_procedures (procedures performed per encounter/tooth)
└── dental_charts               (per-tooth condition tracking)

PHYSIOTHERAPY
├── physio_care_plans           (diagnosis, goals, treatment plan, session count)
└── physio_sessions             (individual session records with notes and outcomes)

ACCOUNTING
├── expenses                    (expense records by category and payment method)
├── accounting_periods          (period open/close/lock control)
└── pl_snapshots                (cached P&amp;L summaries for reporting speed)

WARD &amp; IPD MANAGEMENT
├── wards                       (hospital wards: medical, surgical, maternity)
├── bed_types                   (categories: general, private, ICU, HDU)
├── beds                        (individual beds with ward+room location)
├── admissions                  (IPD patient admissions)
├── bed_allocations             (bed assignment history)
├── nursing_assessments         (systematic nursing evaluations)
├── medication_administrations  (medication given records - MAR)
└── ward_vitals                 (periodic vital signs during admission)

BILLING &amp; INSURANCE
├── service_catalog             (hospital service price list)
├── encounter_bills             (bill summary for each encounter)
├── bill_line_items             (itemized charges: consultation, drugs, labs)
├── insurance_schemes           (insurance providers: NHIF, private)
├── insurance_pre_auth          (pre-authorization requests)
├── insurance_claims            (submitted claims)
└── insurance_claim_items       (line items in each claim)

GLOBAL REFERENCE DATA (shared, no org/entity scope — seeded once from public datasets)
├── counties                    (Kenya's 47 counties — code + DHIS2 org unit ID)
├── sub_counties                (sub-counties within each county)
├── administrative_wards        (administrative wards within each sub-county)
├── icd10_codes                 (WHO ICD-10 complete disease classification ~14,400 codes)
├── drug_master                 (WHO / Kenya Essential Medicines — INN names, ATC codes)
├── lab_test_master             (standard lab tests with LOINC codes + reference ranges)
└── lab_test_materials          (reagents and consumables required per lab test)

REPORTING &amp; COMPLIANCE
├── moh_reports                 (MOH-705A/B, MOH-717 report data)
├── disease_notifications       (notifiable disease reports)
└── hmis_indicators             (DHIS2-compatible indicator data)
</code></pre>
<hr>
<h3 id="core-model-definitions">5.2 Core Model Definitions</h3>
<h4 id="patient">Patient</h4>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">Patient</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Core patient demographic record.

    Single source of truth for patient identity.
    All clinical encounters, bills, and records link back here.
    """</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"patients"</span>
    __table_args__ <span class="token operator">=</span> <span class="token punctuation">(</span>
        UniqueConstraint<span class="token punctuation">(</span><span class="token string">"organization_id"</span><span class="token punctuation">,</span> <span class="token string">"patient_number"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"uq_patient_number"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Index<span class="token punctuation">(</span><span class="token string">"idx_patient_name"</span><span class="token punctuation">,</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span> <span class="token string">"last_name"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Index<span class="token punctuation">(</span><span class="token string">"idx_patient_dob"</span><span class="token punctuation">,</span> <span class="token string">"date_of_birth"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Index<span class="token punctuation">(</span><span class="token string">"idx_patient_phone"</span><span class="token punctuation">,</span> <span class="token string">"phone_number"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    organization_id<span class="token punctuation">:</span> UUID  <span class="token comment"># Hospital group</span>
    entity_id<span class="token punctuation">:</span> UUID        <span class="token comment"># Specific facility (branch)</span>

    <span class="token comment"># Identification</span>
    patient_number<span class="token punctuation">:</span> <span class="token builtin">str</span>    <span class="token comment"># Auto-generated: "P-2026-00001"</span>

    <span class="token comment"># Demographics</span>
    first_name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    middle_name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    last_name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    date_of_birth<span class="token punctuation">:</span> date
    gender<span class="token punctuation">:</span> <span class="token builtin">str</span>            <span class="token comment"># male, female, other</span>
    blood_group<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># A+, A-, B+, B-, AB+, AB-, O+, O-</span>
    marital_status<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># Contact</span>
    phone_number<span class="token punctuation">:</span> <span class="token builtin">str</span>
    alternate_phone<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    email<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    address<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># Administrative region (FK to shared region tables)</span>
    county_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>         <span class="token comment"># → counties.id</span>
    sub_county_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>     <span class="token comment"># → sub_counties.id</span>
    administrative_ward_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># → administrative_wards.id</span>
    <span class="token comment"># Note: village/estate/street is free-text on address field above</span>

    <span class="token comment"># Occupation &amp; Education</span>
    occupation<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    nationality<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># default: "Kenyan"</span>

    <span class="token comment"># Registration</span>
    registration_date<span class="token punctuation">:</span> date
    registration_type<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># opd, ipd, emergency</span>

    <span class="token comment"># Status</span>
    is_active<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>
    is_deceased<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span>
    deceased_date<span class="token punctuation">:</span> date <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># JSONB for flexible extra data</span>
    extra_data<span class="token punctuation">:</span> <span class="token builtin">dict</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># custom fields per facility</span>
</code></pre>
<h4 id="encounter">Encounter</h4>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">Encounter</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""A single patient visit or admission.

    Central model that ties together all clinical activities
    for one continuous episode of care.

    OPD: Patient comes in, sees doctor, gets drugs, goes home.
    IPD: Patient admitted, stays in ward, discharged.
    Emergency: Fast-tracked encounter.
    """</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"encounters"</span>
    __table_args__ <span class="token operator">=</span> <span class="token punctuation">(</span>
        UniqueConstraint<span class="token punctuation">(</span><span class="token string">"entity_id"</span><span class="token punctuation">,</span> <span class="token string">"encounter_number"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"uq_encounter_number"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Index<span class="token punctuation">(</span><span class="token string">"idx_encounter_patient"</span><span class="token punctuation">,</span> <span class="token string">"patient_id"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Index<span class="token punctuation">(</span><span class="token string">"idx_encounter_date"</span><span class="token punctuation">,</span> <span class="token string">"encounter_date"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Index<span class="token punctuation">(</span><span class="token string">"idx_encounter_status"</span><span class="token punctuation">,</span> <span class="token string">"status"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Index<span class="token punctuation">(</span><span class="token string">"idx_encounter_doctor"</span><span class="token punctuation">,</span> <span class="token string">"attending_doctor_id"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    organization_id<span class="token punctuation">:</span> UUID
    entity_id<span class="token punctuation">:</span> UUID
    patient_id<span class="token punctuation">:</span> UUID       <span class="token comment"># → patients.id</span>

    <span class="token comment"># Identification</span>
    encounter_number<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># "ENC-2026-00001"</span>
    encounter_date<span class="token punctuation">:</span> date
    encounter_type<span class="token punctuation">:</span> <span class="token builtin">str</span>    <span class="token comment"># opd, ipd, emergency, day_case, telemedicine</span>

    <span class="token comment"># Status workflow</span>
    <span class="token comment"># registered → triaged → in_consultation → consultation_done</span>
    <span class="token comment"># → pending_results → results_ready → billing → completed</span>
    status<span class="token punctuation">:</span> <span class="token builtin">str</span>

    <span class="token comment"># Department and clinical team</span>
    department_id<span class="token punctuation">:</span> UUID    <span class="token comment"># → departments.id</span>
    attending_doctor_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>
    referred_by_doctor_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>
    referring_facility<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># Visit classification</span>
    visit_type<span class="token punctuation">:</span> <span class="token builtin">str</span>        <span class="token comment"># new_patient, follow_up, referral, emergency</span>
    priority<span class="token punctuation">:</span> <span class="token builtin">str</span>          <span class="token comment"># routine, urgent, emergency</span>

    <span class="token comment"># Financial</span>
    bill_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>   <span class="token comment"># → encounter_bills.id</span>
    payment_status<span class="token punctuation">:</span> <span class="token builtin">str</span>    <span class="token comment"># pending, partial, paid, insurance_pending, waived</span>

    <span class="token comment"># Queue</span>
    queue_number<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    queue_priority<span class="token punctuation">:</span> <span class="token builtin">int</span>    <span class="token comment"># 1=highest, 5=lowest</span>

    <span class="token comment"># Timestamps</span>
    check_in_time<span class="token punctuation">:</span> datetime
    triage_time<span class="token punctuation">:</span> datetime <span class="token operator">|</span> <span class="token boolean">None</span>
    consultation_start<span class="token punctuation">:</span> datetime <span class="token operator">|</span> <span class="token boolean">None</span>
    consultation_end<span class="token punctuation">:</span> datetime <span class="token operator">|</span> <span class="token boolean">None</span>
    check_out_time<span class="token punctuation">:</span> datetime <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># Discharge (IPD)</span>
    discharge_summary<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    discharge_date<span class="token punctuation">:</span> date <span class="token operator">|</span> <span class="token boolean">None</span>
    discharge_condition<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># improved, cured, transferred, absconded, died</span>

    extra_data<span class="token punctuation">:</span> <span class="token builtin">dict</span> <span class="token operator">|</span> <span class="token boolean">None</span>
</code></pre>
<h4 id="consultation-emr">Consultation (EMR)</h4>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">Consultation</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Doctor's clinical assessment for an encounter.

    SOAP format: Subjective, Objective, Assessment, Plan.
    Immutable once finalized (medical-legal requirement).
    """</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"consultations"</span>

    encounter_id<span class="token punctuation">:</span> UUID     <span class="token comment"># → encounters.id</span>
    doctor_id<span class="token punctuation">:</span> UUID        <span class="token comment"># → users.id (must have doctor role)</span>

    <span class="token comment"># SOAP Notes</span>
    chief_complaint<span class="token punctuation">:</span> <span class="token builtin">str</span>
    history_of_presenting_illness<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># HPI</span>

    <span class="token comment"># Review of Systems (JSONB - flexible, varies by specialty)</span>
    review_of_systems<span class="token punctuation">:</span> <span class="token builtin">dict</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    <span class="token comment"># e.g., {"respiratory": "No cough", "cardiovascular": "No chest pain"}</span>

    <span class="token comment"># Examination findings</span>
    general_examination<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    systemic_examination<span class="token punctuation">:</span> <span class="token builtin">dict</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># JSONB per system</span>

    <span class="token comment"># Assessment</span>
    provisional_diagnosis<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># Free text before ICD-10</span>
    final_diagnosis<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>        <span class="token comment"># After tests</span>

    <span class="token comment"># Plan</span>
    management_plan<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    follow_up_date<span class="token punctuation">:</span> date <span class="token operator">|</span> <span class="token boolean">None</span>
    follow_up_instructions<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># Referral</span>
    is_referred<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span>
    referral_to<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    referral_reason<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># Status</span>
    status<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># draft, finalized, amended</span>
    finalized_at<span class="token punctuation">:</span> datetime <span class="token operator">|</span> <span class="token boolean">None</span>
    finalized_by_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># Amendment tracking (important for medical-legal)</span>
    is_amendment<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span>
    amends_consultation_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># links to original</span>
    amendment_reason<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
</code></pre>
<h4 id="encounterdiagnosis">EncounterDiagnosis</h4>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">EncounterDiagnosis</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""ICD-10 coded diagnosis linked to an encounter.

    Multiple diagnoses per encounter (primary, secondary, comorbidities).
    """</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"encounter_diagnoses"</span>

    encounter_id<span class="token punctuation">:</span> UUID
    consultation_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># ICD-10 Classification</span>
    icd10_code<span class="token punctuation">:</span> <span class="token builtin">str</span>        <span class="token comment"># "J06.9" - Acute upper respiratory infection</span>
    icd10_description<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token comment"># "Acute upper respiratory infection, unspecified"</span>
    diagnosis_type<span class="token punctuation">:</span> <span class="token builtin">str</span>    <span class="token comment"># primary, secondary, comorbidity, complication</span>

    <span class="token comment"># Clinical context</span>
    diagnosis_status<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># confirmed, provisional, differential, ruled_out</span>
    onset_date<span class="token punctuation">:</span> date <span class="token operator">|</span> <span class="token boolean">None</span>
    is_chronic<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token comment"># Ordering</span>
    display_order<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span>
</code></pre>
<h4 id="prescription--prescriptionitem">Prescription &amp; PrescriptionItem</h4>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">Prescription</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Prescription header issued during a consultation."""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"prescriptions"</span>
    __table_args__ <span class="token operator">=</span> <span class="token punctuation">(</span>
        UniqueConstraint<span class="token punctuation">(</span><span class="token string">"entity_id"</span><span class="token punctuation">,</span> <span class="token string">"prescription_number"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"uq_prescription_number"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    encounter_id<span class="token punctuation">:</span> UUID
    patient_id<span class="token punctuation">:</span> UUID
    prescriber_id<span class="token punctuation">:</span> UUID    <span class="token comment"># → users.id (doctor)</span>
    entity_id<span class="token punctuation">:</span> UUID

    prescription_number<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># "RX-2026-00001"</span>
    prescribed_date<span class="token punctuation">:</span> date

    status<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># draft, issued, partially_dispensed, fully_dispensed, cancelled, expired</span>

    valid_until<span class="token punctuation">:</span> date <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># Prescription expiry</span>
    notes<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>         <span class="token comment"># Additional instructions for pharmacist</span>


<span class="token keyword">class</span> <span class="token class-name">PrescriptionItem</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Individual drug line in a prescription."""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"prescription_items"</span>

    prescription_id<span class="token punctuation">:</span> UUID
    drug_id<span class="token punctuation">:</span> UUID          <span class="token comment"># → drug_catalog.id</span>

    <span class="token comment"># Prescribed drug details</span>
    generic_name<span class="token punctuation">:</span> <span class="token builtin">str</span>      <span class="token comment"># Stored at time of prescription (immutable)</span>
    brand_name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    strength<span class="token punctuation">:</span> <span class="token builtin">str</span>          <span class="token comment"># "500mg", "250mg/5ml"</span>
    dosage_form<span class="token punctuation">:</span> <span class="token builtin">str</span>       <span class="token comment"># tablet, capsule, syrup, injection, cream</span>

    <span class="token comment"># Dosage instructions</span>
    dose<span class="token punctuation">:</span> <span class="token builtin">str</span>              <span class="token comment"># "2 tablets", "5ml", "1 injection"</span>
    frequency<span class="token punctuation">:</span> <span class="token builtin">str</span>         <span class="token comment"># "twice daily", "three times daily", "stat"</span>
    duration_days<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    route<span class="token punctuation">:</span> <span class="token builtin">str</span>             <span class="token comment"># oral, iv, im, topical, inhaled, sublingual</span>

    quantity_prescribed<span class="token punctuation">:</span> Decimal
    unit<span class="token punctuation">:</span> <span class="token builtin">str</span>              <span class="token comment"># tablets, ml, vials</span>

    <span class="token comment"># Special instructions</span>
    instructions<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># "Take after meals", "Avoid sunlight"</span>

    <span class="token comment"># Dispensing tracking</span>
    quantity_dispensed<span class="token punctuation">:</span> Decimal <span class="token operator">=</span> Decimal<span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span>
    status<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># pending, partially_dispensed, fully_dispensed, cancelled</span>

    <span class="token comment"># Allergy check</span>
    allergy_check_done<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span>
    interaction_check_done<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span>
</code></pre>
<h4 id="laborder--labresult">LabOrder &amp; LabResult</h4>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">LabOrder</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Lab test request made during consultation."""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"lab_orders"</span>
    __table_args__ <span class="token operator">=</span> <span class="token punctuation">(</span>
        UniqueConstraint<span class="token punctuation">(</span><span class="token string">"entity_id"</span><span class="token punctuation">,</span> <span class="token string">"order_number"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"uq_lab_order_number"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    encounter_id<span class="token punctuation">:</span> UUID
    patient_id<span class="token punctuation">:</span> UUID
    requesting_doctor_id<span class="token punctuation">:</span> UUID
    entity_id<span class="token punctuation">:</span> UUID

    order_number<span class="token punctuation">:</span> <span class="token builtin">str</span>      <span class="token comment"># "LO-2026-00001"</span>
    ordered_date<span class="token punctuation">:</span> date
    priority<span class="token punctuation">:</span> <span class="token builtin">str</span>          <span class="token comment"># routine, urgent, stat</span>

    status<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># pending → specimen_collected → processing → resulted → released → billed</span>

    clinical_info<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># Context for lab: "Patient on anticoagulants"</span>
    special_instructions<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>


<span class="token keyword">class</span> <span class="token class-name">LabOrderItem</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Individual test within a lab order."""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"lab_order_items"</span>

    lab_order_id<span class="token punctuation">:</span> UUID
    test_id<span class="token punctuation">:</span> UUID          <span class="token comment"># → lab_test_catalog.id</span>
    panel_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># → lab_test_panels.id</span>

    <span class="token comment"># Test details (stored at time of order)</span>
    test_code<span class="token punctuation">:</span> <span class="token builtin">str</span>
    test_name<span class="token punctuation">:</span> <span class="token builtin">str</span>

    status<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># pending, in_progress, resulted, verified, released, cancelled</span>

    <span class="token comment"># Specimen</span>
    specimen_type<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>     <span class="token comment"># blood, urine, stool, swab, CSF</span>
    specimen_collected_at<span class="token punctuation">:</span> datetime <span class="token operator">|</span> <span class="token boolean">None</span>
    specimen_collected_by_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>
    specimen_id<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>       <span class="token comment"># Barcode/tube label</span>


<span class="token keyword">class</span> <span class="token class-name">LabResult</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Test result for a lab order item."""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"lab_results"</span>

    lab_order_item_id<span class="token punctuation">:</span> UUID
    test_id<span class="token punctuation">:</span> UUID
    patient_id<span class="token punctuation">:</span> UUID

    <span class="token comment"># Result data</span>
    result_value<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>       <span class="token comment"># Numeric or text result</span>
    result_numeric<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token comment"># For numeric results (easy querying)</span>
    result_unit<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>        <span class="token comment"># mg/dL, g/L, IU/L</span>

    <span class="token comment"># Reference ranges</span>
    reference_range_low<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span>
    reference_range_high<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span>
    reference_range_text<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>   <span class="token comment"># "Negative / Positive"</span>

    <span class="token comment"># Flags</span>
    is_abnormal<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span>
    is_critical<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span>         <span class="token comment"># Requires immediate doctor notification</span>
    flag<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>                  <span class="token comment"># H (high), L (low), HH (critically high), LL (critically low)</span>

    <span class="token comment"># Results structured data (JSONB for complex results like CBC)</span>
    structured_results<span class="token punctuation">:</span> <span class="token builtin">dict</span> <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># Quality control</span>
    entered_by_id<span class="token punctuation">:</span> UUID
    verified_by_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>
    entered_at<span class="token punctuation">:</span> datetime
    verified_at<span class="token punctuation">:</span> datetime <span class="token operator">|</span> <span class="token boolean">None</span>
    released_at<span class="token punctuation">:</span> datetime <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># Comments</span>
    comments<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>             <span class="token comment"># Lab tech interpretive comments</span>
    validated<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span>
</code></pre>
<h4 id="bed--admission-ipd">Bed &amp; Admission (IPD)</h4>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">Ward</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Hospital ward definition."""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"wards"</span>

    entity_id<span class="token punctuation">:</span> UUID
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>              <span class="token comment"># "Medical Ward", "Paediatric Ward", "ICU"</span>
    code<span class="token punctuation">:</span> <span class="token builtin">str</span>              <span class="token comment"># "MW01"</span>
    ward_type<span class="token punctuation">:</span> <span class="token builtin">str</span>         <span class="token comment"># general, icu, hdu, maternity, paediatric, psychiatric, isolation</span>
    department_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>
    floor<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    total_beds<span class="token punctuation">:</span> <span class="token builtin">int</span>
    is_active<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>


<span class="token keyword">class</span> <span class="token class-name">Bed</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Individual hospital bed."""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"beds"</span>
    __table_args__ <span class="token operator">=</span> <span class="token punctuation">(</span>
        UniqueConstraint<span class="token punctuation">(</span><span class="token string">"entity_id"</span><span class="token punctuation">,</span> <span class="token string">"bed_number"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"uq_bed_number"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    entity_id<span class="token punctuation">:</span> UUID
    ward_id<span class="token punctuation">:</span> UUID          <span class="token comment"># → wards.id</span>

    bed_number<span class="token punctuation">:</span> <span class="token builtin">str</span>        <span class="token comment"># "ICU-01", "MW-15"</span>
    room_number<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    bed_type<span class="token punctuation">:</span> <span class="token builtin">str</span>          <span class="token comment"># general, private, semi_private, icu, nursery</span>

    status<span class="token punctuation">:</span> <span class="token builtin">str</span>   <span class="token comment"># available, occupied, reserved, maintenance, cleaning</span>

    <span class="token comment"># Pricing (links to service_catalog for billing)</span>
    daily_rate<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span>
    is_active<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>


<span class="token keyword">class</span> <span class="token class-name">Admission</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""IPD patient admission record."""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"admissions"</span>
    __table_args__ <span class="token operator">=</span> <span class="token punctuation">(</span>
        UniqueConstraint<span class="token punctuation">(</span><span class="token string">"entity_id"</span><span class="token punctuation">,</span> <span class="token string">"admission_number"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"uq_admission_number"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    encounter_id<span class="token punctuation">:</span> UUID
    patient_id<span class="token punctuation">:</span> UUID
    entity_id<span class="token punctuation">:</span> UUID

    admission_number<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># "ADM-2026-00001"</span>
    admission_date<span class="token punctuation">:</span> date
    admission_time<span class="token punctuation">:</span> datetime
    admission_type<span class="token punctuation">:</span> <span class="token builtin">str</span>    <span class="token comment"># elective, emergency, transfer</span>

    <span class="token comment"># Clinical</span>
    admitting_doctor_id<span class="token punctuation">:</span> UUID
    admitting_diagnosis<span class="token punctuation">:</span> <span class="token builtin">str</span>
    admitting_ward_id<span class="token punctuation">:</span> UUID

    <span class="token comment"># Current status</span>
    current_bed_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>
    current_ward_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>

    status<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># admitted, transferred, discharged, absconded, died</span>

    expected_discharge_date<span class="token punctuation">:</span> date <span class="token operator">|</span> <span class="token boolean">None</span>
    actual_discharge_date<span class="token punctuation">:</span> date <span class="token operator">|</span> <span class="token boolean">None</span>
    discharge_time<span class="token punctuation">:</span> datetime <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># Discharge details</span>
    discharge_doctor_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>
    discharge_diagnosis<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    discharge_condition<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># improved, cured, referred, died, absconded</span>
    discharge_summary<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># Insurance</span>
    insurance_scheme_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>
    pre_auth_number<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    pre_auth_approved_amount<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span>
</code></pre>
<h4 id="encounterbill--billlineitem">EncounterBill &amp; BillLineItem</h4>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">EncounterBill</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Billing summary for a clinical encounter.

    Aggregates all charges: consultation, drugs, labs, bed, procedures.
    Payments post to the GL via the Transaction model.
    """</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"encounter_bills"</span>
    __table_args__ <span class="token operator">=</span> <span class="token punctuation">(</span>
        UniqueConstraint<span class="token punctuation">(</span><span class="token string">"entity_id"</span><span class="token punctuation">,</span> <span class="token string">"bill_number"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"uq_bill_number"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    encounter_id<span class="token punctuation">:</span> UUID
    patient_id<span class="token punctuation">:</span> UUID
    entity_id<span class="token punctuation">:</span> UUID

    bill_number<span class="token punctuation">:</span> <span class="token builtin">str</span>       <span class="token comment"># "BILL-2026-00001"</span>
    bill_date<span class="token punctuation">:</span> date

    <span class="token comment"># Amounts</span>
    subtotal<span class="token punctuation">:</span> Decimal <span class="token operator">=</span> Decimal<span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span>
    discount_amount<span class="token punctuation">:</span> Decimal <span class="token operator">=</span> Decimal<span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span>
    tax_amount<span class="token punctuation">:</span> Decimal <span class="token operator">=</span> Decimal<span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span>
    total_amount<span class="token punctuation">:</span> Decimal <span class="token operator">=</span> Decimal<span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span>

    insurance_amount<span class="token punctuation">:</span> Decimal <span class="token operator">=</span> Decimal<span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span>  <span class="token comment"># Portion covered by insurance</span>
    patient_amount<span class="token punctuation">:</span> Decimal <span class="token operator">=</span> Decimal<span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span>    <span class="token comment"># Patient's share</span>

    amount_paid<span class="token punctuation">:</span> Decimal <span class="token operator">=</span> Decimal<span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span>
    outstanding_amount<span class="token punctuation">:</span> Decimal <span class="token operator">=</span> Decimal<span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span>

    <span class="token comment"># Status</span>
    status<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># draft, issued, partially_paid, paid, insurance_pending, waived, cancelled</span>
    payment_status<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># pending, partial, paid, waived</span>

    <span class="token comment"># Insurance</span>
    insurance_scheme_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>
    insurance_claim_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># GL transaction link</span>
    transaction_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># → transactions.id</span>

    notes<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>


<span class="token keyword">class</span> <span class="token class-name">BillLineItem</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Individual charge line in a hospital bill."""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"bill_line_items"</span>

    bill_id<span class="token punctuation">:</span> UUID              <span class="token comment"># → encounter_bills.id</span>
    entity_id<span class="token punctuation">:</span> UUID

    <span class="token comment"># What is being charged</span>
    charge_type<span class="token punctuation">:</span> <span class="token builtin">str</span>           <span class="token comment"># consultation, lab, pharmacy, procedure, bed, radiology, misc</span>
    service_catalog_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># → service_catalog.id</span>
    description<span class="token punctuation">:</span> <span class="token builtin">str</span>           <span class="token comment"># "Consultation - General OPD"</span>

    <span class="token comment"># Quantity and pricing</span>
    quantity<span class="token punctuation">:</span> Decimal <span class="token operator">=</span> Decimal<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>
    unit_price<span class="token punctuation">:</span> Decimal
    discount_percent<span class="token punctuation">:</span> Decimal <span class="token operator">=</span> Decimal<span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span>
    tax_rate<span class="token punctuation">:</span> Decimal <span class="token operator">=</span> Decimal<span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span>   <span class="token comment"># 0 (healthcare often zero-rated)</span>
    line_total<span class="token punctuation">:</span> Decimal

    <span class="token comment"># Source references (for audit trail)</span>
    lab_order_item_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>
    prescription_item_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>
    consultation_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>
    bed_allocation_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># Insurance</span>
    is_insurance_covered<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span>
    insurance_approved_amount<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span>
    patient_portion<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># GL info</span>
    revenue_account_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>    <span class="token comment"># → gl_accounts.id</span>
</code></pre>
<h4 id="insuranceclaim-nhif--private">InsuranceClaim (NHIF + Private)</h4>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">InsuranceScheme</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Insurance provider configuration."""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"insurance_schemes"</span>

    entity_id<span class="token punctuation">:</span> UUID
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>              <span class="token comment"># "NHIF", "AAR Healthcare", "Jubilee Insurance"</span>
    code<span class="token punctuation">:</span> <span class="token builtin">str</span>              <span class="token comment"># "NHIF", "AAR", "JUB"</span>
    scheme_type<span class="token punctuation">:</span> <span class="token builtin">str</span>       <span class="token comment"># nhif, private, employer, government</span>

    <span class="token comment"># Claim submission settings</span>
    api_endpoint<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    api_credentials<span class="token punctuation">:</span> <span class="token builtin">dict</span> <span class="token operator">|</span> <span class="token boolean">None</span>   <span class="token comment"># JSONB - encrypted</span>
    claim_format<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>       <span class="token comment"># nhif_v2, fhir_r4, custom</span>

    <span class="token comment"># Default coverage settings</span>
    inpatient_limit<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span>
    outpatient_limit<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># Rates</span>
    gp_consultation_rate<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span>
    specialist_consultation_rate<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span>

    is_active<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>


<span class="token keyword">class</span> <span class="token class-name">InsuranceClaim</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Insurance claim for a patient encounter."""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"insurance_claims"</span>
    __table_args__ <span class="token operator">=</span> <span class="token punctuation">(</span>
        UniqueConstraint<span class="token punctuation">(</span><span class="token string">"entity_id"</span><span class="token punctuation">,</span> <span class="token string">"claim_number"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"uq_claim_number"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    bill_id<span class="token punctuation">:</span> UUID
    patient_id<span class="token punctuation">:</span> UUID
    insurance_scheme_id<span class="token punctuation">:</span> UUID
    entity_id<span class="token punctuation">:</span> UUID

    claim_number<span class="token punctuation">:</span> <span class="token builtin">str</span>          <span class="token comment"># "CLM-2026-00001"</span>
    claim_date<span class="token punctuation">:</span> date

    <span class="token comment"># Patient's insurance details</span>
    member_number<span class="token punctuation">:</span> <span class="token builtin">str</span>         <span class="token comment"># NHIF number or insurance member ID</span>
    beneficiary_name<span class="token punctuation">:</span> <span class="token builtin">str</span>

    <span class="token comment"># Amounts</span>
    claimed_amount<span class="token punctuation">:</span> Decimal
    approved_amount<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span>
    rejected_amount<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span>
    paid_amount<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># Submission</span>
    submission_date<span class="token punctuation">:</span> date <span class="token operator">|</span> <span class="token boolean">None</span>
    submission_reference<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    submission_method<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># api, manual, portal</span>

    <span class="token comment"># Response</span>
    status<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># draft, submitted, processing, approved, partially_approved,</span>
                 <span class="token comment"># rejected, paid, appealing</span>

    response_date<span class="token punctuation">:</span> date <span class="token operator">|</span> <span class="token boolean">None</span>
    rejection_reason<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># GL posting transaction (recorded when claim is paid)</span>
    payment_transaction_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># → transactions.id</span>
</code></pre>
<h4 id="triagerecord-with-bmi-auto-calc--abnormal-flagging">TriageRecord (with BMI auto-calc &amp; abnormal flagging)</h4>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">TriageRecord</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Triage assessment — vitals, priority, and abnormal flag detection."""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"triage_records"</span>

    encounter_id<span class="token punctuation">:</span> UUID
    patient_id<span class="token punctuation">:</span> UUID
    entity_id<span class="token punctuation">:</span> UUID
    triaged_by_id<span class="token punctuation">:</span> UUID      <span class="token comment"># → users.id (nurse/triage staff)</span>

    <span class="token comment"># Vitals</span>
    bp_systolic<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span>          <span class="token comment"># mmHg</span>
    bp_diastolic<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span>         <span class="token comment"># mmHg</span>
    heart_rate<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span>           <span class="token comment"># bpm</span>
    temperature<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span>      <span class="token comment"># Celsius</span>
    spo2<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span>                 <span class="token comment"># % oxygen saturation</span>
    respiratory_rate<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span>     <span class="token comment"># breaths/min</span>

    <span class="token comment"># Weight/Height → BMI</span>
    weight_kg<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span>
    height_cm<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span>
    bmi<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span>              <span class="token comment"># Auto-calculated: weight / (height_m)²</span>
                                     <span class="token comment"># Stored value; recalculated on save if w/h provided</span>

    <span class="token comment"># Chief complaint and priority</span>
    chief_complaint<span class="token punctuation">:</span> <span class="token builtin">str</span>
    priority<span class="token punctuation">:</span> <span class="token builtin">str</span>                    <span class="token comment"># emergency, urgent, routine</span>
    department_id<span class="token punctuation">:</span> UUID              <span class="token comment"># Where patient is queued</span>

    <span class="token comment"># Abnormal vital flags (auto-set at service layer based on thresholds)</span>
    has_abnormal_vitals<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span>
    abnormal_flags<span class="token punctuation">:</span> <span class="token builtin">dict</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    <span class="token comment"># Structure: {</span>
    <span class="token comment">#   "high_bp": True,            # systolic &gt; 140 or diastolic &gt; 90</span>
    <span class="token comment">#   "low_spo2": True,           # spo2 &lt; 94</span>
    <span class="token comment">#   "high_temp": True,          # temp &gt; 37.5°C</span>
    <span class="token comment">#   "bradycardia": True,        # heart_rate &lt; 60</span>
    <span class="token comment">#   "tachycardia": True,        # heart_rate &gt; 100</span>
    <span class="token comment">#   "high_bmi": True,           # bmi &gt; 30</span>
    <span class="token comment"># }</span>

    triage_time<span class="token punctuation">:</span> datetime
    notes<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>


<span class="token comment"># Triage threshold configuration (per entity, with sensible defaults):</span>
TRIAGE_THRESHOLDS <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"bp_systolic_high"</span><span class="token punctuation">:</span> <span class="token number">140</span><span class="token punctuation">,</span>
    <span class="token string">"bp_diastolic_high"</span><span class="token punctuation">:</span> <span class="token number">90</span><span class="token punctuation">,</span>
    <span class="token string">"spo2_low"</span><span class="token punctuation">:</span> <span class="token number">94</span><span class="token punctuation">,</span>
    <span class="token string">"temperature_high"</span><span class="token punctuation">:</span> <span class="token number">37.5</span><span class="token punctuation">,</span>
    <span class="token string">"heart_rate_low"</span><span class="token punctuation">:</span> <span class="token number">60</span><span class="token punctuation">,</span>
    <span class="token string">"heart_rate_high"</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
    <span class="token string">"bmi_obese"</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="pharmacybatch-batch--expiry-tracking">PharmacyBatch (Batch &amp; Expiry Tracking)</h4>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">PharmacyBatch</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Drug batch for expiry tracking and FEFO dispensing (First Expiry, First Out)."""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"pharmacy_batches"</span>
    __table_args__ <span class="token operator">=</span> <span class="token punctuation">(</span>
        UniqueConstraint<span class="token punctuation">(</span><span class="token string">"entity_id"</span><span class="token punctuation">,</span> <span class="token string">"drug_id"</span><span class="token punctuation">,</span> <span class="token string">"batch_number"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"uq_drug_batch"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    entity_id<span class="token punctuation">:</span> UUID
    drug_id<span class="token punctuation">:</span> UUID              <span class="token comment"># → drug_catalog.id</span>
    supplier_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>

    batch_number<span class="token punctuation">:</span> <span class="token builtin">str</span>          <span class="token comment"># Manufacturer batch/lot number</span>
    manufacture_date<span class="token punctuation">:</span> date <span class="token operator">|</span> <span class="token boolean">None</span>
    expiry_date<span class="token punctuation">:</span> date          <span class="token comment"># Required — dispensing blocked after this date</span>

    <span class="token comment"># Stock levels</span>
    quantity_received<span class="token punctuation">:</span> Decimal
    quantity_available<span class="token punctuation">:</span> Decimal  <span class="token comment"># Decremented on each dispense</span>
    quantity_dispensed<span class="token punctuation">:</span> Decimal <span class="token operator">=</span> Decimal<span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span>

    <span class="token comment"># Pricing</span>
    purchase_price<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span>   <span class="token comment"># Cost per unit</span>
    selling_price<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span>    <span class="token comment"># Override drug catalog price for this batch</span>

    <span class="token comment"># Status</span>
    status<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># active, expired, recalled, exhausted</span>
    days_to_expiry<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span>       <span class="token comment"># Computed property for alerts</span>

    received_date<span class="token punctuation">:</span> date
    received_by_id<span class="token punctuation">:</span> UUID


<span class="token comment"># Dispensing always selects the batch with earliest expiry_date first (FEFO)</span>
<span class="token comment"># Dispensing blocked if: batch.status == "expired" or batch.expiry_date &lt; today</span>
</code></pre>
<h4 id="encounterattachment">EncounterAttachment</h4>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">EncounterAttachment</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""File attachment linked to a clinical encounter."""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"encounter_attachments"</span>

    encounter_id<span class="token punctuation">:</span> UUID
    patient_id<span class="token punctuation">:</span> UUID
    entity_id<span class="token punctuation">:</span> UUID
    uploaded_by_id<span class="token punctuation">:</span> UUID

    file_name<span class="token punctuation">:</span> <span class="token builtin">str</span>             <span class="token comment"># Original filename</span>
    file_type<span class="token punctuation">:</span> <span class="token builtin">str</span>             <span class="token comment"># "image/jpeg", "application/pdf", "image/png"</span>
    file_size_bytes<span class="token punctuation">:</span> <span class="token builtin">int</span>
    storage_key<span class="token punctuation">:</span> <span class="token builtin">str</span>           <span class="token comment"># S3/MinIO object key (not a public URL)</span>

    attachment_type<span class="token punctuation">:</span> <span class="token builtin">str</span>       <span class="token comment"># xray, lab_report, consent_form, referral_letter,</span>
                               <span class="token comment"># clinical_photo, id_document, insurance_card, other</span>

    description<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>    <span class="token comment"># Optional caption/label</span>
    consultation_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># Link to specific consultation if applicable</span>

    <span class="token comment"># Access control</span>
    is_clinical<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>   <span class="token comment"># Clinical attachments require emr:read permission</span>
                               <span class="token comment"># Non-clinical (e.g., insurance card) require patient:read</span>
</code></pre>
<h4 id="dental-models">Dental Models</h4>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">DentalChart</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Per-tooth condition record for a patient."""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"dental_charts"</span>

    patient_id<span class="token punctuation">:</span> UUID
    entity_id<span class="token punctuation">:</span> UUID
    dentist_id<span class="token punctuation">:</span> UUID

    tooth_number<span class="token punctuation">:</span> <span class="token builtin">str</span>          <span class="token comment"># FDI notation: "11"=upper-right-central, "36"=lower-left-1st-molar</span>
    surface<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>        <span class="token comment"># M (mesial), D (distal), B (buccal), L (lingual), O (occlusal)</span>

    condition<span class="token punctuation">:</span> <span class="token builtin">str</span>             <span class="token comment"># healthy, caries, filled, extracted, crowned,</span>
                               <span class="token comment"># bridge_abutment, implant, missing, fractured</span>
    notes<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    recorded_date<span class="token punctuation">:</span> date


<span class="token keyword">class</span> <span class="token class-name">DentalProcedureItem</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Dental procedure performed during an encounter."""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"dental_encounter_procedures"</span>

    encounter_id<span class="token punctuation">:</span> UUID
    patient_id<span class="token punctuation">:</span> UUID
    dentist_id<span class="token punctuation">:</span> UUID
    entity_id<span class="token punctuation">:</span> UUID

    tooth_number<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>   <span class="token comment"># FDI notation (null for full-mouth procedures)</span>
    surface<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>

    procedure_code<span class="token punctuation">:</span> <span class="token builtin">str</span>        <span class="token comment"># Dental billing code (e.g., "D2140" = amalgam 1 surface)</span>
    procedure_name<span class="token punctuation">:</span> <span class="token builtin">str</span>        <span class="token comment"># "Amalgam Filling - 1 surface"</span>
    notes<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># Billing</span>
    service_catalog_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>
    charge_amount<span class="token punctuation">:</span> Decimal

    status<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># planned, completed, cancelled</span>
    completed_at<span class="token punctuation">:</span> datetime <span class="token operator">|</span> <span class="token boolean">None</span>
    anesthesia_used<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># local, general, none</span>
</code></pre>
<h4 id="physiotherapy-models">Physiotherapy Models</h4>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">PhysioCarePlan</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Physiotherapy care plan for a patient episode."""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"physio_care_plans"</span>

    patient_id<span class="token punctuation">:</span> UUID
    physiotherapist_id<span class="token punctuation">:</span> UUID
    encounter_id<span class="token punctuation">:</span> UUID
    entity_id<span class="token punctuation">:</span> UUID

    <span class="token comment"># Clinical</span>
    diagnosis<span class="token punctuation">:</span> <span class="token builtin">str</span>
    icd10_code<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    presenting_complaint<span class="token punctuation">:</span> <span class="token builtin">str</span>
    functional_goals<span class="token punctuation">:</span> <span class="token builtin">str</span>          <span class="token comment"># What the patient should achieve</span>
    treatment_approach<span class="token punctuation">:</span> <span class="token builtin">str</span>        <span class="token comment"># Techniques and modalities to be used</span>

    <span class="token comment"># Plan structure</span>
    estimated_sessions<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    session_frequency<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># "3x per week", "weekly"</span>

    start_date<span class="token punctuation">:</span> date
    end_date<span class="token punctuation">:</span> date <span class="token operator">|</span> <span class="token boolean">None</span>

    status<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># active, completed, on_hold, discharged, referred</span>

    discharge_summary<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    outcome<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># goals_met, partially_met, not_met, ongoing</span>


<span class="token keyword">class</span> <span class="token class-name">PhysioSession</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Individual physiotherapy session record."""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"physio_sessions"</span>
    __table_args__ <span class="token operator">=</span> <span class="token punctuation">(</span>
        UniqueConstraint<span class="token punctuation">(</span><span class="token string">"entity_id"</span><span class="token punctuation">,</span> <span class="token string">"session_number_ref"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"uq_physio_session"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    care_plan_id<span class="token punctuation">:</span> UUID
    patient_id<span class="token punctuation">:</span> UUID
    physiotherapist_id<span class="token punctuation">:</span> UUID
    entity_id<span class="token punctuation">:</span> UUID

    session_number_ref<span class="token punctuation">:</span> <span class="token builtin">str</span>    <span class="token comment"># "SES-2026-00001"</span>
    session_number<span class="token punctuation">:</span> <span class="token builtin">int</span>        <span class="token comment"># Session # within care plan (1st, 2nd, ...)</span>
    session_date<span class="token punctuation">:</span> date
    duration_minutes<span class="token punctuation">:</span> <span class="token builtin">int</span>

    <span class="token comment"># Clinical content</span>
    presenting_status<span class="token punctuation">:</span> <span class="token builtin">str</span>     <span class="token comment"># Patient's condition at start of session</span>
    treatment_given<span class="token punctuation">:</span> <span class="token builtin">str</span>       <span class="token comment"># Techniques applied: "TENS, ultrasound, exercise"</span>
    patient_response<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    home_exercises_prescribed<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># Pain/function scores (0-10)</span>
    pain_score_start<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    pain_score_end<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    function_score<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># Billing</span>
    service_catalog_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>
    charge_amount<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span>

    status<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># completed, cancelled, no_show</span>
    next_session_date<span class="token punctuation">:</span> date <span class="token operator">|</span> <span class="token boolean">None</span>
    notes<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
</code></pre>
<h4 id="expense--accounting-period">Expense &amp; Accounting Period</h4>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">Expense</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Operational expense record for P&amp;L tracking."""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"expenses"</span>
    __table_args__ <span class="token operator">=</span> <span class="token punctuation">(</span>
        UniqueConstraint<span class="token punctuation">(</span><span class="token string">"entity_id"</span><span class="token punctuation">,</span> <span class="token string">"expense_number"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"uq_expense_number"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    entity_id<span class="token punctuation">:</span> UUID
    expense_number<span class="token punctuation">:</span> <span class="token builtin">str</span>        <span class="token comment"># "EXP-2026-00001"</span>
    expense_date<span class="token punctuation">:</span> date

    description<span class="token punctuation">:</span> <span class="token builtin">str</span>
    amount<span class="token punctuation">:</span> Decimal

    <span class="token comment"># Classification</span>
    category<span class="token punctuation">:</span> <span class="token builtin">str</span>              <span class="token comment"># salaries, utilities, supplies, equipment,</span>
                               <span class="token comment"># maintenance, rent, insurance, other</span>
    payment_method<span class="token punctuation">:</span> <span class="token builtin">str</span>        <span class="token comment"># cash, bank_transfer, mpesa, cheque</span>

    <span class="token comment"># Vendor</span>
    vendor_name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    reference_number<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>   <span class="token comment"># Receipt/invoice number from vendor</span>

    <span class="token comment"># GL</span>
    gl_account_id<span class="token punctuation">:</span> UUID        <span class="token comment"># → gl_accounts.id (expense account)</span>
    transaction_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># Approval workflow</span>
    approved_by_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>
    approved_at<span class="token punctuation">:</span> datetime <span class="token operator">|</span> <span class="token boolean">None</span>
    status<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># draft, approved, rejected</span>

    <span class="token comment"># Attachment (receipt scan)</span>
    attachment_path<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>


<span class="token keyword">class</span> <span class="token class-name">AccountingPeriod</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Accounting period definition for period close and GL locking."""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"accounting_periods"</span>
    __table_args__ <span class="token operator">=</span> <span class="token punctuation">(</span>
        UniqueConstraint<span class="token punctuation">(</span><span class="token string">"entity_id"</span><span class="token punctuation">,</span> <span class="token string">"period_name"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"uq_period"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    entity_id<span class="token punctuation">:</span> UUID
    period_name<span class="token punctuation">:</span> <span class="token builtin">str</span>           <span class="token comment"># "February 2026"</span>
    start_date<span class="token punctuation">:</span> date
    end_date<span class="token punctuation">:</span> date

    status<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># open, closed, locked</span>
    <span class="token comment"># open   → transactions can be posted</span>
    <span class="token comment"># closed → pending review, no new transactions, can be reopened</span>
    <span class="token comment"># locked → permanently locked, no changes allowed (year-end)</span>

    closed_by_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>
    closed_at<span class="token punctuation">:</span> datetime <span class="token operator">|</span> <span class="token boolean">None</span>
    locked_by_id<span class="token punctuation">:</span> UUID <span class="token operator">|</span> <span class="token boolean">None</span>
    locked_at<span class="token punctuation">:</span> datetime <span class="token operator">|</span> <span class="token boolean">None</span>

    notes<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
</code></pre>
<h4 id="qr-code-patient-registration">QR Code (Patient Registration)</h4>
<p>Patient QR codes are generated at registration time and stored as SVG/PNG in S3. The QR encodes a tokenized identifier (not the raw UUID) to prevent enumeration attacks:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># In PatientService.create_patient():</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">generate_patient_qr</span><span class="token punctuation">(</span>patient<span class="token punctuation">:</span> Patient<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Generate QR code encoding tokenized patient lookup token."""</span>
    <span class="token comment"># 1. Create a signed, time-stable token (HMAC of patient_number + secret)</span>
    token <span class="token operator">=</span> hmac_token<span class="token punctuation">(</span>patient<span class="token punctuation">.</span>patient_number<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>QR_SECRET<span class="token punctuation">)</span>
    <span class="token comment"># 2. QR payload: "hmis://patient/{token}"</span>
    qr_payload <span class="token operator">=</span> f<span class="token string">"hmis://patient/{token}"</span>
    <span class="token comment"># 3. Generate QR image → upload to S3 → store key on patient record</span>
    qr_key <span class="token operator">=</span> <span class="token keyword">await</span> generate_and_upload_qr<span class="token punctuation">(</span>qr_payload<span class="token punctuation">,</span> patient<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> qr_key

<span class="token comment"># Patient model additions:</span>
<span class="token keyword">class</span> <span class="token class-name">Patient</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ... existing fields ...</span>
    qr_token<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>       <span class="token comment"># HMAC token for QR code</span>
    qr_image_key<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>   <span class="token comment"># S3 key for QR code image (printable card)</span>

<span class="token comment"># Patient lookup by QR scan:</span>
<span class="token comment"># GET /api/patients/qr/{token}  → resolves token → returns patient profile</span>
</code></pre>
<h4 id="kenya-administrative-regions">Kenya Administrative Regions</h4>
<p>These are <strong>shared reference tables</strong> — seeded once from official Kenya government data and shared across organizations, entities, patients, and MOH reports. They are never organization-scoped (no <code>organization_id</code>/<code>entity_id</code>) because they represent national geographic data.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">County</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Kenya's 47 counties — national reference data.

    Seed data sourced from Kenya National Bureau of Statistics (KNBS).
    DHIS2 org unit IDs enable direct KHIS/DHIS2 export without mapping.
    """</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"counties"</span>
    __table_args__ <span class="token operator">=</span> <span class="token punctuation">(</span>
        UniqueConstraint<span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"uq_county_code"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        UniqueConstraint<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"uq_county_name"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token builtin">id</span><span class="token punctuation">:</span> UUID
    code<span class="token punctuation">:</span> <span class="token builtin">str</span>        <span class="token comment"># Official 2-digit code: "01" (Mombasa) → "47" (Nairobi)</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>        <span class="token comment"># "Nairobi", "Mombasa", "Kisumu", ...</span>
    dhis2_uid<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>   <span class="token comment"># DHIS2/KHIS org unit UID for report export</span>
    is_active<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>


<span class="token keyword">class</span> <span class="token class-name">SubCounty</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Sub-county (formerly district) within a county."""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"sub_counties"</span>
    __table_args__ <span class="token operator">=</span> <span class="token punctuation">(</span>
        UniqueConstraint<span class="token punctuation">(</span><span class="token string">"county_id"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"uq_sub_county_name"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token builtin">id</span><span class="token punctuation">:</span> UUID
    county_id<span class="token punctuation">:</span> UUID  <span class="token comment"># → counties.id</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>        <span class="token comment"># "Westlands", "Langata", "Embakasi East", ...</span>
    code<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    dhis2_uid<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    is_active<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>


<span class="token keyword">class</span> <span class="token class-name">AdministrativeWard</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Administrative ward within a sub-county.

    Note: These are Kenya's official administrative wards (used in MOH reports
    and DHIS2), distinct from hospital wards (wards table in IPD module).
    """</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"administrative_wards"</span>
    __table_args__ <span class="token operator">=</span> <span class="token punctuation">(</span>
        UniqueConstraint<span class="token punctuation">(</span><span class="token string">"sub_county_id"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"uq_admin_ward_name"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token builtin">id</span><span class="token punctuation">:</span> UUID
    sub_county_id<span class="token punctuation">:</span> UUID  <span class="token comment"># → sub_counties.id</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>            <span class="token comment"># "Parklands/Highridge", "Kilimani", ...</span>
    code<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    dhis2_uid<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    is_active<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>
</code></pre>
<p><strong>Region usage across the system:</strong></p>

<table>
<thead>
<tr>
<th>Model</th>
<th>Fields</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Patient</code></td>
<td><code>county_id</code>, <code>sub_county_id</code>, <code>administrative_ward_id</code></td>
<td>Patient demographics, MOH disease catchment reporting</td>
</tr>
<tr>
<td><code>Entity</code> (hospital branch)</td>
<td><code>county_id</code>, <code>sub_county_id</code></td>
<td>Facility location for MOH/DHIS2 org unit mapping</td>
</tr>
<tr>
<td><code>Organization</code></td>
<td><code>county_id</code></td>
<td>HQ location of hospital group</td>
</tr>
<tr>
<td>MOH Reports</td>
<td>Grouped by <code>county_id</code></td>
<td>Morbidity and disease surveillance by region</td>
</tr>
<tr>
<td>DHIS2 Export</td>
<td>Uses <code>county.dhis2_uid</code> / <code>sub_county.dhis2_uid</code></td>
<td>Maps to KHIS org unit hierarchy</td>
</tr>
</tbody>
</table><p><strong>Seed data strategy:</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># alembic/seed/regions.py — run once after initial migration</span>
<span class="token comment"># Data sourced from Kenya Open Data / KNBS / DHIS2 export</span>

COUNTIES <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"001"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Mombasa"</span><span class="token punctuation">,</span>       <span class="token string">"dhis2_uid"</span><span class="token punctuation">:</span> <span class="token string">"..."</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"002"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Kwale"</span><span class="token punctuation">,</span>          <span class="token string">"dhis2_uid"</span><span class="token punctuation">:</span> <span class="token string">"..."</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment"># ... all 47 counties</span>
    <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"047"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Nairobi City"</span><span class="token punctuation">,</span>   <span class="token string">"dhis2_uid"</span><span class="token punctuation">:</span> <span class="token string">"..."</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token comment"># Sub-counties and wards follow the same pattern</span>
<span class="token comment"># Total: 47 counties, ~290 sub-counties, ~1,450 wards</span>
</code></pre>
<p><strong>Region API (admin/reference data):</strong></p>
<pre><code>GET /api/regions/counties                    → All counties
GET /api/regions/counties/{id}/sub-counties → Sub-counties for a county
GET /api/regions/sub-counties/{id}/wards     → Wards for a sub-county
</code></pre>
<p>These endpoints are public (no auth required) since they are non-sensitive reference data used to populate dropdowns during patient registration.</p>
<hr>
<h3 id="global-reference-models">5.3 Global Reference Models</h3>
<p>These models have <strong>no <code>organization_id</code> or <code>entity_id</code></strong> — they are truly global, seeded once, and read by all tenants.</p>
<h4 id="icd10code">ICD10Code</h4>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">ICD10Code</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""WHO ICD-10 disease classification — complete global reference.

    Source: WHO ICD-10 Volume 1 (tabular list), freely available at
    https://www.who.int/standards/classifications/classification-of-diseases

    Total codes: ~14,400 (ICD-10 WHO edition) or ~95,000 (ICD-10-CM US edition).
    Recommendation: seed WHO edition first; add ICD-10-CM extension if needed.
    """</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"icd10_codes"</span>
    __table_args__ <span class="token operator">=</span> <span class="token punctuation">(</span>
        UniqueConstraint<span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"uq_icd10_code"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Index<span class="token punctuation">(</span><span class="token string">"idx_icd10_code"</span><span class="token punctuation">,</span> <span class="token string">"code"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Index<span class="token punctuation">(</span><span class="token string">"idx_icd10_category"</span><span class="token punctuation">,</span> <span class="token string">"category_code"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Index<span class="token punctuation">(</span><span class="token string">"idx_icd10_chapter"</span><span class="token punctuation">,</span> <span class="token string">"chapter_code"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token builtin">id</span><span class="token punctuation">:</span> UUID
    code<span class="token punctuation">:</span> <span class="token builtin">str</span>              <span class="token comment"># Full code: "A00.0", "J06.9", "K29.70"</span>
    description<span class="token punctuation">:</span> <span class="token builtin">str</span>       <span class="token comment"># "Cholera due to Vibrio cholerae 01, biovar cholerae"</span>
    short_description<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># Abbreviated for UI display</span>

    <span class="token comment"># ICD-10 hierarchy</span>
    chapter_code<span class="token punctuation">:</span> <span class="token builtin">str</span>      <span class="token comment"># Roman numeral: "I" through "XXII"</span>
    chapter_name<span class="token punctuation">:</span> <span class="token builtin">str</span>      <span class="token comment"># "Certain infectious and parasitic diseases"</span>
    block_range<span class="token punctuation">:</span> <span class="token builtin">str</span>       <span class="token comment"># "A00-A09"</span>
    block_name<span class="token punctuation">:</span> <span class="token builtin">str</span>        <span class="token comment"># "Intestinal infectious diseases"</span>
    category_code<span class="token punctuation">:</span> <span class="token builtin">str</span>     <span class="token comment"># 3-character category: "A00"</span>
    category_name<span class="token punctuation">:</span> <span class="token builtin">str</span>     <span class="token comment"># "Cholera"</span>

    <span class="token comment"># Usability flags</span>
    is_billable<span class="token punctuation">:</span> <span class="token builtin">bool</span>      <span class="token comment"># True if code is specific enough to bill (4+ chars, no further children)</span>
    is_header<span class="token punctuation">:</span> <span class="token builtin">bool</span>        <span class="token comment"># True if code is a category header (not directly assignable)</span>

    <span class="token comment"># Search support</span>
    synonyms<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>   <span class="token comment"># Pipe-separated search aliases: "flu|influenza|grippe"</span>
    notes<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>      <span class="token comment"># Includes/excludes notes from WHO tabular list</span>

    is_active<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>
</code></pre>
<p><strong>ICD-10 Chapter Reference (22 chapters):</strong></p>

<table>
<thead>
<tr>
<th>Chapter</th>
<th>Code Range</th>
<th>Name</th>
</tr>
</thead>
<tbody>
<tr>
<td>I</td>
<td>A00–B99</td>
<td>Certain infectious and parasitic diseases</td>
</tr>
<tr>
<td>II</td>
<td>C00–D49</td>
<td>Neoplasms</td>
</tr>
<tr>
<td>III</td>
<td>D50–D89</td>
<td>Diseases of blood and blood-forming organs</td>
</tr>
<tr>
<td>IV</td>
<td>E00–E89</td>
<td>Endocrine, nutritional and metabolic diseases</td>
</tr>
<tr>
<td>V</td>
<td>F01–F99</td>
<td>Mental and behavioural disorders</td>
</tr>
<tr>
<td>VI</td>
<td>G00–G99</td>
<td>Diseases of the nervous system</td>
</tr>
<tr>
<td>VII</td>
<td>H00–H59</td>
<td>Diseases of the eye and adnexa</td>
</tr>
<tr>
<td>VIII</td>
<td>H60–H95</td>
<td>Diseases of the ear and mastoid process</td>
</tr>
<tr>
<td>IX</td>
<td>I00–I99</td>
<td>Diseases of the circulatory system</td>
</tr>
<tr>
<td>X</td>
<td>J00–J99</td>
<td>Diseases of the respiratory system</td>
</tr>
<tr>
<td>XI</td>
<td>K00–K95</td>
<td>Diseases of the digestive system</td>
</tr>
<tr>
<td>XII</td>
<td>L00–L99</td>
<td>Diseases of the skin and subcutaneous tissue</td>
</tr>
<tr>
<td>XIII</td>
<td>M00–M99</td>
<td>Diseases of the musculoskeletal system</td>
</tr>
<tr>
<td>XIV</td>
<td>N00–N99</td>
<td>Diseases of the genitourinary system</td>
</tr>
<tr>
<td>XV</td>
<td>O00–O9A</td>
<td>Pregnancy, childbirth and the puerperium</td>
</tr>
<tr>
<td>XVI</td>
<td>P00–P96</td>
<td>Certain conditions originating in perinatal period</td>
</tr>
<tr>
<td>XVII</td>
<td>Q00–Q99</td>
<td>Congenital malformations</td>
</tr>
<tr>
<td>XVIII</td>
<td>R00–R99</td>
<td>Symptoms, signs and abnormal findings (NEC)</td>
</tr>
<tr>
<td>XIX</td>
<td>S00–T98</td>
<td>Injury, poisoning and external causes</td>
</tr>
<tr>
<td>XX</td>
<td>V01–Y99</td>
<td>External causes of morbidity</td>
</tr>
<tr>
<td>XXI</td>
<td>Z00–Z99</td>
<td>Factors influencing health status and contact</td>
</tr>
<tr>
<td>XXII</td>
<td>U00–U99</td>
<td>Codes for special purposes</td>
</tr>
</tbody>
</table><hr>
<h4 id="drugmaster">DrugMaster</h4>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">DrugMaster</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Global drug reference — WHO / Kenya Essential Medicines List.

    Sources:
    - Kenya Essential Medicines and Health Supplies List (KEML 2019)
      https://www.health.go.ke — approx 480 medicines
    - WHO Model Essential Medicines List (23rd edition, 2023)
      https://www.who.int/groups/expert-committee-on-selection-and-use-of-essential-medicines
      approx 460 medicines
    - Combined, de-duplicated: ~600 generic drugs seeded.

    This is READ-ONLY reference data. Entities build their drug_catalog
    by selecting from this master list and setting their own prices.
    """</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"drug_master"</span>
    __table_args__ <span class="token operator">=</span> <span class="token punctuation">(</span>
        UniqueConstraint<span class="token punctuation">(</span><span class="token string">"inn"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"uq_drug_inn"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        UniqueConstraint<span class="token punctuation">(</span><span class="token string">"atc_code"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"uq_atc_code"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Index<span class="token punctuation">(</span><span class="token string">"idx_drug_inn"</span><span class="token punctuation">,</span> <span class="token string">"inn"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Index<span class="token punctuation">(</span><span class="token string">"idx_drug_atc"</span><span class="token punctuation">,</span> <span class="token string">"atc_code"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Index<span class="token punctuation">(</span><span class="token string">"idx_drug_category"</span><span class="token punctuation">,</span> <span class="token string">"therapeutic_category"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token builtin">id</span><span class="token punctuation">:</span> UUID

    <span class="token comment"># International identifiers</span>
    inn<span class="token punctuation">:</span> <span class="token builtin">str</span>               <span class="token comment"># INN (International Nonproprietary Name): "amoxicillin"</span>
    atc_code<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>   <span class="token comment"># WHO ATC code: "J01CA04" (Amoxicillin)</span>
                           <span class="token comment"># ATC: Anatomical Therapeutic Chemical Classification</span>

    <span class="token comment"># Classification</span>
    therapeutic_category<span class="token punctuation">:</span> <span class="token builtin">str</span>     <span class="token comment"># "Antibiotics", "Analgesics", "Antidiabetics", ...</span>
    pharmacological_class<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># "Beta-lactam penicillin", "NSAID", ...</span>
    atc_level1<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>        <span class="token comment"># ATC level 1: "J" (Antiinfectives for systemic use)</span>
    atc_level2<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>        <span class="token comment"># ATC level 2: "J01" (Antibacterials for systemic use)</span>
    atc_level3<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>        <span class="token comment"># ATC level 3: "J01C" (Beta-lactam antibacterials)</span>

    <span class="token comment"># Available formulations (stored as JSONB list)</span>
    dosage_forms<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span>
    <span class="token comment"># ["tablet", "capsule", "oral_suspension", "injection", "cream", "eye_drops", ...]</span>

    standard_strengths<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span>
    <span class="token comment"># ["250mg", "500mg", "1g"] or ["250mg/5ml"] for suspensions</span>

    <span class="token comment"># Regulatory status</span>
    is_kenya_essential<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span>    <span class="token comment"># On Kenya KEML 2019</span>
    is_who_essential<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span>      <span class="token comment"># On WHO EML 23rd edition</span>
    requires_prescription<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>
    is_controlled_substance<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># Narcotic / psychotropic (special register)</span>
    controlled_substance_schedule<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># "Schedule I", "Schedule II", ...</span>

    <span class="token comment"># Storage</span>
    storage_condition<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>   <span class="token comment"># "Store below 25°C away from light"</span>
    cold_chain_required<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># Refrigerate 2-8°C</span>
    shelf_life_months<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span>

    <span class="token comment"># Pregnancy / paediatric safety</span>
    pregnancy_category<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># "A", "B", "C", "D", "X" (FDA categories)</span>
    safe_in_children<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    minimum_age_years<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span>   <span class="token comment"># e.g., 0 (neonates), 1, 6, 12, 18</span>

    <span class="token comment"># Common interactions and contraindications (brief, for alerts)</span>
    major_interactions<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># "Warfarin — increases bleeding risk"</span>
    contraindications<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>   <span class="token comment"># "Penicillin allergy"</span>

    is_active<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>
</code></pre>
<p><strong>Sample therapeutic categories seeded:</strong></p>

<table>
<thead>
<tr>
<th>Category</th>
<th>Examples</th>
</tr>
</thead>
<tbody>
<tr>
<td>Antibiotics</td>
<td>Amoxicillin, Metronidazole, Ciprofloxacin, Azithromycin, Co-trimoxazole</td>
</tr>
<tr>
<td>Analgesics / Antipyretics</td>
<td>Paracetamol, Ibuprofen, Diclofenac, Morphine, Tramadol</td>
</tr>
<tr>
<td>Antidiabetics</td>
<td>Metformin, Glibenclamide, Insulin regular, Insulin NPH</td>
</tr>
<tr>
<td>Antihypertensives</td>
<td>Amlodipine, Enalapril, Hydrochlorothiazide, Atenolol, Losartan</td>
</tr>
<tr>
<td>Antimalarials</td>
<td>Artemether-Lumefantrine (AL), Quinine, Artesunate IV</td>
</tr>
<tr>
<td>Antiretrovirals (ARVs)</td>
<td>TDF/3TC/DTG, AZT/3TC/NVP, EFV, Abacavir</td>
</tr>
<tr>
<td>Antifungals</td>
<td>Fluconazole, Clotrimazole, Griseofulvin, Nystatin</td>
</tr>
<tr>
<td>GI Medicines</td>
<td>Omeprazole, Ranitidine, ORS, Metoclopramide, Loperamide</td>
</tr>
<tr>
<td>Respiratory</td>
<td>Salbutamol, Beclomethasone, Aminophylline, Prednisolone</td>
</tr>
<tr>
<td>IV Fluids</td>
<td>Normal Saline, Ringer’s Lactate, Dextrose 5%, Dextrose Saline</td>
</tr>
<tr>
<td>Vitamins / Supplements</td>
<td>Folic acid, Ferrous sulfate, Vitamin A, Zinc, Multivitamins</td>
</tr>
<tr>
<td>Vaccines</td>
<td>BCG, OPV, DPT-HepB-Hib, Pneumococcal, HPV (per KEPI schedule)</td>
</tr>
<tr>
<td>Contraceptives</td>
<td>Depo-Provera, Combined OCP, Levonorgestrel, IUD</td>
</tr>
<tr>
<td>Ophthalmics</td>
<td>Chloramphenicol eye drops, Gentamicin eye drops, Timolol</td>
</tr>
<tr>
<td>Dermatologicals</td>
<td>Hydrocortisone cream, Gentian violet, Benzoyl peroxide</td>
</tr>
<tr>
<td>Controlled Substances</td>
<td>Morphine sulfate, Pethidine, Diazepam, Phenobarbitone</td>
</tr>
</tbody>
</table><hr>
<h4 id="labtestmaster">LabTestMaster</h4>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">LabTestMaster</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Standard lab test reference with reference ranges.

    Source: compiled from:
    - Kenya Ministry of Health laboratory standards
    - WHO laboratory reference ranges
    - CLSI (Clinical and Laboratory Standards Institute) guidelines
    - LOINC (Logical Observation Identifiers Names and Codes)
      https://loinc.org — free, internationally standardized lab codes

    ~180 tests seeded covering all common lab disciplines.
    Entities import from this master into their lab_test_catalog,
    adjusting prices and enabling/disabling tests as needed.
    """</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"lab_test_master"</span>
    __table_args__ <span class="token operator">=</span> <span class="token punctuation">(</span>
        UniqueConstraint<span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"uq_lab_test_code"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Index<span class="token punctuation">(</span><span class="token string">"idx_lab_test_category"</span><span class="token punctuation">,</span> <span class="token string">"category"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Index<span class="token punctuation">(</span><span class="token string">"idx_lab_test_loinc"</span><span class="token punctuation">,</span> <span class="token string">"loinc_code"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token builtin">id</span><span class="token punctuation">:</span> UUID
    code<span class="token punctuation">:</span> <span class="token builtin">str</span>              <span class="token comment"># Internal code: "CBC", "HBA1C", "WIDAL", "CD4_COUNT"</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>              <span class="token comment"># "Complete Blood Count (CBC)"</span>
    short_name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token comment"># "CBC"</span>
    loinc_code<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token comment"># LOINC: "58410-2" (CBC panel)</span>
    cpt_code<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>   <span class="token comment"># CPT billing code (for international billing reference)</span>

    <span class="token comment"># Classification</span>
    category<span class="token punctuation">:</span> <span class="token builtin">str</span>
    <span class="token comment"># "Haematology" | "Biochemistry" | "Microbiology" | "Serology/Immunology" |</span>
    <span class="token comment"># "Urinalysis" | "Parasitology" | "Histopathology" | "Endocrinology" |</span>
    <span class="token comment"># "Coagulation" | "Blood Bank" | "Point-of-Care"</span>

    <span class="token comment"># Specimen</span>
    specimen_types<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span>
    <span class="token comment"># ["blood_edta", "blood_serum", "blood_plasma", "urine", "stool",</span>
    <span class="token comment">#  "csf", "swab", "sputum", "blood_fluoride"]</span>

    tube_type<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    <span class="token comment"># "EDTA (purple top)", "SST (gold/red top)", "Heparin (green top)",</span>
    <span class="token comment"># "Fluoride oxalate (grey top)", "Plain (red top)", "Citrate (blue top)"</span>

    sample_volume_ml<span class="token punctuation">:</span> Decimal <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># Minimum sample volume required</span>

    <span class="token comment"># Reference ranges (JSONB — stratified by age group and sex)</span>
    reference_ranges<span class="token punctuation">:</span> <span class="token builtin">dict</span> <span class="token operator">|</span> <span class="token boolean">None</span>
    <span class="token comment"># Structure:</span>
    <span class="token comment"># {</span>
    <span class="token comment">#   "haemoglobin": {</span>
    <span class="token comment">#     "adult_male":    {"low": 13.5, "high": 17.5, "unit": "g/dL", "critical_low": 7.0, "critical_high": 20.0},</span>
    <span class="token comment">#     "adult_female":  {"low": 12.0, "high": 15.5, "unit": "g/dL", "critical_low": 7.0, "critical_high": 20.0},</span>
    <span class="token comment">#     "child_6_12yr":  {"low": 11.5, "high": 15.5, "unit": "g/dL"},</span>
    <span class="token comment">#     "child_1_5yr":   {"low": 11.0, "high": 14.0, "unit": "g/dL"},</span>
    <span class="token comment">#     "neonate":       {"low": 14.0, "high": 24.0, "unit": "g/dL"},</span>
    <span class="token comment">#   },</span>
    <span class="token comment">#   "wbc": { "adult": {"low": 4.0, "high": 11.0, "unit": "×10⁹/L"} },</span>
    <span class="token comment">#   ...</span>
    <span class="token comment"># }</span>

    <span class="token comment"># Result type</span>
    result_type<span class="token punctuation">:</span> <span class="token builtin">str</span>
    <span class="token comment"># "numeric_single"   — one number result (e.g., Blood glucose)</span>
    <span class="token comment"># "numeric_panel"    — multiple numeric sub-results (e.g., CBC with diff)</span>
    <span class="token comment"># "positive_negative" — binary (e.g., HIV rapid test, Malaria RDT)</span>
    <span class="token comment"># "text"             — descriptive (e.g., Culture &amp; Sensitivity)</span>
    <span class="token comment"># "titre"            — e.g., Widal (1:80, 1:160, 1:320)</span>

    <span class="token comment"># Turnaround time</span>
    tat_routine_minutes<span class="token punctuation">:</span> <span class="token builtin">int</span>    <span class="token comment"># Expected TAT for routine priority</span>
    tat_urgent_minutes<span class="token punctuation">:</span> <span class="token builtin">int</span>     <span class="token comment"># Expected TAT for urgent priority</span>
    tat_stat_minutes<span class="token punctuation">:</span> <span class="token builtin">int</span>       <span class="token comment"># Expected TAT for STAT (emergency)</span>

    <span class="token comment"># Reporting</span>
    report_unit<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>     <span class="token comment"># "g/dL", "mmol/L", "IU/L", "cells/µL"</span>
    decimal_places<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span>     <span class="token comment"># How many decimal places to show in result</span>

    <span class="token comment"># Panel membership (a CBC panel contains Haemoglobin, WBC, Platelets, etc.)</span>
    parent_panel_code<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># "CBC" (for sub-tests like "HB", "WBC")</span>
    is_panel<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span>         <span class="token comment"># True if this IS a panel (orders sub-tests)</span>
    panel_member_codes<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># Sub-test codes if is_panel=True</span>

    is_active<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>
</code></pre>
<p><strong>Lab Test Categories Seeded (~180 tests):</strong></p>

<table>
<thead>
<tr>
<th>Category</th>
<th>Count</th>
<th>Example Tests</th>
</tr>
</thead>
<tbody>
<tr>
<td>Haematology</td>
<td>18</td>
<td>CBC + Differential, ESR, Blood Group &amp; Rhesus, Sickling Test, G6PD, Reticulocyte count</td>
</tr>
<tr>
<td>Biochemistry</td>
<td>45</td>
<td>FBS, RBS, HbA1c, RFTs (Urea/Creatinine/Uric Acid), LFTs (ALT/AST/ALP/Bilirubin), Lipid Profile, Electrolytes, CRP, Albumin, Total Protein</td>
</tr>
<tr>
<td>Serology / Immunology</td>
<td>22</td>
<td>HIV 1&amp;2 Rapid, Hepatitis B surface Ag, Hepatitis C Ab, VDRL/RPR, Brucella, ASO titre, Rheumatoid Factor, ANA, CD4 count</td>
</tr>
<tr>
<td>Microbiology / Culture</td>
<td>14</td>
<td>Blood C&amp;S, Urine C&amp;S, Stool C&amp;S, Wound swab C&amp;S, Sputum AAFB, GeneXpert MTB/RIF, Throat swab C&amp;S</td>
</tr>
<tr>
<td>Urinalysis</td>
<td>8</td>
<td>Urinalysis (dipstick + microscopy), 24hr protein, Urine pregnancy test</td>
</tr>
<tr>
<td>Parasitology</td>
<td>10</td>
<td>Malaria Rapid (RDT), Malaria smear (thick/thin), Stool O&amp;P, Stool direct smear, Stool occult blood, Hookworm/Roundworm, Schistosoma</td>
</tr>
<tr>
<td>Endocrinology</td>
<td>18</td>
<td>TSH, Free T3, Free T4, Cortisol, FSH, LH, Prolactin, Testosterone, Oestradiol, Progesterone, Beta-HCG</td>
</tr>
<tr>
<td>Coagulation</td>
<td>6</td>
<td>PT/INR, APTT, D-dimer, Fibrinogen, Bleeding time, Clotting time</td>
</tr>
<tr>
<td>Blood Bank</td>
<td>8</td>
<td>Blood Group + Rhesus, Cross-match, Coombs test (direct/indirect), Antibody screen</td>
</tr>
<tr>
<td>Point-of-Care</td>
<td>12</td>
<td>HbA1c (POCT), Troponin I, BNP, Lactate, Procalcitonin, Blood ketones, INR (POCT)</td>
</tr>
<tr>
<td>Other / Specialty</td>
<td>19</td>
<td>Widal, Mantoux, Pap smear, Semen analysis, CSF analysis, Joint fluid analysis, AFB stain</td>
</tr>
</tbody>
</table><hr>
<h4 id="labtestmaterial">LabTestMaterial</h4>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">LabTestMaterial</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Consumables and reagents required per lab test.

    Links global lab tests to the materials consumed when running each test.
    When a test is performed, these materials are deducted from pharmacy/lab stock.
    This enables automated reagent consumption tracking and reorder alerts.
    """</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"lab_test_materials"</span>

    <span class="token builtin">id</span><span class="token punctuation">:</span> UUID
    lab_test_master_id<span class="token punctuation">:</span> UUID   <span class="token comment"># → lab_test_master.id</span>

    material_name<span class="token punctuation">:</span> <span class="token builtin">str</span>         <span class="token comment"># "EDTA Tube 3mL", "Malaria RDT Kit", "HIV Determine Kit"</span>
    material_code<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>  <span class="token comment"># Internal catalog code — matched to drug_master or inventory item</span>
    quantity_per_test<span class="token punctuation">:</span> Decimal <span class="token comment"># Amount consumed per single test run</span>
    unit<span class="token punctuation">:</span> <span class="token builtin">str</span>
    <span class="token comment"># "tube" | "kit" | "ml" | "strip" | "slide" | "card" | "vial" | "piece"</span>

    material_type<span class="token punctuation">:</span> <span class="token builtin">str</span>
    <span class="token comment"># "collection_tube"  — specimen collection container (EDTA, SST, etc.)</span>
    <span class="token comment"># "rapid_test_kit"   — RDT strip/kit (HIV, Malaria, HBsAg, pregnancy)</span>
    <span class="token comment"># "reagent"          — liquid reagent for analyzer (CBC reagent, chemistry reagent)</span>
    <span class="token comment"># "stain"            — microscopy stain (Giemsa, Gram, ZN/AFB)</span>
    <span class="token comment"># "consumable"       — slides, cover slips, gloves, swabs</span>
    <span class="token comment"># "control"          — QC control material (run every batch)</span>

    is_essential<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># False = optional/for reference only</span>
    notes<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span>          <span class="token comment"># "Use within 30 min of collection", "Keep refrigerated"</span>
</code></pre>
<p><strong>Sample material mappings (selected tests):</strong></p>

<table>
<thead>
<tr>
<th>Test</th>
<th>Materials Required</th>
</tr>
</thead>
<tbody>
<tr>
<td>CBC</td>
<td>1× EDTA tube 3mL, CBC reagent kit (per analyzer batch), Diff reagent</td>
</tr>
<tr>
<td>Malaria RDT</td>
<td>1× Malaria RDT kit (SD Bioline/CareStart), 1× capillary lancet, 1× buffer drop</td>
</tr>
<tr>
<td>HIV 1&amp;2 Rapid</td>
<td>1× HIV Determine kit, 1× HIV Unigold/Bioline kit (for confirmation), 1× lancet</td>
</tr>
<tr>
<td>Blood Glucose (FBS/RBS)</td>
<td>1× Fluoride oxalate tube OR 1× glucometer strip (POCT)</td>
</tr>
<tr>
<td>HbA1c</td>
<td>1× EDTA tube 3mL, 1× HbA1c reagent cartridge (POCT)</td>
</tr>
<tr>
<td>Urine Pregnancy Test</td>
<td>1× urine pregnancy test strip</td>
</tr>
<tr>
<td>Malaria Smear (thick/thin)</td>
<td>2× glass slides, Giemsa stain solution (0.5mL), Methanol (fixative)</td>
</tr>
<tr>
<td>Urinalysis (dipstick)</td>
<td>1× urine dipstick strip, 1× sterile sample container</td>
</tr>
<tr>
<td>Blood C&amp;S</td>
<td>1× aerobic blood culture bottle, 1× anaerobic blood culture bottle</td>
</tr>
<tr>
<td>LFTs panel</td>
<td>1× SST tube 5mL, Chemistry reagent (ALT/AST/ALP/Bilirubin per analyzer)</td>
</tr>
<tr>
<td>AFB Sputum Smear</td>
<td>2× glass slides, ZN stain set (Carbol Fuchsin, Acid Alcohol, Methylene Blue)</td>
</tr>
<tr>
<td>CD4 Count</td>
<td>1× EDTA tube 3mL, BD Multitest kit (or equivalent per machine)</td>
</tr>
</tbody>
</table><hr>
<h3 id="seed-data-strategy">5.4 Seed Data Strategy</h3>
<p>This section defines <strong>what gets seeded</strong>, <strong>when</strong>, and <strong>at what scope</strong> for every new HMIS installation.</p>
<h4 id="tier-1-—-global-reference-data-seeded-once-shared-by-all-tenants">Tier 1 — Global Reference Data (seeded once, shared by all tenants)</h4>
<p>Run during initial database setup via <code>alembic/seed/global/</code>. Never modified after seeding — only updated via migration when new versions are released.</p>
<pre><code>alembic/seed/global/
├── 01_counties.py          # 47 counties (official KNBS codes + DHIS2 UIDs)
├── 02_sub_counties.py      # ~290 sub-counties
├── 03_admin_wards.py       # ~1,450 administrative wards
├── 04_icd10_codes.py       # WHO ICD-10 ~14,400 codes (from WHO XML download)
├── 05_drug_master.py       # ~600 drugs (Kenya KEML + WHO EML, de-duplicated)
├── 06_lab_test_master.py   # ~180 lab tests with reference ranges
└── 07_lab_test_materials.py # ~500 material-test mappings
</code></pre>
<p><strong>Data sources and download commands:</strong></p>
<pre class=" language-bash"><code class="prism  language-bash"><span class="token comment"># ICD-10 WHO edition (XML format)</span>
<span class="token comment"># Download from: https://www.who.int/standards/classifications/classification-of-diseases/release/WHO_ICD10_release2019.zip</span>
<span class="token comment"># Parse with: alembic/seed/utils/parse_icd10_xml.py</span>

<span class="token comment"># Drug master — Kenya KEML 2019 (PDF/Excel)</span>
<span class="token comment"># Source: https://www.health.go.ke/kenya-essential-medicines-list/</span>
<span class="token comment"># Data already normalized to JSON in: alembic/seed/data/drug_master.json</span>

<span class="token comment"># Lab tests (custom compiled from MOH/CLSI/WHO guidelines)</span>
<span class="token comment"># Source file: alembic/seed/data/lab_tests.json (maintained in this repo)</span>
<span class="token comment"># LOINC codes verified against: https://loinc.org/search/</span>

python -m alembic.seed.global.run_all   <span class="token comment"># Seeds all Tier 1 data in order</span>
</code></pre>
<h4 id="tier-2-—-per-organization-setup-run-once-per-new-organization">Tier 2 — Per-Organization Setup (run once per new organization)</h4>
<p>Triggered automatically when a new Organization is created via admin panel.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">seed_new_organization</span><span class="token punctuation">(</span>org_id<span class="token punctuation">:</span> UUID<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Called by OrganizationService.create_organization() after DB commit."""</span>
    <span class="token comment"># Nothing org-level to seed for now — all clinical data is entity-scoped.</span>
    <span class="token comment"># Future: org-level chart of accounts template</span>
    <span class="token keyword">pass</span>
</code></pre>
<h4 id="tier-3-—-per-entity-setup-run-once-per-new-hospital-branch">Tier 3 — Per-Entity Setup (run once per new hospital branch)</h4>
<p>Triggered automatically when a new Entity (branch) is created. Creates a working, ready-to-use setup for the entity from global reference data.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">seed_new_entity</span><span class="token punctuation">(</span>entity_id<span class="token punctuation">:</span> UUID<span class="token punctuation">,</span> org_id<span class="token punctuation">:</span> UUID<span class="token punctuation">,</span> setup<span class="token punctuation">:</span> EntitySetupConfig<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Called by EntityService.create_entity() after DB commit.
    Gives every new branch a complete, operational starting configuration.
    """</span>
    <span class="token keyword">await</span> seed_departments<span class="token punctuation">(</span>entity_id<span class="token punctuation">)</span>
    <span class="token keyword">await</span> seed_drug_catalog<span class="token punctuation">(</span>entity_id<span class="token punctuation">)</span>
    <span class="token keyword">await</span> seed_lab_test_catalog<span class="token punctuation">(</span>entity_id<span class="token punctuation">)</span>
    <span class="token keyword">await</span> seed_service_catalog<span class="token punctuation">(</span>entity_id<span class="token punctuation">)</span>
    <span class="token keyword">await</span> seed_insurance_schemes<span class="token punctuation">(</span>entity_id<span class="token punctuation">)</span>
    <span class="token keyword">await</span> seed_accounting_period<span class="token punctuation">(</span>entity_id<span class="token punctuation">)</span>
</code></pre>
<p><strong>3a. Departments</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">seed_departments</span><span class="token punctuation">(</span>entity_id<span class="token punctuation">:</span> UUID<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Standard hospital departments created for every new entity."""</span>
    DEFAULT_DEPARTMENTS <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Outpatient (OPD)"</span><span class="token punctuation">,</span>        <span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"OPD"</span><span class="token punctuation">,</span>   <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"clinical"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Inpatient (IPD)"</span><span class="token punctuation">,</span>          <span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"IPD"</span><span class="token punctuation">,</span>   <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"clinical"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Emergency &amp; Casualty"</span><span class="token punctuation">,</span>     <span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"EMERG"</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"clinical"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Laboratory"</span><span class="token punctuation">,</span>               <span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"LAB"</span><span class="token punctuation">,</span>   <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"diagnostic"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Radiology / Imaging"</span><span class="token punctuation">,</span>      <span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"RAD"</span><span class="token punctuation">,</span>   <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"diagnostic"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Pharmacy"</span><span class="token punctuation">,</span>                 <span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"PHARM"</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"support"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Dental"</span><span class="token punctuation">,</span>                   <span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"DENT"</span><span class="token punctuation">,</span>  <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"clinical"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Physiotherapy"</span><span class="token punctuation">,</span>            <span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"PHYSIO"</span><span class="token punctuation">,</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"clinical"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Maternity / ANC"</span><span class="token punctuation">,</span>          <span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"MATTY"</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"clinical"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Paediatrics"</span><span class="token punctuation">,</span>              <span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"PAEDS"</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"clinical"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Eye Clinic (Ophthalmology)"</span><span class="token punctuation">,</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"EYE"</span><span class="token punctuation">,</span>  <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"clinical"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Administration"</span><span class="token punctuation">,</span>           <span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"ADMIN"</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"administrative"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
    <span class="token comment"># Entities activate only the departments relevant to them;</span>
    <span class="token comment"># unused departments are simply never assigned patients.</span>
</code></pre>
<p><strong>3b. Drug Catalog</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">seed_drug_catalog</span><span class="token punctuation">(</span>entity_id<span class="token punctuation">:</span> UUID<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Import all active drugs from drug_master into this entity's drug_catalog.
    Prices default to 0.00 — admin must set actual selling prices before going live.
    Batches are created as drugs are purchased (not seeded).
    """</span>
    drugs <span class="token operator">=</span> <span class="token keyword">await</span> DrugMaster<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>is_active<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    drug_catalog_entries <span class="token operator">=</span> <span class="token punctuation">[</span>
        DrugCatalog<span class="token punctuation">(</span>
            entity_id<span class="token operator">=</span>entity_id<span class="token punctuation">,</span>
            drug_master_id<span class="token operator">=</span>drug<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
            generic_name<span class="token operator">=</span>drug<span class="token punctuation">.</span>inn<span class="token punctuation">,</span>
            therapeutic_category<span class="token operator">=</span>drug<span class="token punctuation">.</span>therapeutic_category<span class="token punctuation">,</span>
            requires_prescription<span class="token operator">=</span>drug<span class="token punctuation">.</span>requires_prescription<span class="token punctuation">,</span>
            is_controlled<span class="token operator">=</span>drug<span class="token punctuation">.</span>is_controlled_substance<span class="token punctuation">,</span>
            selling_price<span class="token operator">=</span>Decimal<span class="token punctuation">(</span><span class="token string">"0.00"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment"># Admin sets actual price</span>
            is_active<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">for</span> drug <span class="token keyword">in</span> drugs
    <span class="token punctuation">]</span>
    <span class="token keyword">await</span> DrugCatalog<span class="token punctuation">.</span>bulk_create<span class="token punctuation">(</span>drug_catalog_entries<span class="token punctuation">)</span>
    <span class="token comment"># Result: ~600 drugs ready to use — admin just sets prices and starts purchasing batches</span>
</code></pre>
<p><strong>3c. Lab Test Catalog</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">seed_lab_test_catalog</span><span class="token punctuation">(</span>entity_id<span class="token punctuation">:</span> UUID<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Import all active lab tests from lab_test_master into this entity's catalog.
    Prices default to 0.00. Materials are linked via lab_test_materials (global).
    """</span>
    tests <span class="token operator">=</span> <span class="token keyword">await</span> LabTestMaster<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>is_active<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    catalog_entries <span class="token operator">=</span> <span class="token punctuation">[</span>
        LabTestCatalog<span class="token punctuation">(</span>
            entity_id<span class="token operator">=</span>entity_id<span class="token punctuation">,</span>
            lab_test_master_id<span class="token operator">=</span>test<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
            code<span class="token operator">=</span>test<span class="token punctuation">.</span>code<span class="token punctuation">,</span>
            name<span class="token operator">=</span>test<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
            category<span class="token operator">=</span>test<span class="token punctuation">.</span>category<span class="token punctuation">,</span>
            tat_routine_minutes<span class="token operator">=</span>test<span class="token punctuation">.</span>tat_routine_minutes<span class="token punctuation">,</span>
            price<span class="token operator">=</span>Decimal<span class="token punctuation">(</span><span class="token string">"0.00"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment"># Admin sets actual price</span>
            is_active<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">for</span> test <span class="token keyword">in</span> tests
    <span class="token punctuation">]</span>
    <span class="token keyword">await</span> LabTestCatalog<span class="token punctuation">.</span>bulk_create<span class="token punctuation">(</span>catalog_entries<span class="token punctuation">)</span>
    <span class="token comment"># Result: ~180 tests ready. Materials auto-tracked via global lab_test_materials.</span>
</code></pre>
<p><strong>3d. Service Catalog (default consultation and procedure fees)</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">seed_service_catalog</span><span class="token punctuation">(</span>entity_id<span class="token punctuation">:</span> UUID<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Create default billable services for the entity.
    Prices are 0.00 — admin sets the actual tariff before going live.
    """</span>
    DEFAULT_SERVICES <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token comment"># Consultations</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"CONS-GP"</span><span class="token punctuation">,</span>    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"General OPD Consultation"</span><span class="token punctuation">,</span>         <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"consultation"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"CONS-SPEC"</span><span class="token punctuation">,</span>  <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Specialist Consultation"</span><span class="token punctuation">,</span>           <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"consultation"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"CONS-EMERG"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Emergency / Casualty Consultation"</span><span class="token punctuation">,</span> <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"consultation"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"CONS-DENT"</span><span class="token punctuation">,</span>  <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Dental Consultation"</span><span class="token punctuation">,</span>               <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"consultation"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"CONS-PHYSIO"</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Physiotherapy Initial Assessment"</span><span class="token punctuation">,</span>  <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"consultation"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"CONS-TELE"</span><span class="token punctuation">,</span>  <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Telemedicine Consultation"</span><span class="token punctuation">,</span>         <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"consultation"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

        <span class="token comment"># Nursing / Procedures</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"PROC-DRESS"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Wound Dressing"</span><span class="token punctuation">,</span>                    <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"procedure"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"PROC-INJECT"</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Injection Administration"</span><span class="token punctuation">,</span>           <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"procedure"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"PROC-IV"</span><span class="token punctuation">,</span>    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"IV Cannula Insertion"</span><span class="token punctuation">,</span>               <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"procedure"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"PROC-CATH"</span><span class="token punctuation">,</span>  <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Urinary Catheterization"</span><span class="token punctuation">,</span>            <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"procedure"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"PROC-SUTURE"</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Wound Suturing (per stitch)"</span><span class="token punctuation">,</span>        <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"procedure"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"PROC-ECG"</span><span class="token punctuation">,</span>   <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"ECG (12-lead)"</span><span class="token punctuation">,</span>                      <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"procedure"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

        <span class="token comment"># Maternity</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"ANC-VISIT"</span><span class="token punctuation">,</span>  <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"ANC Visit"</span><span class="token punctuation">,</span>                          <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"maternity"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"DELIVERY-NVD"</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Normal Vaginal Delivery"</span><span class="token punctuation">,</span>           <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"maternity"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"DELIVERY-CS"</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Caesarean Section"</span><span class="token punctuation">,</span>                  <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"maternity"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

        <span class="token comment"># Dental procedures</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"DENT-SCALE"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Scaling and Polishing"</span><span class="token punctuation">,</span>              <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"dental"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"DENT-EXTRACT"</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token punctuation">:</span><span class="token string">"Tooth Extraction (simple)"</span><span class="token punctuation">,</span>          <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"dental"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"DENT-FILL"</span><span class="token punctuation">,</span>  <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Composite Filling (per surface)"</span><span class="token punctuation">,</span>    <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"dental"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"DENT-RCT"</span><span class="token punctuation">,</span>   <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Root Canal Treatment"</span><span class="token punctuation">,</span>               <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"dental"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

        <span class="token comment"># Physiotherapy</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"PHYSIO-SESS"</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Physiotherapy Session"</span><span class="token punctuation">,</span>              <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"physiotherapy"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"PHYSIO-TENS"</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"TENS Therapy Session"</span><span class="token punctuation">,</span>               <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"physiotherapy"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"PHYSIO-US"</span><span class="token punctuation">,</span>  <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Ultrasound Therapy Session"</span><span class="token punctuation">,</span>         <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"physiotherapy"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

        <span class="token comment"># Radiology / Imaging</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"XRAY-CHEST"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Chest X-Ray"</span><span class="token punctuation">,</span>                        <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"radiology"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"XRAY-LIMB"</span><span class="token punctuation">,</span>  <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Limb X-Ray"</span><span class="token punctuation">,</span>                         <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"radiology"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"USS-ABD"</span><span class="token punctuation">,</span>    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Abdominal Ultrasound"</span><span class="token punctuation">,</span>                <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"radiology"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"USS-OB"</span><span class="token punctuation">,</span>     <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Obstetric Ultrasound"</span><span class="token punctuation">,</span>                <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"radiology"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

        <span class="token comment"># IPD / Bed charges (daily rates set by entity)</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"BED-GENERAL"</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"General Ward Bed (per day)"</span><span class="token punctuation">,</span>         <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"bed"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"BED-PRIVATE"</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Private Room Bed (per day)"</span><span class="token punctuation">,</span>          <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"bed"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"BED-ICU"</span><span class="token punctuation">,</span>    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"ICU Bed (per day)"</span><span class="token punctuation">,</span>                   <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"bed"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
</code></pre>
<p><strong>3e. Insurance Schemes</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">seed_insurance_schemes</span><span class="token punctuation">(</span>entity_id<span class="token punctuation">:</span> UUID<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Seed NHIF/SHA as the default national insurer.
    Private insurers are added manually by admin.
    """</span>
    DEFAULT_SCHEMES <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"NHIF / SHA (National Health Insurance Fund)"</span><span class="token punctuation">,</span>
            <span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"NHIF"</span><span class="token punctuation">,</span>
            <span class="token string">"scheme_type"</span><span class="token punctuation">:</span> <span class="token string">"government"</span><span class="token punctuation">,</span>
            <span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
            <span class="token comment"># API credentials configured separately — not seeded</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
</code></pre>
<p><strong>3f. Accounting Period</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">seed_accounting_period</span><span class="token punctuation">(</span>entity_id<span class="token punctuation">:</span> UUID<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Create the current calendar month as the first open accounting period."""</span>
    today <span class="token operator">=</span> date<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> AccountingPeriod<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
        entity_id<span class="token operator">=</span>entity_id<span class="token punctuation">,</span>
        period_name<span class="token operator">=</span>today<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%B %Y"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment"># "February 2026"</span>
        start_date<span class="token operator">=</span>today<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>day<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        end_date<span class="token operator">=</span>last_day_of_month<span class="token punctuation">(</span>today<span class="token punctuation">)</span><span class="token punctuation">,</span>
        status<span class="token operator">=</span><span class="token string">"open"</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
</code></pre>
<h4 id="tier-4-—-system-admin-user-run-once-per-entity-post-setup">Tier 4 — System Admin User (run once per entity, post-setup)</h4>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_default_admin</span><span class="token punctuation">(</span>entity_id<span class="token punctuation">:</span> UUID<span class="token punctuation">,</span> admin_data<span class="token punctuation">:</span> AdminSetupData<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Creates the first admin user for a new entity.
    Admin is prompted to change password on first login.
    """</span>
    admin_user <span class="token operator">=</span> <span class="token keyword">await</span> UserService<span class="token punctuation">.</span>create_user<span class="token punctuation">(</span>
        entity_id<span class="token operator">=</span>entity_id<span class="token punctuation">,</span>
        name<span class="token operator">=</span>admin_data<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        email<span class="token operator">=</span>admin_data<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
        role<span class="token operator">=</span><span class="token string">"hospital_admin"</span><span class="token punctuation">,</span>
        must_change_password<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token comment"># A temporary password is emailed to admin_data.email</span>
</code></pre>
<h4 id="seed-execution-summary">Seed Execution Summary</h4>

<table>
<thead>
<tr>
<th>Tier</th>
<th>Scope</th>
<th>Trigger</th>
<th>Data Size</th>
</tr>
</thead>
<tbody>
<tr>
<td>1 — Global Reference</td>
<td>System-wide</td>
<td>One-time deployment script</td>
<td>~16,000 rows total</td>
</tr>
<tr>
<td>2 — Per Organization</td>
<td>Organization</td>
<td>Auto on org creation</td>
<td>0 rows (future use)</td>
</tr>
<tr>
<td>3 — Per Entity</td>
<td>Entity (branch)</td>
<td>Auto on entity creation</td>
<td>~800–900 rows per entity</td>
</tr>
<tr>
<td>4 — Admin User</td>
<td>Entity</td>
<td>Manual (onboarding call)</td>
<td>1 user per entity</td>
</tr>
</tbody>
</table><h4 id="keeping-seed-data-current">Keeping Seed Data Current</h4>
<pre><code>ICD-10:     WHO releases updates periodically. Run migration + re-seed when WHO
            publishes a new edition. Existing codes never deleted — deprecated
            codes get is_active=False.

Drug Master: Kenya KEML updated every 2-3 years. New drugs added via migration.
             Removed drugs set is_active=False (historical dispensing records preserved).

Lab Tests:  Reviewed annually. New tests added; retired tests deactivated.
            Reference ranges updated when Kenya MOH / CLSI revises guidelines.

Regions:    Kenya constituency/ward boundaries change after each census.
            KNBS publishes official updates. Migrations handle boundary changes.
</code></pre>
<hr>
<h2 id="module-breakdown--api-design">6. Module Breakdown &amp; API Design</h2>
<h3 id="module-1-patient-management">6.1 Module 1: Patient Management</h3>
<p><strong>Routes prefix:</strong> <code>/api/patients</code></p>

<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>Permission</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td><code>/</code></td>
<td>patient:create</td>
<td>Register new patient</td>
</tr>
<tr>
<td>GET</td>
<td><code>/</code></td>
<td>patient:read</td>
<td>Search patients (name, phone, ID)</td>
</tr>
<tr>
<td>GET</td>
<td><code>/{id}</code></td>
<td>patient:read</td>
<td>Get patient profile</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/{id}</code></td>
<td>patient:update</td>
<td>Update demographics</td>
</tr>
<tr>
<td>GET</td>
<td><code>/{id}/encounters</code></td>
<td>patient:read</td>
<td>Patient history</td>
</tr>
<tr>
<td>GET</td>
<td><code>/{id}/allergies</code></td>
<td>patient:read</td>
<td>Patient allergies</td>
</tr>
<tr>
<td>POST</td>
<td><code>/{id}/allergies</code></td>
<td>emr:write</td>
<td>Record allergy</td>
</tr>
<tr>
<td>GET</td>
<td><code>/{id}/insurance</code></td>
<td>patient:read</td>
<td>Insurance coverage</td>
</tr>
<tr>
<td>POST</td>
<td><code>/{id}/insurance</code></td>
<td>patient:update</td>
<td>Add insurance</td>
</tr>
<tr>
<td>GET</td>
<td><code>/{id}/vitals-history</code></td>
<td>patient:read</td>
<td>Historical vitals</td>
</tr>
<tr>
<td>GET</td>
<td><code>/{id}/summary</code></td>
<td>patient:read</td>
<td>Clinical summary card</td>
</tr>
<tr>
<td>GET</td>
<td><code>/qr/{token}</code></td>
<td>patient:read</td>
<td>Look up patient by QR scan token</td>
</tr>
<tr>
<td>GET</td>
<td><code>/{id}/qr</code></td>
<td>patient:read</td>
<td>Get patient’s QR code image</td>
</tr>
</tbody>
</table><p><strong>Key Service Methods:</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">PatientService</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">register_patient</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> CreatePatientRequest<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> PatientResponse
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">search_patients</span><span class="token punctuation">(</span>query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> entity_id<span class="token punctuation">:</span> UUID<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">[</span>PatientResponse<span class="token punctuation">]</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_patient_summary</span><span class="token punctuation">(</span>patient_id<span class="token punctuation">:</span> UUID<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> PatientSummaryResponse
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">check_duplicate</span><span class="token punctuation">(</span>phone<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> dob<span class="token punctuation">:</span> date<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">[</span>PatientResponse<span class="token punctuation">]</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">merge_patients</span><span class="token punctuation">(</span>primary_id<span class="token punctuation">:</span> UUID<span class="token punctuation">,</span> duplicate_id<span class="token punctuation">:</span> UUID<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> PatientResponse
</code></pre>
<hr>
<h3 id="module-2-appointments--queue">6.2 Module 2: Appointments &amp; Queue</h3>
<p><strong>Routes prefix:</strong> <code>/api/appointments</code></p>

<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>Permission</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td><code>/doctors/schedules</code></td>
<td>appointment:read</td>
<td>Available doctors</td>
</tr>
<tr>
<td>GET</td>
<td><code>/slots</code></td>
<td>appointment:read</td>
<td>Available slots by doctor+date</td>
</tr>
<tr>
<td>POST</td>
<td><code>/</code></td>
<td>appointment:create</td>
<td>Book appointment</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/{id}/confirm</code></td>
<td>appointment:update</td>
<td>Confirm appointment</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/{id}/cancel</code></td>
<td>appointment:cancel</td>
<td>Cancel appointment</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/{id}/reschedule</code></td>
<td>appointment:update</td>
<td>Reschedule</td>
</tr>
<tr>
<td>POST</td>
<td><code>/walkin</code></td>
<td>encounter:create</td>
<td>Create walk-in encounter</td>
</tr>
<tr>
<td>GET</td>
<td><code>/queue</code></td>
<td>queue:read</td>
<td>Today’s OPD queue</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/queue/{id}/call</code></td>
<td>queue:update</td>
<td>Call next patient</td>
</tr>
<tr>
<td>GET</td>
<td><code>/queue/display</code></td>
<td>public</td>
<td>Public queue display board</td>
</tr>
</tbody>
</table><p><strong>Real-time Queue via WebSocket:</strong></p>
<pre><code>WS /ws/queue/{department_id}
    → Broadcasts when patient called, new patient registered
    → Used by queue display screens in waiting area
</code></pre>
<hr>
<h3 id="module-3-emr--clinical-module">6.3 Module 3: EMR / Clinical Module</h3>
<p><strong>Routes prefix:</strong> <code>/api/encounters</code>, <code>/api/emr</code></p>

<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>Permission</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td><code>/encounters</code></td>
<td>encounter:create</td>
<td>Create encounter</td>
</tr>
<tr>
<td>GET</td>
<td><code>/encounters/{id}</code></td>
<td>encounter:read</td>
<td>Full encounter detail</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/encounters/{id}/triage</code></td>
<td>triage:write</td>
<td>Record triage</td>
</tr>
<tr>
<td>POST</td>
<td><code>/encounters/{id}/consultation</code></td>
<td>emr:write</td>
<td>Start consultation</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/encounters/{id}/consultation</code></td>
<td>emr:write</td>
<td>Update/finalize consultation</td>
</tr>
<tr>
<td>POST</td>
<td><code>/encounters/{id}/diagnoses</code></td>
<td>emr:write</td>
<td>Add ICD-10 diagnosis</td>
</tr>
<tr>
<td>POST</td>
<td><code>/encounters/{id}/prescriptions</code></td>
<td>prescription:create</td>
<td>Create prescription</td>
</tr>
<tr>
<td>POST</td>
<td><code>/encounters/{id}/lab-orders</code></td>
<td>lab:order</td>
<td>Create lab order</td>
</tr>
<tr>
<td>POST</td>
<td><code>/encounters/{id}/radiology-orders</code></td>
<td>radiology:order</td>
<td>Create imaging order</td>
</tr>
<tr>
<td>POST</td>
<td><code>/encounters/{id}/notes</code></td>
<td>emr:write</td>
<td>Add clinical note</td>
</tr>
<tr>
<td>GET</td>
<td><code>/encounters/{id}/timeline</code></td>
<td>emr:read</td>
<td>Full encounter timeline</td>
</tr>
<tr>
<td>POST</td>
<td><code>/encounters/{id}/attachments</code></td>
<td>emr:write</td>
<td>Upload file attachment (multipart)</td>
</tr>
<tr>
<td>GET</td>
<td><code>/encounters/{id}/attachments</code></td>
<td>emr:read</td>
<td>List encounter attachments</td>
</tr>
<tr>
<td>GET</td>
<td><code>/attachments/{id}/download</code></td>
<td>emr:read</td>
<td>Download attachment (signed URL)</td>
</tr>
<tr>
<td>DELETE</td>
<td><code>/attachments/{id}</code></td>
<td>emr:write</td>
<td>Remove attachment</td>
</tr>
</tbody>
</table><p><strong>File Upload Flow:</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># POST /api/encounters/{id}/attachments  (multipart/form-data)</span>
<span class="token comment"># Fields: file (binary), attachment_type, description (optional)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">upload_attachment</span><span class="token punctuation">(</span>encounter_id<span class="token punctuation">:</span> UUID<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">:</span> UploadFile<span class="token punctuation">,</span> data<span class="token punctuation">:</span> AttachmentCreate<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. Validate file type (allow: jpg, png, pdf, dcm)</span>
    <span class="token comment"># 2. Validate file size (max 20MB)</span>
    <span class="token comment"># 3. Upload to S3 with path: attachments/{entity_id}/{encounter_id}/{uuid}.{ext}</span>
    <span class="token comment"># 4. Create EncounterAttachment record</span>
    <span class="token comment"># 5. Return attachment metadata (never the raw S3 key)</span>

<span class="token comment"># GET /api/attachments/{id}/download</span>
<span class="token comment"># Returns a pre-signed S3 URL valid for 15 minutes (not a permanent public link)</span>
</code></pre>
<p><strong>Consultation Finalization Rule:</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Consultation becomes immutable once finalized.</span>
<span class="token comment"># Amendments must create a new consultation linked to original.</span>
<span class="token comment"># This is enforced at service layer:</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">finalize_consultation</span><span class="token punctuation">(</span>consultation_id<span class="token punctuation">:</span> UUID<span class="token punctuation">,</span> doctor_id<span class="token punctuation">:</span> UUID<span class="token punctuation">)</span><span class="token punctuation">:</span>
    consultation<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"finalized"</span>
    consultation<span class="token punctuation">.</span>finalized_at <span class="token operator">=</span> utc_now<span class="token punctuation">(</span><span class="token punctuation">)</span>
    consultation<span class="token punctuation">.</span>finalized_by_id <span class="token operator">=</span> doctor_id
    <span class="token comment"># From this point, only amendments allowed, not edits</span>
</code></pre>
<hr>
<h3 id="module-4-laboratory-lis">6.4 Module 4: Laboratory (LIS)</h3>
<p><strong>Routes prefix:</strong> <code>/api/lab</code></p>

<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>Permission</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td><code>/catalog</code></td>
<td>lab:read</td>
<td>Test catalog</td>
</tr>
<tr>
<td>GET</td>
<td><code>/orders</code></td>
<td>lab:read</td>
<td>All pending orders</td>
</tr>
<tr>
<td>GET</td>
<td><code>/orders/pending</code></td>
<td>lab:read</td>
<td>Orders awaiting processing</td>
</tr>
<tr>
<td>POST</td>
<td><code>/orders/{id}/collect</code></td>
<td>lab:specimen</td>
<td>Record specimen collection</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/orders/items/{id}/result</code></td>
<td>lab:result</td>
<td>Enter test result</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/orders/items/{id}/verify</code></td>
<td>lab:verify</td>
<td>Verify result (senior lab tech)</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/orders/items/{id}/release</code></td>
<td>lab:release</td>
<td>Release result to doctor/patient</td>
</tr>
<tr>
<td>GET</td>
<td><code>/results/{patient_id}</code></td>
<td>lab:read</td>
<td>Patient’s historical results</td>
</tr>
<tr>
<td>POST</td>
<td><code>/critical-values/notify</code></td>
<td>lab:notify</td>
<td>Send critical value notification</td>
</tr>
</tbody>
</table><p><strong>Critical Value Alert Flow:</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">enter_result</span><span class="token punctuation">(</span>item_id<span class="token punctuation">:</span> UUID<span class="token punctuation">,</span> result<span class="token punctuation">:</span> LabResultCreate<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. Save result</span>
    <span class="token comment"># 2. Check against reference ranges</span>
    <span class="token keyword">if</span> result_numeric <span class="token operator">&gt;</span> test<span class="token punctuation">.</span>critical_high <span class="token operator">or</span> result_numeric <span class="token operator">&lt;</span> test<span class="token punctuation">.</span>critical_low<span class="token punctuation">:</span>
        <span class="token comment"># 3. Flag as critical</span>
        result<span class="token punctuation">.</span>is_critical <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token comment"># 4. Auto-notify requesting doctor via WebSocket + SMS</span>
        <span class="token keyword">await</span> notify_doctor_critical_value<span class="token punctuation">(</span>order<span class="token punctuation">.</span>requesting_doctor_id<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
    <span class="token comment"># 5. Trigger billing → BillLineItem created</span>
    <span class="token keyword">await</span> create_lab_bill_item<span class="token punctuation">(</span>order<span class="token punctuation">.</span>encounter_id<span class="token punctuation">,</span> item<span class="token punctuation">)</span>
</code></pre>
<hr>
<h3 id="module-5-pharmacy">6.5 Module 5: Pharmacy</h3>
<p><strong>Routes prefix:</strong> <code>/api/pharmacy</code></p>

<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>Permission</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td><code>/queue</code></td>
<td>pharmacy:read</td>
<td>Prescriptions awaiting dispensing</td>
</tr>
<tr>
<td>GET</td>
<td><code>/prescriptions/{id}</code></td>
<td>pharmacy:read</td>
<td>Prescription detail</td>
</tr>
<tr>
<td>POST</td>
<td><code>/prescriptions/{id}/dispense</code></td>
<td>pharmacy:dispense</td>
<td>Dispense drugs</td>
</tr>
<tr>
<td>GET</td>
<td><code>/drugs</code></td>
<td>pharmacy:read</td>
<td>Drug catalog</td>
</tr>
<tr>
<td>GET</td>
<td><code>/drugs/{id}/stock</code></td>
<td>pharmacy:read</td>
<td>Drug stock levels</td>
</tr>
<tr>
<td>GET</td>
<td><code>/drugs/expiring</code></td>
<td>pharmacy:read</td>
<td>Batches expiring within 30/60/90 days</td>
</tr>
<tr>
<td>GET</td>
<td><code>/drugs/low-stock</code></td>
<td>pharmacy:read</td>
<td>Drugs below minimum stock threshold</td>
</tr>
<tr>
<td>POST</td>
<td><code>/drugs/{id}/check-interaction</code></td>
<td>pharmacy:read</td>
<td>Check drug interactions</td>
</tr>
</tbody>
</table><p><strong>Dispensing Flow (with Batch/Expiry Validation):</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">dispense_prescription</span><span class="token punctuation">(</span>prescription_id<span class="token punctuation">,</span> dispensing_data<span class="token punctuation">,</span> pharmacist_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. Validate prescription not expired</span>
    <span class="token comment"># 2. Check allergy against patient allergies</span>
    <span class="token comment"># 3. Check drug interactions (other active prescriptions)</span>
    <span class="token comment"># 4. Verify stock availability (check across active batches)</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> dispensing_data<span class="token punctuation">.</span>items<span class="token punctuation">:</span>
        <span class="token comment"># 5. Select batch using FEFO (First Expiry, First Out)</span>
        batch <span class="token operator">=</span> <span class="token keyword">await</span> get_fefo_batch<span class="token punctuation">(</span>item<span class="token punctuation">.</span>drug_id<span class="token punctuation">,</span> item<span class="token punctuation">.</span>quantity_to_dispense<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> batch<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> StockError<span class="token punctuation">(</span>f<span class="token string">"Insufficient stock for {item.drug_name}"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> batch<span class="token punctuation">.</span>expiry_date <span class="token operator">&lt;=</span> today<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> StockError<span class="token punctuation">(</span>f<span class="token string">"All available batches of {item.drug_name} are expired"</span><span class="token punctuation">)</span>
        <span class="token comment"># 6. Create StockMovement (inventory deduction)</span>
        <span class="token keyword">await</span> create_stock_movement<span class="token punctuation">(</span>
            item_id<span class="token operator">=</span>item<span class="token punctuation">.</span>drug_id<span class="token punctuation">,</span>
            quantity<span class="token operator">=</span><span class="token operator">-</span>item<span class="token punctuation">.</span>quantity_to_dispense<span class="token punctuation">,</span>  <span class="token comment"># Deduction</span>
            movement_type<span class="token operator">=</span><span class="token string">"pharmacy_dispensing"</span><span class="token punctuation">,</span>
            reference<span class="token operator">=</span>prescription_id
        <span class="token punctuation">)</span>
        <span class="token comment"># 6. Create BillLineItem</span>
        <span class="token keyword">await</span> create_pharmacy_bill_item<span class="token punctuation">(</span>encounter_id<span class="token punctuation">,</span> item<span class="token punctuation">)</span>
    <span class="token comment"># 7. Update prescription status</span>
    <span class="token comment"># 8. Create Transaction(type=pharmacy_sale) for GL posting</span>
</code></pre>
<hr>
<h3 id="module-6-ward-management-ipd">6.6 Module 6: Ward Management (IPD)</h3>
<p><strong>Routes prefix:</strong> <code>/api/wards</code>, <code>/api/admissions</code></p>

<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>Permission</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td><code>/wards/occupancy</code></td>
<td>ward:read</td>
<td>Current bed occupancy dashboard</td>
</tr>
<tr>
<td>POST</td>
<td><code>/admissions</code></td>
<td>admission:create</td>
<td>Admit patient</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/admissions/{id}/transfer</code></td>
<td>admission:transfer</td>
<td>Ward/bed transfer</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/admissions/{id}/discharge</code></td>
<td>admission:discharge</td>
<td>Discharge patient</td>
</tr>
<tr>
<td>POST</td>
<td><code>/admissions/{id}/vitals</code></td>
<td>nursing:write</td>
<td>Record vital signs</td>
</tr>
<tr>
<td>POST</td>
<td><code>/admissions/{id}/medications</code></td>
<td>nursing:administer</td>
<td>Medication administration (MAR)</td>
</tr>
<tr>
<td>POST</td>
<td><code>/admissions/{id}/notes</code></td>
<td>nursing:write</td>
<td>Nursing progress note</td>
</tr>
<tr>
<td>GET</td>
<td><code>/beds</code></td>
<td>ward:read</td>
<td>All beds with status</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/beds/{id}/status</code></td>
<td>ward:update</td>
<td>Update bed status</td>
</tr>
</tbody>
</table><p><strong>Daily Bed Charge Job:</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Runs at 00:05 daily via APScheduler:</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">generate_daily_bed_charges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    active_admissions <span class="token operator">=</span> <span class="token keyword">await</span> get_all_active_admissions<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> admission <span class="token keyword">in</span> active_admissions<span class="token punctuation">:</span>
        bed <span class="token operator">=</span> <span class="token keyword">await</span> get_current_bed<span class="token punctuation">(</span>admission<span class="token punctuation">)</span>
        <span class="token comment"># Create BillLineItem for yesterday's bed charge</span>
        <span class="token keyword">await</span> create_bill_line_item<span class="token punctuation">(</span>
            bill_id<span class="token operator">=</span>encounter<span class="token punctuation">.</span>bill_id<span class="token punctuation">,</span>
            charge_type<span class="token operator">=</span><span class="token string">"bed"</span><span class="token punctuation">,</span>
            description<span class="token operator">=</span>f<span class="token string">"Bed charge - {bed.bed_number} ({bed.ward.name})"</span><span class="token punctuation">,</span>
            unit_price<span class="token operator">=</span>bed<span class="token punctuation">.</span>daily_rate<span class="token punctuation">,</span>
            date<span class="token operator">=</span>yesterday
        <span class="token punctuation">)</span>
        <span class="token comment"># Create Transaction for GL posting</span>
        <span class="token keyword">await</span> create_bed_charge_transaction<span class="token punctuation">(</span>admission<span class="token punctuation">,</span> bed<span class="token punctuation">,</span> yesterday<span class="token punctuation">)</span>
</code></pre>
<hr>
<h3 id="module-7-billing--insurance">6.7 Module 7: Billing &amp; Insurance</h3>
<p><strong>Routes prefix:</strong> <code>/api/billing</code></p>

<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>Permission</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td><code>/encounters/{id}/bill</code></td>
<td>billing:read</td>
<td>Get encounter bill</td>
</tr>
<tr>
<td>POST</td>
<td><code>/encounters/{id}/bill/finalize</code></td>
<td>billing:finalize</td>
<td>Finalize bill</td>
</tr>
<tr>
<td>POST</td>
<td><code>/bills/{id}/payment</code></td>
<td>billing:collect</td>
<td>Record payment</td>
</tr>
<tr>
<td>POST</td>
<td><code>/bills/{id}/waive</code></td>
<td>billing:approve</td>
<td>Waive charges</td>
</tr>
<tr>
<td>POST</td>
<td><code>/insurance/claims</code></td>
<td>insurance:submit</td>
<td>Submit insurance claim</td>
</tr>
<tr>
<td>GET</td>
<td><code>/insurance/claims</code></td>
<td>insurance:read</td>
<td>List claims</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/insurance/claims/{id}/response</code></td>
<td>insurance:update</td>
<td>Record claim response</td>
</tr>
<tr>
<td>GET</td>
<td><code>/reports/daily-revenue</code></td>
<td>reports:read</td>
<td>Daily revenue report</td>
</tr>
<tr>
<td>GET</td>
<td><code>/reports/outstanding</code></td>
<td>reports:read</td>
<td>Outstanding balances</td>
</tr>
<tr>
<td>POST</td>
<td><code>/bills/{id}/void</code></td>
<td>billing:void</td>
<td>Void unpaid invoice (admin only)</td>
</tr>
<tr>
<td>POST</td>
<td><code>/bills/{id}/refund</code></td>
<td>billing:refund</td>
<td>Refund paid invoice (admin only)</td>
</tr>
<tr>
<td>GET</td>
<td><code>/reports/export</code></td>
<td>reports:export</td>
<td>Export report as CSV or XLSX</td>
</tr>
</tbody>
</table><p><strong>Invoice Void / Refund Workflow:</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># VOID — cancels an invoice that has NOT been paid</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">void_invoice</span><span class="token punctuation">(</span>bill_id<span class="token punctuation">:</span> UUID<span class="token punctuation">,</span> reason<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> admin_id<span class="token punctuation">:</span> UUID<span class="token punctuation">)</span><span class="token punctuation">:</span>
    bill <span class="token operator">=</span> <span class="token keyword">await</span> get_bill<span class="token punctuation">(</span>bill_id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> bill<span class="token punctuation">.</span>payment_status <span class="token operator">!=</span> <span class="token string">"pending"</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValidationError<span class="token punctuation">(</span><span class="token string">"Only unpaid invoices can be voided"</span><span class="token punctuation">)</span>
    <span class="token comment"># 1. Set bill.status = "voided"</span>
    <span class="token comment"># 2. Reverse any pending insurance pre-auth</span>
    <span class="token comment"># 3. Create audit log: bill_voided, reason, admin_id</span>
    <span class="token comment"># 4. No GL entry needed (never collected)</span>

<span class="token comment"># REFUND — reverses a bill that HAS been paid (fully or partially)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">refund_invoice</span><span class="token punctuation">(</span>bill_id<span class="token punctuation">:</span> UUID<span class="token punctuation">,</span> refund_amount<span class="token punctuation">:</span> Decimal<span class="token punctuation">,</span> reason<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> admin_id<span class="token punctuation">:</span> UUID<span class="token punctuation">)</span><span class="token punctuation">:</span>
    bill <span class="token operator">=</span> <span class="token keyword">await</span> get_bill<span class="token punctuation">(</span>bill_id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> bill<span class="token punctuation">.</span>amount_paid <span class="token operator">&lt;</span> refund_amount<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValidationError<span class="token punctuation">(</span><span class="token string">"Refund amount exceeds amount paid"</span><span class="token punctuation">)</span>
    <span class="token comment"># 1. Create Transaction(type=PATIENT_REFUND, amount=refund_amount)</span>
    <span class="token comment"># 2. GL: DR Accounts Receivable → CR Cash/M-Pesa Float</span>
    <span class="token comment"># 3. Update bill.amount_paid, bill.outstanding_amount</span>
    <span class="token comment"># 4. Create audit log: bill_refunded, amount, reason, admin_id</span>
</code></pre>
<p><strong>Auto-Bill Generation:</strong><br>
Every clinical service auto-generates a bill line item through event hooks:</p>
<ul>
<li>Doctor finalizes consultation → Consultation fee added to bill</li>
<li>Lab result entered → Lab charge added to bill</li>
<li>Drug dispensed → Pharmacy charge added to bill</li>
<li>Midnight job → Bed charge added to bill</li>
<li>Radiologist releases report → Radiology charge added to bill</li>
</ul>
<p><strong>GL Integration (via Transaction Model):</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Each payment type creates appropriate GL entries:</span>

<span class="token comment"># Patient pays cash:</span>
Transaction<span class="token punctuation">(</span>
    <span class="token builtin">type</span><span class="token operator">=</span>TransactionType<span class="token punctuation">.</span>PATIENT_PAYMENT<span class="token punctuation">,</span>
    amount<span class="token operator">=</span><span class="token number">500.00</span><span class="token punctuation">,</span>
    <span class="token comment"># GL: DR Cash/Bank → CR Accounts Receivable</span>
<span class="token punctuation">)</span>

<span class="token comment"># Insurance pays claim:</span>
Transaction<span class="token punctuation">(</span>
    <span class="token builtin">type</span><span class="token operator">=</span>TransactionType<span class="token punctuation">.</span>INSURANCE_PAYMENT<span class="token punctuation">,</span>
    amount<span class="token operator">=</span><span class="token number">3000.00</span><span class="token punctuation">,</span>
    <span class="token comment"># GL: DR Cash → CR Insurance Receivable</span>
<span class="token punctuation">)</span>
</code></pre>
<hr>
<h3 id="module-8-reports--compliance">6.8 Module 8: Reports &amp; Compliance</h3>
<p><strong>Routes prefix:</strong> <code>/api/reports</code></p>

<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td><code>/moh/705a</code></td>
<td>MOH-705A (OPD morbidity)</td>
</tr>
<tr>
<td>GET</td>
<td><code>/moh/705b</code></td>
<td>MOH-705B (inpatient morbidity)</td>
</tr>
<tr>
<td>GET</td>
<td><code>/moh/717</code></td>
<td>MOH-717 (HMIS summary)</td>
</tr>
<tr>
<td>GET</td>
<td><code>/disease-notifications</code></td>
<td>Notifiable diseases</td>
</tr>
<tr>
<td>GET</td>
<td><code>/daily-summary</code></td>
<td>Daily facility summary</td>
</tr>
<tr>
<td>GET</td>
<td><code>/bed-occupancy</code></td>
<td>Bed occupancy statistics</td>
</tr>
<tr>
<td>GET</td>
<td><code>/doctor-performance</code></td>
<td>Patients per doctor</td>
</tr>
<tr>
<td>GET</td>
<td><code>/revenue-breakdown</code></td>
<td>Revenue by service type</td>
</tr>
<tr>
<td>GET</td>
<td><code>/insurance-performance</code></td>
<td>Claims approval rates</td>
</tr>
<tr>
<td>GET</td>
<td><code>/drug-consumption</code></td>
<td>Top drug consumption</td>
</tr>
</tbody>
</table><hr>
<h3 id="module-9-patient-portal">6.9 Module 9: Patient Portal</h3>
<p>The Patient Portal is a <strong>separate authenticated surface</strong> for patients — they log in with phone + OTP or email + password and can only see their own data.</p>
<p><strong>Routes prefix:</strong> <code>/api/portal</code></p>

<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td><code>/auth/register</code></td>
<td>Patient self-registration or first-time login</td>
</tr>
<tr>
<td>POST</td>
<td><code>/auth/login</code></td>
<td>Phone+OTP or email+password</td>
</tr>
<tr>
<td>GET</td>
<td><code>/me</code></td>
<td>Own profile (demographics, insurance)</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/me</code></td>
<td>Update own contact details</td>
</tr>
<tr>
<td>GET</td>
<td><code>/appointments</code></td>
<td>Upcoming and past appointments</td>
</tr>
<tr>
<td>POST</td>
<td><code>/appointments</code></td>
<td>Book appointment</td>
</tr>
<tr>
<td>DELETE</td>
<td><code>/appointments/{id}</code></td>
<td>Cancel appointment</td>
</tr>
<tr>
<td>GET</td>
<td><code>/prescriptions</code></td>
<td>Own prescriptions (read-only)</td>
</tr>
<tr>
<td>GET</td>
<td><code>/bills</code></td>
<td>Own bills with outstanding amounts</td>
</tr>
<tr>
<td>GET</td>
<td><code>/bills/{id}</code></td>
<td>Bill detail with line items</td>
</tr>
<tr>
<td>POST</td>
<td><code>/bills/{id}/pay</code></td>
<td>Initiate M-Pesa STK push for own bill</td>
</tr>
<tr>
<td>GET</td>
<td><code>/history</code></td>
<td>Visit history (encounters summary)</td>
</tr>
<tr>
<td>GET</td>
<td><code>/history/{encounter_id}</code></td>
<td>Single encounter summary</td>
</tr>
<tr>
<td>GET</td>
<td><code>/lab-results</code></td>
<td>Own released lab results</td>
</tr>
</tbody>
</table><p><strong>Patient Portal Data Scope Rules:</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># All portal endpoints enforce patient_id = authenticated_patient.id</span>
<span class="token comment"># A patient CANNOT access any other patient's data — enforced at service layer</span>

<span class="token keyword">class</span> <span class="token class-name">PortalPatientGuard</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Ensures portal user can only access their own records."""</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> db<span class="token punctuation">:</span> AsyncSession<span class="token punctuation">)</span><span class="token punctuation">:</span>
        portal_patient_id <span class="token operator">=</span> request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>patient_id  <span class="token comment"># from JWT claim</span>
        resource_patient_id <span class="token operator">=</span> request<span class="token punctuation">.</span>path_params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"patient_id"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> resource_patient_id <span class="token operator">and</span> resource_patient_id <span class="token operator">!=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>portal_patient_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> PermissionDeniedError<span class="token punctuation">(</span><span class="token string">"Access denied"</span><span class="token punctuation">)</span>
</code></pre>
<p><strong>M-Pesa Payment from Portal:</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># POST /api/portal/bills/{id}/pay</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">initiate_portal_payment</span><span class="token punctuation">(</span>bill_id<span class="token punctuation">:</span> UUID<span class="token punctuation">,</span> portal_user<span class="token punctuation">:</span> PortalUser<span class="token punctuation">)</span><span class="token punctuation">:</span>
    bill <span class="token operator">=</span> <span class="token keyword">await</span> get_bill_for_patient<span class="token punctuation">(</span>bill_id<span class="token punctuation">,</span> portal_user<span class="token punctuation">.</span>patient_id<span class="token punctuation">)</span>
    <span class="token comment"># 1. Validate outstanding_amount &gt; 0</span>
    <span class="token comment"># 2. Initiate STK push to patient's registered phone</span>
    <span class="token keyword">await</span> mpesa_stk_push<span class="token punctuation">(</span>
        phone<span class="token operator">=</span>portal_user<span class="token punctuation">.</span>phone_number<span class="token punctuation">,</span>
        amount<span class="token operator">=</span>bill<span class="token punctuation">.</span>outstanding_amount<span class="token punctuation">,</span>
        account_reference<span class="token operator">=</span>bill<span class="token punctuation">.</span>bill_number<span class="token punctuation">,</span>
        description<span class="token operator">=</span>f<span class="token string">"Payment for {bill.bill_number}"</span>
    <span class="token punctuation">)</span>
    <span class="token comment"># 3. Return: {"status": "pending", "message": "Check your phone for M-Pesa prompt"}</span>
    <span class="token comment"># 4. Callback (same as staff-side) updates bill on confirmation</span>
</code></pre>
<hr>
<h3 id="module-10-dental">6.10 Module 10: Dental</h3>
<p><strong>Routes prefix:</strong> <code>/api/dental</code></p>

<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>Permission</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td><code>/encounters/{id}/chart</code></td>
<td>dental:read</td>
<td>Patient dental chart (per-tooth)</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/encounters/{id}/chart/{tooth}</code></td>
<td>dental:write</td>
<td>Update tooth condition</td>
</tr>
<tr>
<td>GET</td>
<td><code>/encounters/{id}/procedures</code></td>
<td>dental:read</td>
<td>Procedures for encounter</td>
</tr>
<tr>
<td>POST</td>
<td><code>/encounters/{id}/procedures</code></td>
<td>dental:write</td>
<td>Add procedure</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/procedures/{id}/complete</code></td>
<td>dental:write</td>
<td>Mark procedure completed</td>
</tr>
<tr>
<td>DELETE</td>
<td><code>/procedures/{id}</code></td>
<td>dental:write</td>
<td>Cancel planned procedure</td>
</tr>
<tr>
<td>GET</td>
<td><code>/catalog</code></td>
<td>dental:read</td>
<td>Dental procedure catalog with codes</td>
</tr>
</tbody>
</table><p><strong>Dental Billing Integration:</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># When a dental procedure is marked completed → auto-adds to encounter bill</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">complete_dental_procedure</span><span class="token punctuation">(</span>procedure_id<span class="token punctuation">:</span> UUID<span class="token punctuation">,</span> dentist_id<span class="token punctuation">:</span> UUID<span class="token punctuation">)</span><span class="token punctuation">:</span>
    procedure <span class="token operator">=</span> <span class="token keyword">await</span> get_procedure<span class="token punctuation">(</span>procedure_id<span class="token punctuation">)</span>
    procedure<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"completed"</span>
    procedure<span class="token punctuation">.</span>completed_at <span class="token operator">=</span> utc_now<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># Auto-create bill line item</span>
    <span class="token keyword">await</span> create_bill_line_item<span class="token punctuation">(</span>
        bill_id<span class="token operator">=</span>encounter<span class="token punctuation">.</span>bill_id<span class="token punctuation">,</span>
        charge_type<span class="token operator">=</span><span class="token string">"dental_procedure"</span><span class="token punctuation">,</span>
        description<span class="token operator">=</span>f<span class="token string">"{procedure.procedure_name} - Tooth {procedure.tooth_number}"</span><span class="token punctuation">,</span>
        unit_price<span class="token operator">=</span>procedure<span class="token punctuation">.</span>charge_amount<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
</code></pre>
<hr>
<h3 id="module-11-physiotherapy">6.11 Module 11: Physiotherapy</h3>
<p><strong>Routes prefix:</strong> <code>/api/physiotherapy</code></p>

<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>Permission</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td><code>/care-plans</code></td>
<td>physio:write</td>
<td>Create care plan for patient</td>
</tr>
<tr>
<td>GET</td>
<td><code>/care-plans/{id}</code></td>
<td>physio:read</td>
<td>Care plan detail</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/care-plans/{id}</code></td>
<td>physio:write</td>
<td>Update care plan</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/care-plans/{id}/discharge</code></td>
<td>physio:write</td>
<td>Discharge patient with outcome</td>
</tr>
<tr>
<td>GET</td>
<td><code>/care-plans/{id}/sessions</code></td>
<td>physio:read</td>
<td>All sessions in care plan</td>
</tr>
<tr>
<td>POST</td>
<td><code>/care-plans/{id}/sessions</code></td>
<td>physio:write</td>
<td>Record new session</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/sessions/{id}</code></td>
<td>physio:write</td>
<td>Update session notes</td>
</tr>
<tr>
<td>GET</td>
<td><code>/patients/{id}/care-plans</code></td>
<td>physio:read</td>
<td>Patient’s physio history</td>
</tr>
<tr>
<td>GET</td>
<td><code>/calendar</code></td>
<td>physio:read</td>
<td>Physiotherapist’s session calendar</td>
</tr>
</tbody>
</table><p><strong>Session Billing Integration:</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Each completed session auto-adds to encounter bill (if linked to encounter)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">record_session</span><span class="token punctuation">(</span>care_plan_id<span class="token punctuation">:</span> UUID<span class="token punctuation">,</span> session_data<span class="token punctuation">:</span> PhysioSessionCreate<span class="token punctuation">)</span><span class="token punctuation">:</span>
    session <span class="token operator">=</span> <span class="token keyword">await</span> create_session<span class="token punctuation">(</span>care_plan_id<span class="token punctuation">,</span> session_data<span class="token punctuation">)</span>
    <span class="token keyword">if</span> session<span class="token punctuation">.</span>care_plan<span class="token punctuation">.</span>encounter_id <span class="token operator">and</span> session<span class="token punctuation">.</span>charge_amount<span class="token punctuation">:</span>
        <span class="token keyword">await</span> create_bill_line_item<span class="token punctuation">(</span>
            bill_id<span class="token operator">=</span>encounter<span class="token punctuation">.</span>bill_id<span class="token punctuation">,</span>
            charge_type<span class="token operator">=</span><span class="token string">"physiotherapy"</span><span class="token punctuation">,</span>
            description<span class="token operator">=</span>f<span class="token string">"Physio Session #{session.session_number} - {session.session_date}"</span><span class="token punctuation">,</span>
            unit_price<span class="token operator">=</span>session<span class="token punctuation">.</span>charge_amount<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token keyword">return</span> session
</code></pre>
<hr>
<h3 id="module-12-accounting">6.12 Module 12: Accounting</h3>
<p><strong>Routes prefix:</strong> <code>/api/accounting</code></p>

<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>Permission</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td><code>/dashboard</code></td>
<td>accounting:read</td>
<td>Daily cashflow summary</td>
</tr>
<tr>
<td>GET</td>
<td><code>/income</code></td>
<td>accounting:read</td>
<td>Income by period and category</td>
</tr>
<tr>
<td>GET</td>
<td><code>/expenses</code></td>
<td>accounting:read</td>
<td>Expenses list</td>
</tr>
<tr>
<td>POST</td>
<td><code>/expenses</code></td>
<td>accounting:write</td>
<td>Record new expense</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/expenses/{id}</code></td>
<td>accounting:write</td>
<td>Edit draft expense</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/expenses/{id}/approve</code></td>
<td>accounting:approve</td>
<td>Approve expense</td>
</tr>
<tr>
<td>GET</td>
<td><code>/pl</code></td>
<td>accounting:read</td>
<td>P&amp;L summary for period</td>
</tr>
<tr>
<td>GET</td>
<td><code>/daily-sales</code></td>
<td>accounting:read</td>
<td>Daily sales report</td>
</tr>
<tr>
<td>GET</td>
<td><code>/periods</code></td>
<td>accounting:read</td>
<td>Accounting periods</td>
</tr>
<tr>
<td>POST</td>
<td><code>/periods</code></td>
<td>accounting:admin</td>
<td>Create new accounting period</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/periods/{id}/close</code></td>
<td>accounting:admin</td>
<td>Close period</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/periods/{id}/lock</code></td>
<td>accounting:admin</td>
<td>Lock period permanently</td>
</tr>
<tr>
<td>GET</td>
<td><code>/export</code></td>
<td>accounting:export</td>
<td>Export to CSV or XLSX</td>
</tr>
</tbody>
</table><p><strong>P&amp;L Summary Structure:</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_pl_summary</span><span class="token punctuation">(</span>entity_id<span class="token punctuation">:</span> UUID<span class="token punctuation">,</span> start_date<span class="token punctuation">:</span> date<span class="token punctuation">,</span> end_date<span class="token punctuation">:</span> date<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> PLReport<span class="token punctuation">:</span>
    <span class="token comment"># REVENUE (from Transaction model, grouped by type)</span>
    revenue <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">"consultation"</span><span class="token punctuation">:</span>  <span class="token builtin">sum</span> of CONSULTATION_FEE transactions<span class="token punctuation">,</span>
        <span class="token string">"pharmacy"</span><span class="token punctuation">:</span>      <span class="token builtin">sum</span> of PHARMACY_SALE transactions<span class="token punctuation">,</span>
        <span class="token string">"lab"</span><span class="token punctuation">:</span>           <span class="token builtin">sum</span> of LAB_CHARGE transactions<span class="token punctuation">,</span>
        <span class="token string">"bed_charges"</span><span class="token punctuation">:</span>   <span class="token builtin">sum</span> of BED_CHARGE transactions<span class="token punctuation">,</span>
        <span class="token string">"procedures"</span><span class="token punctuation">:</span>    <span class="token builtin">sum</span> of PROCEDURE_CHARGE transactions<span class="token punctuation">,</span>
        <span class="token string">"insurance"</span><span class="token punctuation">:</span>     <span class="token builtin">sum</span> of INSURANCE_PAYMENT transactions<span class="token punctuation">,</span>
        <span class="token string">"total_revenue"</span><span class="token punctuation">:</span> <span class="token builtin">sum</span> of <span class="token builtin">all</span> above<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># COST OF GOODS SOLD (pharmacy purchase cost for dispensed drugs)</span>
    cogs <span class="token operator">=</span> <span class="token builtin">sum</span> of <span class="token punctuation">(</span>batch<span class="token punctuation">.</span>purchase_price × quantity_dispensed<span class="token punctuation">)</span> <span class="token keyword">for</span> period

    <span class="token comment"># GROSS PROFIT</span>
    gross_profit <span class="token operator">=</span> revenue<span class="token punctuation">[</span><span class="token string">"total_revenue"</span><span class="token punctuation">]</span> <span class="token operator">-</span> cogs

    <span class="token comment"># OPERATING EXPENSES (from Expense model)</span>
    expenses <span class="token operator">=</span> group_by_category<span class="token punctuation">(</span>
        Expense<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>entity_id<span class="token punctuation">,</span> date_range<span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token string">"approved"</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># NET PROFIT</span>
    net_profit <span class="token operator">=</span> gross_profit <span class="token operator">-</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>expenses<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> PLReport<span class="token punctuation">(</span>revenue<span class="token operator">=</span>revenue<span class="token punctuation">,</span> cogs<span class="token operator">=</span>cogs<span class="token punctuation">,</span> expenses<span class="token operator">=</span>expenses<span class="token punctuation">,</span>
                    gross_profit<span class="token operator">=</span>gross_profit<span class="token punctuation">,</span> net_profit<span class="token operator">=</span>net_profit<span class="token punctuation">)</span>
</code></pre>
<p><strong>Data Export:</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># GET /api/accounting/export?report=daily_sales&amp;from=2026-02-01&amp;to=2026-02-28&amp;format=xlsx</span>
<span class="token comment"># GET /api/accounting/export?report=pl&amp;from=2026-01-01&amp;to=2026-12-31&amp;format=csv</span>
<span class="token comment"># GET /api/reports/export?report=outstanding_balances&amp;format=csv</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">export_report</span><span class="token punctuation">(</span>report<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> from_date<span class="token punctuation">:</span> date<span class="token punctuation">,</span> to_date<span class="token punctuation">:</span> date<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> <span class="token keyword">await</span> generate_report_data<span class="token punctuation">(</span>report<span class="token punctuation">,</span> from_date<span class="token punctuation">,</span> to_date<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">format</span> <span class="token operator">==</span> <span class="token string">"csv"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> StreamingResponse<span class="token punctuation">(</span>to_csv<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> media_type<span class="token operator">=</span><span class="token string">"text/csv"</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> <span class="token builtin">format</span> <span class="token operator">==</span> <span class="token string">"xlsx"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> StreamingResponse<span class="token punctuation">(</span>to_xlsx<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> media_type<span class="token operator">=</span><span class="token string">"application/vnd.openxmlformats..."</span><span class="token punctuation">)</span>
</code></pre>
<hr>
<h2 id="frontend-architecture">7. Frontend Architecture</h2>
<h3 id="design-system--theme">7.1 Design System &amp; Theme</h3>
<p>The HMIS UI follows a <strong>minimal medical</strong> design language — clean, data-dense, and professional with a clinical color vocabulary.</p>
<h4 id="brand-identity">Brand Identity</h4>
<ul>
<li><strong>Brand Motif:</strong> Minimal medical cross/shield combined with a pulse line — communicating both health and technology</li>
<li><strong>Icon Library:</strong> <a href="https://lucide.dev/">Lucide Vue</a> — stroke-based icons with consistent weight, no fill, medical-friendly</li>
<li><strong>Border Radius:</strong> <code>12px</code> across all cards, modals, buttons, and inputs for a soft, approachable feel</li>
<li><strong>Data Hierarchy:</strong> Strong typographic contrast — headings are bold and prominent, labels are small and muted, values are clear and readable</li>
</ul>
<h4 id="typography">Typography</h4>

<table>
<thead>
<tr>
<th>Usage</th>
<th>Font</th>
<th>Weight</th>
<th>Size</th>
</tr>
</thead>
<tbody>
<tr>
<td>Page Titles</td>
<td>Inter Semibold</td>
<td>600</td>
<td>24px</td>
</tr>
<tr>
<td>Section Headers</td>
<td>Inter / Nunito</td>
<td>600</td>
<td>20px</td>
</tr>
<tr>
<td>Card Headers</td>
<td>Inter</td>
<td>600</td>
<td>16px</td>
</tr>
<tr>
<td>Body Text</td>
<td>Inter</td>
<td>400</td>
<td>14px</td>
</tr>
<tr>
<td>Labels / Captions</td>
<td>Inter</td>
<td>400</td>
<td>12px</td>
</tr>
</tbody>
</table><p>Install fonts via Google Fonts or local assets:</p>
<pre class=" language-html"><code class="prism  language-html"><span class="token comment">&lt;!-- index.html --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>preconnect<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://fonts.googleapis.com<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;family=Nunito:wght@400;600;700&amp;display=swap<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h4 id="color-palette">Color Palette</h4>

<table>
<thead>
<tr>
<th>Token</th>
<th>Name</th>
<th>Hex</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>primary</code></td>
<td>Deep Medical Green</td>
<td><code>#1F7A4C</code></td>
<td>Primary actions, active states, brand accents, nav highlights</td>
</tr>
<tr>
<td><code>secondary</code></td>
<td>Professional Blue</td>
<td><code>#2563EB</code></td>
<td>Links, info badges, secondary CTAs</td>
</tr>
<tr>
<td><code>background</code></td>
<td>Soft Gray</td>
<td><code>#F8FAFC</code></td>
<td>Page background, sidebar background</td>
</tr>
<tr>
<td><code>surface</code></td>
<td>White</td>
<td><code>#FFFFFF</code></td>
<td>Cards, modals, panels, dropdowns</td>
</tr>
<tr>
<td><code>border</code></td>
<td>Light Gray</td>
<td><code>#E2E8F0</code></td>
<td>Card borders, table dividers, input borders</td>
</tr>
<tr>
<td><code>text-primary</code></td>
<td>Dark Slate</td>
<td><code>#0F172A</code></td>
<td>Headings, primary text</td>
</tr>
<tr>
<td><code>text-muted</code></td>
<td>Slate</td>
<td><code>#64748B</code></td>
<td>Labels, captions, helper text</td>
</tr>
<tr>
<td><code>warning</code></td>
<td>Amber</td>
<td><code>#F97316</code></td>
<td>Pending states, expiry alerts</td>
</tr>
<tr>
<td><code>error</code></td>
<td>Red</td>
<td><code>#DC2626</code></td>
<td>Critical lab values, form errors</td>
</tr>
<tr>
<td><code>success</code></td>
<td>Green</td>
<td><code>#16A34A</code></td>
<td>Paid status, completed states</td>
</tr>
</tbody>
</table><h4 id="tailwind-theme-configuration">Tailwind Theme Configuration</h4>
<pre class=" language-typescript"><code class="prism  language-typescript"><span class="token comment">// tailwind.config.ts</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> Config <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'tailwindcss'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  content<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'./src/**/*.{vue,ts,tsx}'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  theme<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    extend<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      colors<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        primary<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          DEFAULT<span class="token punctuation">:</span> <span class="token string">'#1F7A4C'</span><span class="token punctuation">,</span>
          <span class="token number">50</span><span class="token punctuation">:</span>  <span class="token string">'#E8F5EE'</span><span class="token punctuation">,</span>
          <span class="token number">100</span><span class="token punctuation">:</span> <span class="token string">'#C5E6D3'</span><span class="token punctuation">,</span>
          <span class="token number">200</span><span class="token punctuation">:</span> <span class="token string">'#9DD4B5'</span><span class="token punctuation">,</span>
          <span class="token number">300</span><span class="token punctuation">:</span> <span class="token string">'#6DC197'</span><span class="token punctuation">,</span>
          <span class="token number">400</span><span class="token punctuation">:</span> <span class="token string">'#3EAE78'</span><span class="token punctuation">,</span>
          <span class="token number">500</span><span class="token punctuation">:</span> <span class="token string">'#1F7A4C'</span><span class="token punctuation">,</span>
          <span class="token number">600</span><span class="token punctuation">:</span> <span class="token string">'#1A6641'</span><span class="token punctuation">,</span>
          <span class="token number">700</span><span class="token punctuation">:</span> <span class="token string">'#145135'</span><span class="token punctuation">,</span>
          <span class="token number">800</span><span class="token punctuation">:</span> <span class="token string">'#0E3D28'</span><span class="token punctuation">,</span>
          <span class="token number">900</span><span class="token punctuation">:</span> <span class="token string">'#08291A'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        secondary<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          DEFAULT<span class="token punctuation">:</span> <span class="token string">'#2563EB'</span><span class="token punctuation">,</span>
          <span class="token number">50</span><span class="token punctuation">:</span>  <span class="token string">'#EFF6FF'</span><span class="token punctuation">,</span>
          <span class="token number">100</span><span class="token punctuation">:</span> <span class="token string">'#DBEAFE'</span><span class="token punctuation">,</span>
          <span class="token number">500</span><span class="token punctuation">:</span> <span class="token string">'#2563EB'</span><span class="token punctuation">,</span>
          <span class="token number">600</span><span class="token punctuation">:</span> <span class="token string">'#1D4ED8'</span><span class="token punctuation">,</span>
          <span class="token number">700</span><span class="token punctuation">:</span> <span class="token string">'#1E40AF'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        background<span class="token punctuation">:</span> <span class="token string">'#F8FAFC'</span><span class="token punctuation">,</span>
        surface<span class="token punctuation">:</span> <span class="token string">'#FFFFFF'</span><span class="token punctuation">,</span>
        border<span class="token punctuation">:</span> <span class="token string">'#E2E8F0'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      borderRadius<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        DEFAULT<span class="token punctuation">:</span> <span class="token string">'12px'</span><span class="token punctuation">,</span>
        sm<span class="token punctuation">:</span> <span class="token string">'8px'</span><span class="token punctuation">,</span>
        md<span class="token punctuation">:</span> <span class="token string">'12px'</span><span class="token punctuation">,</span>
        lg<span class="token punctuation">:</span> <span class="token string">'16px'</span><span class="token punctuation">,</span>
        xl<span class="token punctuation">:</span> <span class="token string">'20px'</span><span class="token punctuation">,</span>
        <span class="token string">'2xl'</span><span class="token punctuation">:</span> <span class="token string">'24px'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      fontFamily<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        sans<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'Inter'</span><span class="token punctuation">,</span> <span class="token string">'Nunito'</span><span class="token punctuation">,</span> <span class="token string">'ui-sans-serif'</span><span class="token punctuation">,</span> <span class="token string">'system-ui'</span><span class="token punctuation">,</span> <span class="token string">'sans-serif'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      boxShadow<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        card<span class="token punctuation">:</span> <span class="token string">'0 1px 3px 0 rgb(0 0 0 / 0.08), 0 1px 2px -1px rgb(0 0 0 / 0.06)'</span><span class="token punctuation">,</span>
        <span class="token string">'card-hover'</span><span class="token punctuation">:</span> <span class="token string">'0 4px 12px 0 rgb(0 0 0 / 0.10)'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> satisfies Config
</code></pre>
<h4 id="standard-card-component-pattern">Standard Card Component Pattern</h4>
<p>All data panels use white modular cards with a consistent structure:</p>
<pre class=" language-vue"><code class="prism  language-vue">&lt;!-- components/ui/AppCard.vue --&gt;
&lt;template&gt;
  &lt;div class="bg-white rounded-xl border border-border shadow-card p-5"&gt;
    &lt;div v-if="$slots.header" class="flex items-center justify-between mb-4"&gt;
      &lt;slot name="header" /&gt;
    &lt;/div&gt;
    &lt;slot /&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<p>Usage:</p>
<pre class=" language-vue"><code class="prism  language-vue">&lt;AppCard&gt;
  &lt;template #header&gt;
    &lt;h3 class="text-base font-semibold text-slate-900"&gt;Today's Queue&lt;/h3&gt;
    &lt;span class="text-xs text-slate-500"&gt;24 patients&lt;/span&gt;
  &lt;/template&gt;
  &lt;!-- card content --&gt;
&lt;/AppCard&gt;
</code></pre>
<hr>
<h3 id="data-tables-rv-grid">7.2 Data Tables: rv-grid</h3>
<p>All tabular data in the HMIS uses <strong><a href="https://rv-grid.com/guide/vue3/">rv-grid</a></strong> — a high-performance Vue 3 data grid — instead of custom-built table components.</p>
<h4 id="installation">Installation</h4>
<pre class=" language-bash"><code class="prism  language-bash"><span class="token function">npm</span> <span class="token function">install</span> rv-grid
</code></pre>
<h4 id="setup">Setup</h4>
<pre class=" language-typescript"><code class="prism  language-typescript"><span class="token comment">// src/main.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> RvGrid <span class="token keyword">from</span> <span class="token string">'rv-grid'</span>
<span class="token keyword">import</span> <span class="token string">'rv-grid/dist/style.css'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>RvGrid<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="custom-theme-hmis-palette">Custom Theme (HMIS palette)</h4>
<p>Override rv-grid CSS variables to match the HMIS design system:</p>
<pre class=" language-css"><code class="prism  language-css"><span class="token comment">/* src/assets/rv-grid-theme.css — import after rv-grid/dist/style.css */</span>
<span class="token selector"><span class="token class">.rv-grid</span> </span><span class="token punctuation">{</span>
  <span class="token property">--rv-primary</span><span class="token punctuation">:</span>           <span class="token hexcode">#1F7A4C</span><span class="token punctuation">;</span>
  <span class="token property">--rv-primary-light</span><span class="token punctuation">:</span>     <span class="token hexcode">#E8F5EE</span><span class="token punctuation">;</span>
  <span class="token property">--rv-header-bg</span><span class="token punctuation">:</span>         <span class="token hexcode">#F8FAFC</span><span class="token punctuation">;</span>
  <span class="token property">--rv-header-color</span><span class="token punctuation">:</span>      <span class="token hexcode">#64748B</span><span class="token punctuation">;</span>
  <span class="token property">--rv-header-font-size</span><span class="token punctuation">:</span>  <span class="token number">12</span>px<span class="token punctuation">;</span>
  <span class="token property">--rv-header-font-weight</span><span class="token punctuation">:</span> <span class="token number">600</span><span class="token punctuation">;</span>
  <span class="token property">--rv-border-color</span><span class="token punctuation">:</span>      <span class="token hexcode">#E2E8F0</span><span class="token punctuation">;</span>
  <span class="token property">--rv-row-hover</span><span class="token punctuation">:</span>         <span class="token hexcode">#F0FAF5</span><span class="token punctuation">;</span>
  <span class="token property">--rv-row-selected</span><span class="token punctuation">:</span>      <span class="token hexcode">#E8F5EE</span><span class="token punctuation">;</span>
  <span class="token property">--rv-font-family</span><span class="token punctuation">:</span>       <span class="token string">'Inter'</span>, sans-serif<span class="token punctuation">;</span>
  <span class="token property">--rv-font-size</span><span class="token punctuation">:</span>         <span class="token number">14</span>px<span class="token punctuation">;</span>
  <span class="token property">--rv-border-radius</span><span class="token punctuation">:</span>     <span class="token number">12</span>px<span class="token punctuation">;</span>
  <span class="token property">--rv-cell-padding</span><span class="token punctuation">:</span>      <span class="token number">10</span>px <span class="token number">14</span>px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="usage-example-—-opd-queue">Usage Example — OPD Queue</h4>
<pre class=" language-vue"><code class="prism  language-vue">&lt;!-- pages/opd/OPDQueuePage.vue --&gt;
&lt;template&gt;
  &lt;AppCard&gt;
    &lt;template #header&gt;
      &lt;h3 class="text-base font-semibold"&gt;OPD Queue&lt;/h3&gt;
      &lt;span class="text-xs text-slate-500 font-medium"&gt;
        {{ queue.length }} patients waiting
      &lt;/span&gt;
    &lt;/template&gt;

    &lt;RvGrid
      :columns="columns"
      :data="queue"
      :loading="loading"
      :pagination="{ pageSize: 25 }"
      row-key="id"
      @row-click="openEncounter"
    /&gt;
  &lt;/AppCard&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import type { RvGridColumn } from 'rv-grid'
import { useOpdQueueStore } from '@/stores/queue/opdQueueStore'

const store = useOpdQueueStore()
const { queue, loading } = storeToRefs(store)

const columns: RvGridColumn[] = [
  { field: 'queue_number', header: '#', width: 60, align: 'center' },
  { field: 'patient_name', header: 'Patient', sortable: true, minWidth: 180 },
  { field: 'age_gender',   header: 'Age/Sex', width: 80 },
  {
    field: 'priority',
    header: 'Priority',
    width: 100,
    render: (row) =&gt; h(PriorityBadge, { priority: row.priority }),
  },
  { field: 'check_in_time', header: 'Check-In', sortable: true, width: 110 },
  { field: 'wait_minutes',  header: 'Wait', width: 70, align: 'right' },
  { field: 'status',        header: 'Status', width: 130 },
  { field: 'actions',       header: '', width: 100, fixed: 'right' },
]

function openEncounter(row: any) {
  router.push(`/opd/encounters/${row.encounter_id}`)
}
&lt;/script&gt;
</code></pre>
<h4 id="rv-grid-usage-by-module">rv-grid Usage by Module</h4>

<table>
<thead>
<tr>
<th>Module</th>
<th>Grid Instance</th>
<th>Key Columns</th>
</tr>
</thead>
<tbody>
<tr>
<td>OPD</td>
<td>OPD Queue</td>
<td>Queue#, Patient, Priority, Wait time, Status</td>
</tr>
<tr>
<td>Patient Search</td>
<td>Results list</td>
<td>Patient#, Name, DOB, Phone, Last visit</td>
</tr>
<tr>
<td>Lab</td>
<td>Orders queue</td>
<td>Order#, Patient, Tests, Priority, Status</td>
</tr>
<tr>
<td>Pharmacy</td>
<td>Dispensing queue</td>
<td>Rx#, Patient, Doctor, Items, Status</td>
</tr>
<tr>
<td>IPD</td>
<td>Admissions list</td>
<td>Adm#, Patient, Ward/Bed, Doctor, Days</td>
</tr>
<tr>
<td>Billing</td>
<td>Bill line items</td>
<td>Description, Qty, Unit price, Total</td>
</tr>
<tr>
<td>Insurance</td>
<td>Claims list</td>
<td>Claim#, Patient, Scheme, Amount, Status</td>
</tr>
<tr>
<td>Reports</td>
<td>Drug consumption</td>
<td>Drug name, Qty dispensed, Value</td>
</tr>
</tbody>
</table><hr>
<h3 id="layout-structure">7.3 Layout Structure</h3>
<pre><code>AppLayout.vue (Main application shell)
├── Sidebar navigation (module-based, role-aware)
├── Top navigation bar (entity switcher, user menu, notifications)
└── Router view

HospitalLayout.vue (Clinical workspace)
├── Shared patient banner (shows when a patient is in context)
├── Clinical quick-actions toolbar
└── Module-specific content area
</code></pre>
<h3 id="route-groups">7.4 Route Groups</h3>
<pre class=" language-typescript"><code class="prism  language-typescript"><span class="token comment">// router/index.ts — Healthcare routes</span>
<span class="token punctuation">{</span>
  path<span class="token punctuation">:</span> <span class="token string">'/patients'</span><span class="token punctuation">,</span>
  component<span class="token punctuation">:</span> PatientsLayout<span class="token punctuation">,</span>
  children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> PatientSearchPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'register'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> PatientRegistrationPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">':id'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> PatientProfilePage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">':id/history'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> PatientHistoryPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
  path<span class="token punctuation">:</span> <span class="token string">'/opd'</span><span class="token punctuation">,</span>
  component<span class="token punctuation">:</span> OPDLayout<span class="token punctuation">,</span>
  children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'queue'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> OPDQueuePage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'encounters/:id'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> EncounterPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'encounters/:id/triage'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> TriagePage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'encounters/:id/consultation'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> ConsultationPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
  path<span class="token punctuation">:</span> <span class="token string">'/ipd'</span><span class="token punctuation">,</span>
  component<span class="token punctuation">:</span> IPDLayout<span class="token punctuation">,</span>
  children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'dashboard'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> WardDashboardPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'admissions'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> AdmissionsListPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'admissions/:id'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> AdmissionDetailPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'beds'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> BedManagementPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
  path<span class="token punctuation">:</span> <span class="token string">'/lab'</span><span class="token punctuation">,</span>
  component<span class="token punctuation">:</span> LabLayout<span class="token punctuation">,</span>
  children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'queue'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> LabQueuePage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'orders/:id'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> LabOrderPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'results'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> LabResultsPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
  path<span class="token punctuation">:</span> <span class="token string">'/pharmacy'</span><span class="token punctuation">,</span>
  component<span class="token punctuation">:</span> PharmacyLayout<span class="token punctuation">,</span>
  children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'queue'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> PharmacyQueuePage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'prescriptions/:id'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> PrescriptionPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'drugs'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> DrugCatalogPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
  path<span class="token punctuation">:</span> <span class="token string">'/billing'</span><span class="token punctuation">,</span>
  component<span class="token punctuation">:</span> BillingLayout<span class="token punctuation">,</span>
  children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'encounters'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> BillingQueuePage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'bills/:id'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> BillDetailPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'insurance/claims'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> InsuranceClaimsPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
  path<span class="token punctuation">:</span> <span class="token string">'/dental'</span><span class="token punctuation">,</span>
  component<span class="token punctuation">:</span> DentalLayout<span class="token punctuation">,</span>
  children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'queue'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> DentalQueuePage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'encounters/:id'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> DentalEncounterPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
  path<span class="token punctuation">:</span> <span class="token string">'/physiotherapy'</span><span class="token punctuation">,</span>
  component<span class="token punctuation">:</span> PhysioLayout<span class="token punctuation">,</span>
  children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'calendar'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> PhysioCalendarPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'care-plans'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> CareplanListPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'care-plans/:id'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> CareplanDetailPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'care-plans/:id/sessions/new'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> SessionRecordPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
  path<span class="token punctuation">:</span> <span class="token string">'/accounting'</span><span class="token punctuation">,</span>
  component<span class="token punctuation">:</span> AccountingLayout<span class="token punctuation">,</span>
  children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'dashboard'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> AccountingDashboardPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'expenses'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> ExpensesPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'pl'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> PLReportPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'periods'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> PeriodsPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// Patient Portal — separate auth context, minimal layout</span>
<span class="token punctuation">{</span>
  path<span class="token punctuation">:</span> <span class="token string">'/portal'</span><span class="token punctuation">,</span>
  component<span class="token punctuation">:</span> PortalLayout<span class="token punctuation">,</span>   <span class="token comment">// Minimal layout, no staff sidebar</span>
  meta<span class="token punctuation">:</span> <span class="token punctuation">{</span> requiresPortalAuth<span class="token punctuation">:</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'login'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> PortalLoginPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'dashboard'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> PortalDashboardPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'appointments'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> PortalAppointmentsPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'prescriptions'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> PortalPrescriptionsPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'bills'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> PortalBillsPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'bills/:id'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> PortalBillDetailPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'history'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> PortalHistoryPage <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="key-pinia-stores">7.5 Key Pinia Stores</h3>
<pre class=" language-typescript"><code class="prism  language-typescript"><span class="token comment">// stores/patient/patientStore.ts</span>
<span class="token comment">// - currentPatient: currently selected patient context</span>
<span class="token comment">// - searchResults, recentPatients</span>
<span class="token comment">// - registerPatient(), searchPatients(), selectPatient()</span>

<span class="token comment">// stores/encounter/encounterStore.ts</span>
<span class="token comment">// - currentEncounter: active encounter being processed</span>
<span class="token comment">// - encounterTimeline: all events for current encounter</span>
<span class="token comment">// - createEncounter(), updateTriage(), finalizeConsultation()</span>

<span class="token comment">// stores/queue/opdQueueStore.ts</span>
<span class="token comment">// - queue: OPD queue with real-time updates</span>
<span class="token comment">// - callNext(), refreshQueue()</span>
<span class="token comment">// WebSocket connected for live updates</span>

<span class="token comment">// stores/ward/wardStore.ts</span>
<span class="token comment">// - wards: list of wards with bed occupancy</span>
<span class="token comment">// - currentAdmission: selected admission</span>
<span class="token comment">// - bedMatrix: visual bed occupancy grid</span>

<span class="token comment">// stores/billing/billingStore.ts</span>
<span class="token comment">// - currentBill: bill being processed</span>
<span class="token comment">// - addLineItem(), processPayment(), submitInsuranceClaim()</span>
</code></pre>
<h3 id="component-directory">7.6 Component Directory</h3>
<pre><code>src/components/
│
├── ui/                          ← BASE DESIGN SYSTEM (reused everywhere)
│   ├── form/
│   │   ├── AppFormInput.vue     # Text/number/email/tel/password/date input
│   │   ├── AppFormSelect.vue    # Dropdown with search + region-aware variant
│   │   ├── AppFormTextarea.vue  # Resizable textarea
│   │   ├── AppFormCheckbox.vue  # Single checkbox with label
│   │   ├── AppFormRadioGroup.vue # Radio button group
│   │   ├── AppFormDatePicker.vue # Date picker (native + styled)
│   │   ├── AppFormSearch.vue    # Debounced search input with clear button
│   │   └── AppFormFileUpload.vue # Drag-and-drop / click file upload
│   │
│   ├── AppButton.vue            # Primary / secondary / ghost / danger / link
│   ├── AppIconButton.vue        # Icon-only button with tooltip
│   ├── AppLink.vue              # Styled router-link and external link
│   ├── AppCard.vue              # White modular card with header/footer slots
│   ├── AppMetricCard.vue        # KPI card: icon + value + label + trend delta
│   ├── AppBadge.vue             # Inline status/label chip (semantic colors)
│   ├── AppAvatar.vue            # Patient/user avatar with initials fallback
│   ├── AppModal.vue             # Centered dialog with backdrop
│   ├── AppConfirmModal.vue      # Confirm/cancel dialog (wraps AppModal)
│   ├── AppDrawer.vue            # Slide-in side panel
│   ├── AppToast.vue             # Toast notification (auto-dismiss)
│   ├── AppAlert.vue             # Inline banner: info / success / warning / error
│   ├── AppTabs.vue              # Tab bar with slot-based panels
│   ├── AppDropdown.vue          # Button-triggered dropdown menu
│   ├── AppTooltip.vue           # Hover tooltip wrapper
│   ├── AppSkeleton.vue          # Loading placeholder skeleton
│   ├── AppSpinner.vue           # Circular loading spinner
│   ├── AppProgress.vue          # Horizontal progress bar
│   ├── AppDivider.vue           # Horizontal rule with optional label
│   └── AppEmptyState.vue        # Empty list/table state with icon + message
│
├── patients/
│   ├── PatientCard.vue          # Summary card with photo/demographics
│   ├── PatientBanner.vue        # Top-of-screen patient context bar
│   ├── PatientSearch.vue        # Debounced search with live results list
│   ├── PatientQRPrint.vue       # Printable QR card for patient check-in
│   └── AllergyBadge.vue         # Color-coded allergy warning chip
│
├── clinical/
│   ├── VitalSigns.vue           # Vitals entry form with abnormal flag indicators
│   ├── DiagnosisSearch.vue      # ICD-10 code search with autocomplete
│   ├── PrescriptionBuilder.vue  # Drug prescription builder form
│   ├── SOAPEditor.vue           # SOAP notes structured text editor
│   └── ClinicalTimeline.vue     # Encounter event timeline (vertical)
│
├── ward/
│   ├── BedMatrix.vue            # Visual ward bed layout grid
│   ├── BedCard.vue              # Individual bed status card
│   ├── MARSheet.vue             # Medication Administration Record
│   └── NursingNote.vue          # Nursing note form
│
├── lab/
│   ├── LabOrderForm.vue         # Test ordering interface with panel grouping
│   ├── ResultEntryForm.vue      # Lab result entry with reference range display
│   └── ResultReport.vue         # Printable lab report
│
├── pharmacy/
│   ├── PrescriptionCard.vue     # Prescription with dispense action buttons
│   ├── DrugSearch.vue           # Drug catalog search with stock and batch info
│   └── DispensingForm.vue       # Dispensing quantity and batch entry
│
├── billing/
│   ├── BillSummary.vue          # Encounter bill with rv-grid line items
│   ├── PaymentForm.vue          # Multi-method payment entry
│   ├── InsuranceClaimForm.vue   # Insurance claim submission
│   ├── VoidRefundModal.vue      # Admin void/refund confirmation
│   └── ReceiptPrint.vue         # Printable payment receipt
│
├── dental/
│   ├── ToothChart.vue           # Interactive FDI tooth chart (SVG-based)
│   ├── ToothCard.vue            # Single tooth condition card
│   └── ProcedureForm.vue        # Dental procedure entry form
│
├── physio/
│   ├── CarePlanForm.vue         # New care plan creation
│   ├── SessionForm.vue          # Session recording with pain/function scores
│   └── SessionTimeline.vue      # Care plan session history
│
├── accounting/
│   ├── PLSummaryCard.vue        # Revenue / COGS / Expenses / Net Profit
│   ├── ExpenseForm.vue          # New expense entry
│   ├── DailySalesTable.vue      # rv-grid daily sales breakdown
│   └── PeriodControl.vue        # Open/close/lock period controls
│
└── portal/
    ├── PortalBillCard.vue        # Patient-facing bill with M-Pesa pay button
    ├── PortalAppointmentCard.vue # Appointment summary with cancel option
    ├── PortalPrescriptionCard.vue # Prescription read-only view
    └── MpesaPayButton.vue        # STK push initiator with status polling
</code></pre>
<hr>
<h3 id="base-ui-component-library">7.7 Base UI Component Library</h3>
<p>Every page in the HMIS is built from these base components. They encode the design system (colors, radius, typography, spacing) in one place — domain components never write raw Tailwind classes for layout/form/feedback patterns.</p>
<hr>
<h4 id="appforminput">AppFormInput</h4>
<p>The standard text input. Handles all <code>&lt;input&gt;</code> types, icon decoration, label, hint, and validation error state.</p>
<pre class=" language-vue"><code class="prism  language-vue">&lt;!-- Props --&gt;
&lt;AppFormInput
  v-model="form.phone"
  label="Phone Number"
  type="tel"
  placeholder="+254 7XX XXX XXX"
  :prefix-icon="Phone"           &lt;!-- Lucide icon component --&gt;
  hint="Primary contact number"
  :error="errors.phone"
  required
/&gt;

&lt;!-- Variants by state --&gt;
&lt;!-- Default  → border-border --&gt;
&lt;!-- Focus    → border-primary ring-2 ring-primary/20 --&gt;
&lt;!-- Error    → border-error ring-2 ring-error/20 + error message below --&gt;
&lt;!-- Disabled → bg-slate-50 text-slate-400 cursor-not-allowed --&gt;
</code></pre>
<pre class=" language-vue"><code class="prism  language-vue">&lt;!-- AppFormInput.vue — template skeleton --&gt;
&lt;template&gt;
  &lt;div class="flex flex-col gap-1"&gt;
    &lt;label v-if="label" :for="inputId" class="text-xs font-medium text-slate-600"&gt;
      {{ label }} &lt;span v-if="required" class="text-error"&gt;*&lt;/span&gt;
    &lt;/label&gt;
    &lt;div class="relative flex items-center"&gt;
      &lt;component :is="prefixIcon" v-if="prefixIcon"
        class="absolute left-3 size-4 text-slate-400 pointer-events-none" /&gt;
      &lt;input
        :id="inputId"
        v-bind="$attrs"
        :type="type"
        :value="modelValue"
        :class="inputClasses"
        @input="$emit('update:modelValue', $event.target.value)"
      /&gt;
    &lt;/div&gt;
    &lt;p v-if="error" class="text-xs text-error"&gt;{{ error }}&lt;/p&gt;
    &lt;p v-else-if="hint" class="text-xs text-slate-400"&gt;{{ hint }}&lt;/p&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<p><strong>All form inputs share the same base class:</strong></p>
<pre class=" language-typescript"><code class="prism  language-typescript"><span class="token comment">// composables/useInputClasses.ts</span>
<span class="token keyword">const</span> baseInput <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'w-full rounded-md border bg-white px-3 py-2'</span><span class="token punctuation">,</span>
  <span class="token string">'text-sm text-slate-900 placeholder:text-slate-400'</span><span class="token punctuation">,</span>
  <span class="token string">'transition-colors duration-150'</span><span class="token punctuation">,</span>
  <span class="token string">'focus:outline-none focus:ring-2'</span><span class="token punctuation">,</span>
  <span class="token string">'disabled:bg-slate-50 disabled:text-slate-400 disabled:cursor-not-allowed'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
<span class="token keyword">const</span> stateClasses <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token string">'border-border focus:border-primary focus:ring-primary/20'</span><span class="token punctuation">,</span>
  error<span class="token punctuation">:</span>   <span class="token string">'border-error focus:border-error focus:ring-error/20'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<hr>
<h4 id="appformselect">AppFormSelect</h4>
<p>Dropdown select with an optional searchable variant. Has a <code>region</code> mode that cascades County → Sub-county → Ward.</p>
<pre class=" language-vue"><code class="prism  language-vue">&lt;!-- Standard select --&gt;
&lt;AppFormSelect
  v-model="form.gender"
  label="Gender"
  :options="[
    { value: 'male',   label: 'Male' },
    { value: 'female', label: 'Female' },
    { value: 'other',  label: 'Other' },
  ]"
  placeholder="Select gender"
  :error="errors.gender"
/&gt;

&lt;!-- Searchable select (e.g., drug catalog, ICD-10) --&gt;
&lt;AppFormSelect
  v-model="form.drug_id"
  label="Drug"
  :options="drugOptions"
  searchable
  placeholder="Search drug name..."
/&gt;

&lt;!-- Region cascade — renders three linked selects --&gt;
&lt;AppRegionSelect
  v-model:county="form.county_id"
  v-model:sub-county="form.sub_county_id"
  v-model:ward="form.administrative_ward_id"
  required
/&gt;
</code></pre>
<p><code>AppRegionSelect</code> is a compound component that wraps three <code>AppFormSelect</code> instances. Selecting a county resets and loads the sub-county options; selecting a sub-county resets and loads wards. Region data is fetched once on mount and cached in a <code>useRegionsStore</code> (no auth required).</p>
<hr>
<h4 id="appbutton">AppButton</h4>
<pre class=" language-vue"><code class="prism  language-vue">&lt;!-- Variants --&gt;
&lt;AppButton variant="primary"&gt;Save Patient&lt;/AppButton&gt;
&lt;AppButton variant="secondary"&gt;Cancel&lt;/AppButton&gt;
&lt;AppButton variant="ghost"&gt;View History&lt;/AppButton&gt;
&lt;AppButton variant="danger"&gt;Void Invoice&lt;/AppButton&gt;
&lt;AppButton variant="link"&gt;See all results →&lt;/AppButton&gt;

&lt;!-- Sizes --&gt;
&lt;AppButton size="sm"&gt;Add Item&lt;/AppButton&gt;   &lt;!-- h-8,  text-xs  --&gt;
&lt;AppButton size="md"&gt;Submit&lt;/AppButton&gt;      &lt;!-- h-9,  text-sm  (default) --&gt;
&lt;AppButton size="lg"&gt;Register Patient&lt;/AppButton&gt;  &lt;!-- h-11, text-sm  --&gt;

&lt;!-- States --&gt;
&lt;AppButton :loading="isSaving"&gt;Saving...&lt;/AppButton&gt;   &lt;!-- spinner replaces icon --&gt;
&lt;AppButton disabled&gt;Finalized&lt;/AppButton&gt;

&lt;!-- With Lucide icon --&gt;
&lt;AppButton variant="primary" :icon="Plus"&gt;Add Drug&lt;/AppButton&gt;
&lt;AppButton variant="ghost" :icon="Download" icon-position="right"&gt;Export&lt;/AppButton&gt;
</code></pre>
<pre class=" language-typescript"><code class="prism  language-typescript"><span class="token comment">// Props interface</span>
<span class="token keyword">interface</span> <span class="token class-name">AppButtonProps</span> <span class="token punctuation">{</span>
  variant<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">'primary'</span> <span class="token operator">|</span> <span class="token string">'secondary'</span> <span class="token operator">|</span> <span class="token string">'ghost'</span> <span class="token operator">|</span> <span class="token string">'danger'</span> <span class="token operator">|</span> <span class="token string">'link'</span>
  size<span class="token operator">?</span><span class="token punctuation">:</span>    <span class="token string">'sm'</span> <span class="token operator">|</span> <span class="token string">'md'</span> <span class="token operator">|</span> <span class="token string">'lg'</span>
  icon<span class="token operator">?</span><span class="token punctuation">:</span>    Component       <span class="token comment">// Lucide icon component</span>
  iconPosition<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">'left'</span> <span class="token operator">|</span> <span class="token string">'right'</span>
  loading<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">boolean</span>
  disabled<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">boolean</span>
  <span class="token keyword">type</span><span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">'button'</span> <span class="token operator">|</span> <span class="token string">'submit'</span> <span class="token operator">|</span> <span class="token string">'reset'</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>Variant styles:</strong></p>

<table>
<thead>
<tr>
<th>Variant</th>
<th>Background</th>
<th>Text</th>
<th>Border</th>
<th>Hover</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>primary</code></td>
<td><code>bg-primary</code></td>
<td><code>text-white</code></td>
<td>—</td>
<td><code>bg-primary-600</code></td>
</tr>
<tr>
<td><code>secondary</code></td>
<td><code>bg-white</code></td>
<td><code>text-primary</code></td>
<td><code>border-primary</code></td>
<td><code>bg-primary-50</code></td>
</tr>
<tr>
<td><code>ghost</code></td>
<td>transparent</td>
<td><code>text-slate-600</code></td>
<td>—</td>
<td><code>bg-slate-100</code></td>
</tr>
<tr>
<td><code>danger</code></td>
<td><code>bg-error</code></td>
<td><code>text-white</code></td>
<td>—</td>
<td><code>bg-red-700</code></td>
</tr>
<tr>
<td><code>link</code></td>
<td>transparent</td>
<td><code>text-secondary</code></td>
<td>—</td>
<td>underline</td>
</tr>
</tbody>
</table><hr>
<h4 id="appiconbutton">AppIconButton</h4>
<p>For toolbar actions, table row actions, and close buttons.</p>
<pre class=" language-vue"><code class="prism  language-vue">&lt;AppIconButton :icon="Edit" tooltip="Edit patient" @click="onEdit" /&gt;
&lt;AppIconButton :icon="Trash2" tooltip="Remove" variant="danger" size="sm" /&gt;
&lt;AppIconButton :icon="X" tooltip="Close" @click="modal.close()" /&gt;
</code></pre>
<hr>
<h4 id="applink">AppLink</h4>
<p>Wraps <code>RouterLink</code> (internal) and <code>&lt;a&gt;</code> (external) with consistent styling.</p>
<pre class=" language-vue"><code class="prism  language-vue">&lt;!-- Internal navigation --&gt;
&lt;AppLink to="/patients/123"&gt;View Patient Profile&lt;/AppLink&gt;

&lt;!-- External link (opens in new tab, adds external icon automatically) --&gt;
&lt;AppLink href="https://nhif.or.ke" external&gt;NHIF Portal&lt;/AppLink&gt;

&lt;!-- Variants --&gt;
&lt;AppLink variant="default"&gt;Default blue underline&lt;/AppLink&gt;
&lt;AppLink variant="subtle"&gt;Muted, underline on hover&lt;/AppLink&gt;
&lt;AppLink variant="nav"&gt;Sidebar nav item style&lt;/AppLink&gt;
</code></pre>
<hr>
<h4 id="appcard">AppCard</h4>
<p>The foundational white panel used across all modules.</p>
<pre class=" language-vue"><code class="prism  language-vue">&lt;AppCard&gt;
  &lt;!-- Minimal — content only --&gt;
  &lt;p&gt;Card content&lt;/p&gt;
&lt;/AppCard&gt;

&lt;AppCard padding="none"&gt;
  &lt;!-- Full-bleed content (e.g., a table that extends to card edges) --&gt;
  &lt;RvGrid :columns="cols" :data="rows" /&gt;
&lt;/AppCard&gt;

&lt;AppCard&gt;
  &lt;template #header&gt;
    &lt;h3 class="text-sm font-semibold text-slate-900"&gt;Patient Queue&lt;/h3&gt;
    &lt;AppBadge variant="primary"&gt;24 waiting&lt;/AppBadge&gt;
  &lt;/template&gt;

  &lt;!-- card body --&gt;

  &lt;template #footer&gt;
    &lt;AppLink to="/opd/queue"&gt;View full queue →&lt;/AppLink&gt;
  &lt;/template&gt;
&lt;/AppCard&gt;
</code></pre>
<pre class=" language-typescript"><code class="prism  language-typescript"><span class="token keyword">interface</span> <span class="token class-name">AppCardProps</span> <span class="token punctuation">{</span>
  padding<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">'default'</span> <span class="token operator">|</span> <span class="token string">'sm'</span> <span class="token operator">|</span> <span class="token string">'lg'</span> <span class="token operator">|</span> <span class="token string">'none'</span>
  shadow<span class="token operator">?</span><span class="token punctuation">:</span>  <span class="token string">'default'</span> <span class="token operator">|</span> <span class="token string">'none'</span> <span class="token operator">|</span> <span class="token string">'lg'</span>
  border<span class="token operator">?</span><span class="token punctuation">:</span>  <span class="token keyword">boolean</span>  <span class="token comment">// default: true</span>
<span class="token punctuation">}</span>
<span class="token comment">// Slots: default (body), header, footer</span>
</code></pre>
<hr>
<h4 id="appmetriccard">AppMetricCard</h4>
<p>KPI cards for dashboards. Displays an icon, a primary metric value, a label, and an optional trend indicator.</p>
<pre class=" language-vue"><code class="prism  language-vue">&lt;AppMetricCard
  label="Today's Patients"
  :value="stats.total_visits"
  :icon="Users"
  icon-color="primary"
  :trend="{ value: 12, direction: 'up', label: 'vs yesterday' }"
/&gt;

&lt;AppMetricCard
  label="Outstanding Balance"
  :value="formatCurrency(stats.outstanding)"
  :icon="AlertCircle"
  icon-color="warning"
/&gt;

&lt;AppMetricCard
  label="Bed Occupancy"
  :value="`${stats.occupancy_pct}%`"
  :icon="BedDouble"
  icon-color="secondary"
  :trend="{ value: 5, direction: 'down', label: 'vs last week' }"
/&gt;
</code></pre>
<pre class=" language-typescript"><code class="prism  language-typescript"><span class="token keyword">interface</span> <span class="token class-name">AppMetricCardProps</span> <span class="token punctuation">{</span>
  label<span class="token punctuation">:</span>      <span class="token keyword">string</span>
  value<span class="token punctuation">:</span>      <span class="token keyword">string</span> <span class="token operator">|</span> <span class="token keyword">number</span>
  icon<span class="token punctuation">:</span>       Component            <span class="token comment">// Lucide icon</span>
  iconColor<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">'primary'</span> <span class="token operator">|</span> <span class="token string">'secondary'</span> <span class="token operator">|</span> <span class="token string">'warning'</span> <span class="token operator">|</span> <span class="token string">'error'</span> <span class="token operator">|</span> <span class="token string">'slate'</span>
  trend<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span>     <span class="token keyword">number</span>              <span class="token comment">// absolute or percentage change</span>
    direction<span class="token punctuation">:</span> <span class="token string">'up'</span> <span class="token operator">|</span> <span class="token string">'down'</span> <span class="token operator">|</span> <span class="token string">'flat'</span>
    label<span class="token operator">?</span><span class="token punctuation">:</span>    <span class="token keyword">string</span>              <span class="token comment">// "vs yesterday"</span>
    isGoodWhenUp<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">boolean</span>         <span class="token comment">// default true; false for e.g. "outstanding bills"</span>
  <span class="token punctuation">}</span>
  loading<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">boolean</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>Layout:</strong></p>
<pre><code>┌─────────────────────────────────────────┐
│  [Icon bg]    Today's Patients          │
│               ─────────────────         │
│               128                       │
│               ↑ 12 vs yesterday         │
└─────────────────────────────────────────┘
</code></pre>
<hr>
<h4 id="appbadge">AppBadge</h4>
<p>Status chips used throughout clinical and billing workflows.</p>
<pre class=" language-vue"><code class="prism  language-vue">&lt;!-- Semantic variants --&gt;
&lt;AppBadge variant="success"&gt;Paid&lt;/AppBadge&gt;
&lt;AppBadge variant="warning"&gt;Pending&lt;/AppBadge&gt;
&lt;AppBadge variant="error"&gt;Critical&lt;/AppBadge&gt;
&lt;AppBadge variant="info"&gt;In Progress&lt;/AppBadge&gt;
&lt;AppBadge variant="neutral"&gt;Draft&lt;/AppBadge&gt;
&lt;AppBadge variant="primary"&gt;Active&lt;/AppBadge&gt;

&lt;!-- With dot indicator --&gt;
&lt;AppBadge variant="success" dot&gt;Online&lt;/AppBadge&gt;

&lt;!-- Sizes --&gt;
&lt;AppBadge size="sm"&gt;urgent&lt;/AppBadge&gt;
&lt;AppBadge size="md"&gt;routine&lt;/AppBadge&gt;   &lt;!-- default --&gt;
</code></pre>
<p><strong>Color mapping:</strong></p>

<table>
<thead>
<tr>
<th>Variant</th>
<th>Background</th>
<th>Text</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>success</code></td>
<td><code>bg-green-100</code></td>
<td><code>text-green-700</code></td>
</tr>
<tr>
<td><code>warning</code></td>
<td><code>bg-orange-100</code></td>
<td><code>text-orange-700</code></td>
</tr>
<tr>
<td><code>error</code></td>
<td><code>bg-red-100</code></td>
<td><code>text-red-700</code></td>
</tr>
<tr>
<td><code>info</code></td>
<td><code>bg-blue-100</code></td>
<td><code>text-blue-700</code></td>
</tr>
<tr>
<td><code>primary</code></td>
<td><code>bg-primary-50</code></td>
<td><code>text-primary-700</code></td>
</tr>
<tr>
<td><code>neutral</code></td>
<td><code>bg-slate-100</code></td>
<td><code>text-slate-600</code></td>
</tr>
</tbody>
</table><hr>
<h4 id="appmodal">AppModal</h4>
<pre class=" language-vue"><code class="prism  language-vue">&lt;AppModal v-model="showModal" title="Finalize Consultation" size="lg"&gt;
  &lt;template #default&gt;
    &lt;!-- modal body --&gt;
    &lt;p class="text-sm text-slate-600"&gt;
      Once finalized, this consultation cannot be edited.
    &lt;/p&gt;
  &lt;/template&gt;
  &lt;template #footer&gt;
    &lt;AppButton variant="ghost" @click="showModal = false"&gt;Cancel&lt;/AppButton&gt;
    &lt;AppButton variant="primary" :loading="saving" @click="finalize"&gt;
      Confirm &amp; Finalize
    &lt;/AppButton&gt;
  &lt;/template&gt;
&lt;/AppModal&gt;
</code></pre>
<pre class=" language-typescript"><code class="prism  language-typescript"><span class="token keyword">interface</span> <span class="token class-name">AppModalProps</span> <span class="token punctuation">{</span>
  modelValue<span class="token punctuation">:</span> <span class="token keyword">boolean</span>          <span class="token comment">// v-model for open/closed</span>
  title<span class="token operator">?</span><span class="token punctuation">:</span>     <span class="token keyword">string</span>
  size<span class="token operator">?</span><span class="token punctuation">:</span>      <span class="token string">'sm'</span> <span class="token operator">|</span> <span class="token string">'md'</span> <span class="token operator">|</span> <span class="token string">'lg'</span> <span class="token operator">|</span> <span class="token string">'xl'</span> <span class="token operator">|</span> <span class="token string">'full'</span>
  persistent<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">boolean</span>         <span class="token comment">// if true, clicking backdrop does NOT close</span>
<span class="token punctuation">}</span>
<span class="token comment">// Sizes: sm=400px, md=560px (default), lg=720px, xl=960px, full=100vw</span>
</code></pre>
<hr>
<h4 id="appconfirmmodal">AppConfirmModal</h4>
<p>A pre-wired confirmation pattern used for void, refund, discharge, delete, and period close actions.</p>
<pre class=" language-vue"><code class="prism  language-vue">&lt;AppConfirmModal
  v-model="showConfirm"
  title="Void Invoice #BILL-2026-00142"
  message="This will cancel the invoice and cannot be undone. The patient's balance will be reset to zero."
  confirm-label="Yes, Void Invoice"
  variant="danger"
  :loading="voiding"
  @confirm="voidInvoice"
/&gt;
</code></pre>
<hr>
<h4 id="appalert">AppAlert</h4>
<p>Inline contextual messages. Used for validation summaries, critical lab value notices, and info banners.</p>
<pre class=" language-vue"><code class="prism  language-vue">&lt;AppAlert variant="error" title="Critical Lab Value"&gt;
  Potassium 6.8 mmol/L — notify doctor immediately.
&lt;/AppAlert&gt;

&lt;AppAlert variant="warning" :dismissible="true"&gt;
  This patient has a documented Penicillin allergy.
&lt;/AppAlert&gt;

&lt;AppAlert variant="info"&gt;
  Prescription expires in 3 days.
&lt;/AppAlert&gt;

&lt;AppAlert variant="success"&gt;
  Payment of KES 2,500 received via M-Pesa.
&lt;/AppAlert&gt;
</code></pre>
<hr>
<h4 id="apptabs">AppTabs</h4>
<pre class=" language-vue"><code class="prism  language-vue">&lt;AppTabs v-model="activeTab" :tabs="[
  { key: 'vitals',       label: 'Vitals',       icon: Activity },
  { key: 'history',      label: 'History',      icon: Clock },
  { key: 'prescriptions',label: 'Prescriptions',icon: Pill },
  { key: 'labs',         label: 'Lab Results',  icon: FlaskConical },
]"&gt;
  &lt;template #vitals&gt;    &lt;VitalSigns :encounter="encounter" /&gt;&lt;/template&gt;
  &lt;template #history&gt;   &lt;PatientHistoryList :patient-id="patientId" /&gt;&lt;/template&gt;
  &lt;template #prescriptions&gt;&lt;PrescriptionList :patient-id="patientId" /&gt;&lt;/template&gt;
  &lt;template #labs&gt;      &lt;LabResultsList :patient-id="patientId" /&gt;&lt;/template&gt;
&lt;/AppTabs&gt;
</code></pre>
<hr>
<h4 id="appemptystate">AppEmptyState</h4>
<pre class=" language-vue"><code class="prism  language-vue">&lt;!-- When a queue is empty --&gt;
&lt;AppEmptyState
  :icon="ClipboardList"
  title="No patients in queue"
  description="Patients will appear here as they check in."
&gt;
  &lt;template #action&gt;
    &lt;AppButton variant="primary" :icon="Plus" @click="registerWalkin"&gt;
      Register Walk-in
    &lt;/AppButton&gt;
  &lt;/template&gt;
&lt;/AppEmptyState&gt;
</code></pre>
<hr>
<h4 id="appskeleton">AppSkeleton</h4>
<p>Used during data loading to prevent layout shift.</p>
<pre class=" language-vue"><code class="prism  language-vue">&lt;!-- MetricCard loading state --&gt;
&lt;template v-if="loading"&gt;
  &lt;AppSkeleton v-for="n in 4" :key="n" class="h-24 rounded-xl" /&gt;
&lt;/template&gt;
&lt;template v-else&gt;
  &lt;AppMetricCard v-for="metric in metrics" :key="metric.label" v-bind="metric" /&gt;
&lt;/template&gt;

&lt;!-- Table loading state --&gt;
&lt;AppSkeleton variant="table" :rows="8" /&gt;

&lt;!-- Text loading state --&gt;
&lt;AppSkeleton variant="text" :lines="3" /&gt;
</code></pre>
<hr>
<h4 id="appformsearch-with-region-aware-variant">AppFormSearch (with region-aware variant)</h4>
<pre class=" language-vue"><code class="prism  language-vue">&lt;!-- Generic debounced search --&gt;
&lt;AppFormSearch
  v-model="query"
  placeholder="Search by name, phone, or patient ID..."
  :debounce="300"
  :loading="searching"
  @search="onSearch"
/&gt;

&lt;!-- QR scan trigger integrated into search --&gt;
&lt;AppFormSearch
  v-model="query"
  placeholder="Search or scan QR..."
  :show-qr-scan="true"
  @qr-scan="onQRScan"
/&gt;
</code></pre>
<hr>
<h4 id="global-component-registration">Global Component Registration</h4>
<p>All <code>ui/</code> components are globally registered so no per-file imports are needed:</p>
<pre class=" language-typescript"><code class="prism  language-typescript"><span class="token comment">// src/plugins/ui-components.ts</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> App <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> components <span class="token keyword">from</span> <span class="token string">'@/components/ui'</span>  <span class="token comment">// auto-import via vite glob</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">install</span><span class="token punctuation">(</span>app<span class="token punctuation">:</span> App<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>components<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span>name<span class="token punctuation">,</span> component<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      app<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> component<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// src/main.ts</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>UIComponents<span class="token punctuation">)</span>
<span class="token comment">// Now &lt;AppButton&gt;, &lt;AppCard&gt;, &lt;AppMetricCard&gt; etc. are available in every .vue file</span>
</code></pre>
<hr>
<h4 id="usetoast-composable">useToast Composable</h4>
<p>Programmatic toast notifications from anywhere in the app:</p>
<pre class=" language-typescript"><code class="prism  language-typescript"><span class="token comment">// src/composables/useToast.ts</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> toast <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useToast</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

toast<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'Patient registered successfully'</span><span class="token punctuation">)</span>
toast<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Failed to save — please try again'</span><span class="token punctuation">)</span>
toast<span class="token punctuation">.</span><span class="token function">warning</span><span class="token punctuation">(</span><span class="token string">'Stock below minimum threshold'</span><span class="token punctuation">)</span>
toast<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'Prescription expires in 3 days'</span><span class="token punctuation">)</span>

<span class="token comment">// With duration override (default: 4000ms)</span>
toast<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'Payment received'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> duration<span class="token punctuation">:</span> <span class="token number">6000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<hr>
<h2 id="security--compliance">8. Security &amp; Compliance</h2>
<h3 id="clinical-data-security">8.1 Clinical Data Security</h3>
<p><strong>All clinical data requires specific permissions:</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Permission matrix for healthcare:</span>
HEALTHCARE_PERMISSIONS <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"patient"</span><span class="token punctuation">:</span>         <span class="token punctuation">[</span><span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"read"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment"># No delete</span>
    <span class="token string">"emr"</span><span class="token punctuation">:</span>             <span class="token punctuation">[</span><span class="token string">"read"</span><span class="token punctuation">,</span> <span class="token string">"write"</span><span class="token punctuation">,</span> <span class="token string">"finalize"</span><span class="token punctuation">,</span> <span class="token string">"amend"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"prescription"</span><span class="token punctuation">:</span>    <span class="token punctuation">[</span><span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"read"</span><span class="token punctuation">,</span> <span class="token string">"cancel"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"lab_order"</span><span class="token punctuation">:</span>       <span class="token punctuation">[</span><span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"read"</span><span class="token punctuation">,</span> <span class="token string">"cancel"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"lab_result"</span><span class="token punctuation">:</span>      <span class="token punctuation">[</span><span class="token string">"enter"</span><span class="token punctuation">,</span> <span class="token string">"verify"</span><span class="token punctuation">,</span> <span class="token string">"release"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"pharmacy"</span><span class="token punctuation">:</span>        <span class="token punctuation">[</span><span class="token string">"dispense"</span><span class="token punctuation">,</span> <span class="token string">"read"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"admission"</span><span class="token punctuation">:</span>       <span class="token punctuation">[</span><span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"transfer"</span><span class="token punctuation">,</span> <span class="token string">"discharge"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"nursing"</span><span class="token punctuation">:</span>         <span class="token punctuation">[</span><span class="token string">"write"</span><span class="token punctuation">,</span> <span class="token string">"administer"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>           <span class="token comment"># Medication admin</span>
    <span class="token string">"billing"</span><span class="token punctuation">:</span>         <span class="token punctuation">[</span><span class="token string">"read"</span><span class="token punctuation">,</span> <span class="token string">"collect"</span><span class="token punctuation">,</span> <span class="token string">"finalize"</span><span class="token punctuation">,</span> <span class="token string">"waive"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"insurance"</span><span class="token punctuation">:</span>       <span class="token punctuation">[</span><span class="token string">"submit"</span><span class="token punctuation">,</span> <span class="token string">"read"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"reports"</span><span class="token punctuation">:</span>         <span class="token punctuation">[</span><span class="token string">"read"</span><span class="token punctuation">,</span> <span class="token string">"export"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="role-definitions">8.2 Role Definitions</h3>
<pre class=" language-python"><code class="prism  language-python">HEALTHCARE_ROLES <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"doctor"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"permissions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"patient:read"</span><span class="token punctuation">,</span> <span class="token string">"emr:write"</span><span class="token punctuation">,</span> <span class="token string">"emr:finalize"</span><span class="token punctuation">,</span> <span class="token string">"emr:amend"</span><span class="token punctuation">,</span>
            <span class="token string">"prescription:create"</span><span class="token punctuation">,</span> <span class="token string">"lab_order:create"</span><span class="token punctuation">,</span> <span class="token string">"lab_result:read"</span><span class="token punctuation">,</span>
            <span class="token string">"admission:create"</span><span class="token punctuation">,</span> <span class="token string">"admission:discharge"</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"nurse"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"permissions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"patient:read"</span><span class="token punctuation">,</span> <span class="token string">"emr:read"</span><span class="token punctuation">,</span> <span class="token string">"nursing:write"</span><span class="token punctuation">,</span>
            <span class="token string">"nursing:administer"</span><span class="token punctuation">,</span> <span class="token string">"lab_result:read"</span><span class="token punctuation">,</span>
            <span class="token string">"prescription:read"</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"receptionist"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"permissions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"patient:create"</span><span class="token punctuation">,</span> <span class="token string">"patient:update"</span><span class="token punctuation">,</span> <span class="token string">"patient:read"</span><span class="token punctuation">,</span>
            <span class="token string">"appointment:create"</span><span class="token punctuation">,</span> <span class="token string">"encounter:create"</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"lab_technician"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"permissions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"patient:read"</span><span class="token punctuation">,</span> <span class="token string">"lab_order:read"</span><span class="token punctuation">,</span>
            <span class="token string">"lab_result:enter"</span><span class="token punctuation">,</span> <span class="token string">"lab_result:verify"</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"senior_lab"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"permissions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"lab_result:enter"</span><span class="token punctuation">,</span> <span class="token string">"lab_result:verify"</span><span class="token punctuation">,</span> <span class="token string">"lab_result:release"</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"pharmacist"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"permissions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"patient:read"</span><span class="token punctuation">,</span> <span class="token string">"prescription:read"</span><span class="token punctuation">,</span> <span class="token string">"pharmacy:dispense"</span><span class="token punctuation">,</span>
            <span class="token string">"pharmacy:read"</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"billing_officer"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"permissions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"billing:read"</span><span class="token punctuation">,</span> <span class="token string">"billing:collect"</span><span class="token punctuation">,</span> <span class="token string">"billing:finalize"</span><span class="token punctuation">,</span>
            <span class="token string">"insurance:submit"</span><span class="token punctuation">,</span> <span class="token string">"insurance:read"</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"finance_manager"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"permissions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"billing:*"</span><span class="token punctuation">,</span> <span class="token string">"insurance:*"</span><span class="token punctuation">,</span> <span class="token string">"reports:*"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"billing_officer"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"permissions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"billing:read"</span><span class="token punctuation">,</span> <span class="token string">"billing:collect"</span><span class="token punctuation">,</span> <span class="token string">"billing:finalize"</span><span class="token punctuation">,</span>
            <span class="token string">"insurance:submit"</span><span class="token punctuation">,</span> <span class="token string">"insurance:read"</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"accountant"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"permissions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"billing:read"</span><span class="token punctuation">,</span> <span class="token string">"billing:void"</span><span class="token punctuation">,</span> <span class="token string">"billing:refund"</span><span class="token punctuation">,</span>
            <span class="token string">"insurance:*"</span><span class="token punctuation">,</span> <span class="token string">"reports:*"</span><span class="token punctuation">,</span>
            <span class="token string">"accounting:read"</span><span class="token punctuation">,</span> <span class="token string">"accounting:write"</span><span class="token punctuation">,</span> <span class="token string">"accounting:approve"</span><span class="token punctuation">,</span>
            <span class="token string">"accounting:export"</span><span class="token punctuation">,</span> <span class="token string">"accounting:admin"</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"dentist"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"permissions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"patient:read"</span><span class="token punctuation">,</span> <span class="token string">"emr:read"</span><span class="token punctuation">,</span> <span class="token string">"dental:read"</span><span class="token punctuation">,</span> <span class="token string">"dental:write"</span><span class="token punctuation">,</span>
            <span class="token string">"prescription:create"</span><span class="token punctuation">,</span> <span class="token string">"billing:read"</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"physiotherapist"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"permissions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"patient:read"</span><span class="token punctuation">,</span> <span class="token string">"emr:read"</span><span class="token punctuation">,</span> <span class="token string">"physio:read"</span><span class="token punctuation">,</span> <span class="token string">"physio:write"</span><span class="token punctuation">,</span>
            <span class="token string">"billing:read"</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"patient_portal"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"permissions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"portal:read"</span><span class="token punctuation">,</span>      <span class="token comment"># Own appointments, bills, prescriptions, history</span>
            <span class="token string">"portal:write"</span><span class="token punctuation">,</span>     <span class="token comment"># Book appointments, initiate payments</span>
        <span class="token punctuation">]</span>
        <span class="token comment"># Note: Portal JWT carries patient_id claim.</span>
        <span class="token comment"># All portal queries are hard-scoped to that patient_id at service layer.</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"finance_manager"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"permissions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"billing:*"</span><span class="token punctuation">,</span> <span class="token string">"insurance:*"</span><span class="token punctuation">,</span> <span class="token string">"reports:*"</span><span class="token punctuation">,</span> <span class="token string">"accounting:*"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"hospital_admin"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"permissions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span>  <span class="token comment"># All permissions, all actions logged</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="clinical-audit-trail">8.3 Clinical Audit Trail</h3>
<p>Every action on clinical data generates an immutable audit log entry:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Critical actions that trigger audit logs:</span>
AUDIT_ACTIONS <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"consultation_finalized"</span><span class="token punctuation">,</span>
    <span class="token string">"consultation_amended"</span><span class="token punctuation">,</span>
    <span class="token string">"prescription_issued"</span><span class="token punctuation">,</span>
    <span class="token string">"prescription_dispensed"</span><span class="token punctuation">,</span>
    <span class="token string">"lab_result_released"</span><span class="token punctuation">,</span>
    <span class="token string">"patient_admitted"</span><span class="token punctuation">,</span>
    <span class="token string">"patient_discharged"</span><span class="token punctuation">,</span>
    <span class="token string">"medication_administered"</span><span class="token punctuation">,</span>
    <span class="token string">"bill_waived"</span><span class="token punctuation">,</span>
    <span class="token string">"insurance_claim_submitted"</span><span class="token punctuation">,</span>
    <span class="token string">"record_accessed"</span><span class="token punctuation">,</span>           <span class="token comment"># Who viewed patient record</span>
<span class="token punctuation">]</span>
</code></pre>
<p>Each audit entry records: <code>who</code> (user_id), <code>what</code> (action + resource_id), <code>when</code> (timestamp), <code>where</code> (IP address), <code>entity</code> (facility).</p>
<h3 id="data-privacy">8.4 Data Privacy</h3>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Sensitive fields encrypted at rest:</span>
SENSITIVE_FIELDS <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"insurance_api_credentials"</span><span class="token punctuation">,</span>    <span class="token comment"># Insurance API keys</span>
    <span class="token string">"hiv_status"</span><span class="token punctuation">,</span>                   <span class="token comment"># HIV-specific fields (requires extra consent)</span>
    <span class="token string">"mental_health_notes"</span><span class="token punctuation">,</span>          <span class="token comment"># Psychiatric records</span>
<span class="token punctuation">]</span>

<span class="token comment"># Patient data access logging:</span>
<span class="token comment"># Every GET on patient record creates a log entry:</span>
<span class="token comment"># WHO accessed WHICH patient's data WHEN from WHAT IP</span>
</code></pre>
<h3 id="admin-impersonation">8.5 Admin Impersonation</h3>
<p>Admins may impersonate any user for support and troubleshooting. <strong>Every impersonation session is audited.</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># POST /api/admin/impersonate</span>
<span class="token comment"># Body: { "user_id": "...", "reason": "...", "duration_minutes": 30 }</span>
<span class="token comment"># Requires: hospital_admin permission</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">start_impersonation</span><span class="token punctuation">(</span>target_user_id<span class="token punctuation">:</span> UUID<span class="token punctuation">,</span> reason<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> admin<span class="token punctuation">:</span> User<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. Validate admin has impersonation permission</span>
    <span class="token comment"># 2. Create scoped JWT with:</span>
    <span class="token comment">#    { "sub": target_user_id, "impersonated_by": admin.id,</span>
    <span class="token comment">#      "exp": now + duration, "is_impersonation": true }</span>
    <span class="token comment"># 3. Log: impersonation_started (admin_id, target_user_id, reason, IP, timestamp)</span>
    <span class="token comment"># 4. Return scoped token — admin uses this to act as the user</span>

<span class="token comment"># All API calls made with an impersonation token:</span>
<span class="token comment"># - Carry out_user permissions (as if they were target_user)</span>
<span class="token comment"># - Are logged with BOTH acting_user_id=target_user AND impersonated_by=admin_id</span>
<span class="token comment"># - Appear in audit reports flagged as "admin override"</span>

<span class="token comment"># POST /api/admin/impersonate/end</span>
<span class="token comment"># Ends the impersonation session; logs impersonation_ended timestamp</span>
</code></pre>
<p><strong>Audit query for impersonated actions:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> audit_logs
<span class="token keyword">WHERE</span> impersonated_by <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> created_at <span class="token keyword">DESC</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="immutability-rules">8.6 Immutability Rules</h3>
<pre><code>Clinical records that CANNOT be modified once finalized:
1. Consultation notes (after finalized_at set)
2. Lab results (after verified + released)
3. Medication administration records (MAR)
4. Discharge summary
5. Insurance claims (after submitted)

Amendment process for #1-4:
- Create new record linked to original
- Original preserved with is_superseded=True
- Amendment logged with amending_user_id + reason
</code></pre>
<hr>
<h2 id="integrations">9. Integrations</h2>
<h3 id="m-pesa-patient-payments">9.1 M-Pesa (Patient Payments)</h3>
<p>The HMIS integrates with Safaricom’s M-Pesa API for mobile payments. Three flows are supported:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Payment flows:</span>
<span class="token comment"># - STK Push: prompt patient's phone to enter M-Pesa PIN</span>
<span class="token comment"># - C2B (Customer to Business): patient pays via paybill</span>
<span class="token comment"># - B2C (Business to Customer): patient refunds</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">mpesa_health_payment_callback</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> MpesaCallback<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. Match to encounter bill by AccountReference</span>
    bill <span class="token operator">=</span> <span class="token keyword">await</span> find_bill_by_reference<span class="token punctuation">(</span>data<span class="token punctuation">.</span>AccountReference<span class="token punctuation">)</span>
    <span class="token comment"># 2. Record payment against the bill</span>
    <span class="token keyword">await</span> record_patient_payment<span class="token punctuation">(</span>bill<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>TransactionAmount<span class="token punctuation">,</span> <span class="token string">"mpesa"</span><span class="token punctuation">)</span>
    <span class="token comment"># 3. Create GL transaction (DR M-Pesa Float → CR Patient Revenue)</span>
    <span class="token keyword">await</span> create_payment_transaction<span class="token punctuation">(</span>bill<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token comment"># 4. Send receipt SMS to patient</span>
    <span class="token keyword">await</span> send_receipt_sms<span class="token punctuation">(</span>bill<span class="token punctuation">.</span>patient_id<span class="token punctuation">,</span> data<span class="token punctuation">.</span>TransactionAmount<span class="token punctuation">)</span>
</code></pre>
<p><strong>M-Pesa API Configuration:</strong></p>
<pre class=" language-python"><code class="prism  language-python">MPESA_CONFIG <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"environment"</span><span class="token punctuation">:</span> <span class="token string">"production"</span><span class="token punctuation">,</span>     <span class="token comment"># or "sandbox"</span>
    <span class="token string">"consumer_key"</span><span class="token punctuation">:</span> <span class="token string">"..."</span><span class="token punctuation">,</span>
    <span class="token string">"consumer_secret"</span><span class="token punctuation">:</span> <span class="token string">"..."</span><span class="token punctuation">,</span>
    <span class="token string">"business_shortcode"</span><span class="token punctuation">:</span> <span class="token string">"..."</span><span class="token punctuation">,</span>     <span class="token comment"># Paybill number</span>
    <span class="token string">"passkey"</span><span class="token punctuation">:</span> <span class="token string">"..."</span><span class="token punctuation">,</span>
    <span class="token string">"callback_url"</span><span class="token punctuation">:</span> <span class="token string">"https://hmis.hospital.co.ke/api/mpesa/callback"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="nhif--shif-integration-kenya-national-health-insurance">9.2 NHIF / SHIF Integration (Kenya National Health Insurance)</h3>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">NHIFService</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""NHIF/SHA claim submission for Kenya."""</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">verify_member</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> member_number<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> NHIFMemberResponse<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Verify NHIF eligibility before admission."""</span>
        <span class="token comment"># POST to NHIF API: /api/member/verify</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">pre_authorize</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> admission<span class="token punctuation">:</span> Admission<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> PreAuthResponse<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Request pre-authorization for IPD admission."""</span>
        <span class="token comment"># POST to NHIF API: /api/preauth/request</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">submit_claim</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> claim<span class="token punctuation">:</span> InsuranceClaim<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> ClaimResponse<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Submit claim after patient discharged."""</span>
        <span class="token comment"># POST to NHIF API: /api/claims/submit</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">check_claim_status</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> claim_number<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> ClaimStatus<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Track submitted claim."""</span>
        <span class="token comment"># GET /api/claims/{claim_number}/status</span>
</code></pre>
<h3 id="lab-equipment-hl7lis-middleware">9.3 Lab Equipment (HL7/LIS Middleware)</h3>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">LISIntegration</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Bridge between HMS and lab analyzer machines."""</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">receive_result</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> hl7_message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Parse HL7 v2.x ORM/ORU message from lab analyzer."""</span>
        <span class="token comment"># 1. Parse HL7 → extract patient, test, result</span>
        <span class="token comment"># 2. Match to pending lab order item</span>
        <span class="token comment"># 3. Auto-populate result in LabResult table</span>
        <span class="token comment"># 4. Trigger verification workflow</span>
</code></pre>
<h3 id="sms--whatsapp-notifications-africas-talking--twilio">9.4 SMS / WhatsApp Notifications (Africa’s Talking / Twilio)</h3>
<p>The HMIS sends automated SMS for clinical and administrative events using Africa’s Talking (Kenya) or Twilio:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">SMSService</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Healthcare SMS notification service."""</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">send</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> phone<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> template<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        message <span class="token operator">=</span> HEALTHCARE_TEMPLATES<span class="token punctuation">[</span>template<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token comment"># POST to Africa's Talking or Twilio API</span>

HEALTHCARE_TEMPLATES <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"appointment_reminder"</span><span class="token punctuation">:</span>
        <span class="token string">"Dear {name}, your appointment with Dr. {doctor} is tomorrow at {time}. Reply CONFIRM or CANCEL."</span><span class="token punctuation">,</span>
    <span class="token string">"lab_results_ready"</span><span class="token punctuation">:</span>
        <span class="token string">"Dear {name}, your lab results are ready. Please collect from {facility} or view at {portal_link}."</span><span class="token punctuation">,</span>
    <span class="token string">"discharge_instructions"</span><span class="token punctuation">:</span>
        <span class="token string">"Dear {name}, your discharge instructions are ready. Please collect from the ward nurse."</span><span class="token punctuation">,</span>
    <span class="token string">"payment_receipt"</span><span class="token punctuation">:</span>
        <span class="token string">"Dear {name}, payment of KES {amount} received for bill {bill_number}. Balance: KES {balance}."</span><span class="token punctuation">,</span>
    <span class="token string">"critical_value_alert"</span><span class="token punctuation">:</span>
        <span class="token string">"URGENT: Critical lab result for patient {patient_name} ({patient_number}). Please review immediately."</span><span class="token punctuation">,</span>
    <span class="token string">"low_stock_alert"</span><span class="token punctuation">:</span>
        <span class="token string">"Stock Alert: {drug_name} at {entity_name} has only {quantity} {unit} remaining (below minimum threshold)."</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment"># WhatsApp (future — Phase 3):</span>
<span class="token comment"># The same template keys will be reused for WhatsApp Business API delivery</span>
<span class="token comment"># when the facility enables it. Channel selection (SMS vs WhatsApp) is a</span>
<span class="token comment"># per-entity config flag: entity.notification_channel = "sms" | "whatsapp" | "both"</span>
<span class="token comment"># Africa's Talking supports WhatsApp Business messaging on the same SDK.</span>
</code></pre>
<h3 id="dhis2--khis-kenya-health-information-system">9.5 DHIS2 / KHIS (Kenya Health Information System)</h3>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">DHIS2ExportService</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Export aggregate data to DHIS2 / KHIS."""</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">export_monthly_report</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> month<span class="token punctuation">:</span> date<span class="token punctuation">,</span> entity_id<span class="token punctuation">:</span> UUID<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Export MOH indicators to DHIS2."""</span>
        <span class="token comment"># 1. Calculate indicators from HMS data</span>
        <span class="token comment"># 2. Format as DHIS2 data values</span>
        <span class="token comment"># 3. POST to DHIS2 API: /api/dataValueSets</span>
</code></pre>
<hr>
<h2 id="development-roadmap">10. Development Roadmap</h2>
<h3 id="phase-1-mvp-clinical-core-months-1-6">Phase 1: MVP Clinical Core (Months 1-6)</h3>
<p><strong>Month 1: Foundation</strong></p>
<ul>
<li>Project scaffolding: backend (Litestar + PostgreSQL) + frontend (Vue 3 + Tailwind + rv-grid)</li>
<li>Base models: Patient, Encounter, Department</li>
<li>Authentication &amp; RBAC for all roles (including patient portal role)</li>
<li>Patient registration with QR code generation</li>
<li>Patient search (by name, phone, ID, QR scan)</li>
<li>Department management</li>
<li>Basic appointment booking</li>
</ul>
<p><strong>Month 2: OPD Workflow</strong></p>
<ul>
<li>Queue management with WebSocket display board</li>
<li>Triage recording (vital signs entry)</li>
<li>Consultation SOAP notes</li>
<li>ICD-10 diagnosis coding (offline database)</li>
</ul>
<p><strong>Month 3: Prescriptions &amp; Pharmacy</strong></p>
<ul>
<li>Prescription creation and management</li>
<li>Drug catalog + batch/expiry tracking setup</li>
<li>Pharmacy dispensing queue with FEFO batch selection</li>
<li>Stock deduction + low stock and expiry alerts</li>
<li>Drug interaction checks</li>
<li>Allergy alerts</li>
</ul>
<p><strong>Month 4: Laboratory (LIS)</strong></p>
<ul>
<li>Lab test catalog</li>
<li>Test ordering from consultation</li>
<li>Specimen collection workflow</li>
<li>Result entry with reference ranges</li>
<li>Critical value alerting</li>
<li>Lab report PDF generation</li>
</ul>
<p><strong>Month 5: Billing Core + Patient Portal</strong></p>
<ul>
<li>Service catalog (price list)</li>
<li>Auto-bill generation from clinical events</li>
<li>Invoice void and refund workflow</li>
<li>Patient payment collection (cash, M-Pesa, card)</li>
<li>Basic insurance (pre-auth + manual claims)</li>
<li>Receipt printing</li>
<li><strong>Patient Portal v1</strong>: login (phone+OTP), view appointments, prescriptions, bills, M-Pesa self-pay</li>
</ul>
<p><strong>Month 6: MVP Polish &amp; Go-Live</strong></p>
<ul>
<li>Dashboard: daily stats, revenue, queue status (KPI cards for management)</li>
<li>Triage vital abnormal flagging live</li>
<li>Basic MOH report (MOH-705A)</li>
<li>Data export (CSV) from key reports</li>
<li>Performance optimization</li>
<li>Security audit</li>
<li>User training materials</li>
<li>Pilot with 1 clinic</li>
</ul>
<hr>
<h3 id="phase-2-ipd--advanced-features-months-7-12">Phase 2: IPD &amp; Advanced Features (Months 7-12)</h3>
<p><strong>Month 7-8: IPD / Ward Management</strong></p>
<ul>
<li>Ward and bed setup</li>
<li>Patient admission workflow</li>
<li>Bed allocation matrix (visual BedMatrix.vue)</li>
<li>Nursing assessments and notes</li>
<li>Medication Administration Record (MAR)</li>
<li>Daily bed charge automation</li>
</ul>
<p><strong>Month 9: Dental &amp; Physiotherapy</strong></p>
<ul>
<li>Dental module: procedure catalog, encounter procedures, tooth chart, billing integration</li>
<li>Physiotherapy module: care plans, session recording, pain/function scores, billing integration</li>
<li>Department-level queue support for dental/physio</li>
</ul>
<p><strong>Month 10: Accounting + Insurance Claims</strong></p>
<ul>
<li>Expense recording and approval workflow</li>
<li>P&amp;L summary report</li>
<li>Accounting period open/close/lock</li>
<li>Full data export (CSV + XLSX) for all reports</li>
<li>NHIF/SHIF API integration</li>
<li>Member verification</li>
<li>Pre-authorization requests</li>
<li>Claim submission and tracking</li>
<li>Claim reconciliation</li>
</ul>
<p><strong>Month 11: Insurance Claims + Advanced Reporting</strong></p>
<ul>
<li>NHIF/SHIF API integration</li>
<li>MOH-705B (IPD morbidity)</li>
<li>MOH-717 (HMIS summary)</li>
<li>Disease notification reports</li>
<li>Bed occupancy trends</li>
<li>Revenue analytics</li>
<li>Doctor performance metrics</li>
</ul>
<p><strong>Month 12: Scale &amp; Integration</strong></p>
<ul>
<li>Multi-facility deployment</li>
<li>DHIS2/KHIS export</li>
<li>HL7 lab equipment integration</li>
<li>Performance benchmarking</li>
<li>Load testing</li>
</ul>
<hr>
<h3 id="phase-3-advanced-hms-month-13">Phase 3: Advanced HMS (Month 13+)</h3>
<ul>
<li><strong>Patient Mobile App</strong> — Appointments, results, bills, telemedicine</li>
<li><strong>Telemedicine</strong> — Video consultations (WebRTC)</li>
<li><strong>Advanced Analytics</strong> — AI-powered disease trend detection</li>
<li><strong>Maternity Module</strong> — ANC, delivery, PNC workflows</li>
<li><strong>Theatre Management</strong> — Surgical bookings, operation notes</li>
<li><strong>Blood Bank</strong> — Blood group matching, cross-matching, inventory</li>
<li><strong>Mortuary Management</strong></li>
<li><strong>FHIR R4 Compliance</strong> — International interoperability</li>
</ul>
<hr>
<h2 id="project-structure">11. Project Structure</h2>
<pre><code>hmis/
├── backend/
│   ├── app/
│   │   ├── main.py                        # Litestar application entrypoint
│   │   ├── config.py                      # Settings (env vars, database URL)
│   │   │
│   │   ├── core/                          # Cross-cutting infrastructure
│   │   │   ├── auth.py                    # JWT utilities (create/verify tokens)
│   │   │   ├── middleware.py              # Auth middleware, tenant resolution
│   │   │   ├── exceptions.py             # Custom HTTP exceptions
│   │   │   ├── logging.py                # Structured JSON logging
│   │   │   ├── cache.py                  # Redis cache helpers
│   │   │   └── observability.py          # Health checks, metrics endpoints
│   │   │
│   │   ├── models/
│   │   │   ├── base.py                   # BaseModel with audit fields
│   │   │   │
│   │   │   │   # ── Global reference (no org/entity scope) ──
│   │   │   ├── regions.py                # County, SubCounty, AdministrativeWard
│   │   │   ├── icd10.py                  # ICD10Code (~14,400 WHO codes)
│   │   │   ├── drug_master.py            # DrugMaster (~600 drugs, Kenya KEML + WHO EML)
│   │   │   ├── lab_master.py             # LabTestMaster + LabTestMaterial
│   │   │   │
│   │   │   │   # ── Tenant / entity-scoped ──
│   │   │   ├── organization.py           # Organization + Entity (multi-tenancy)
│   │   │   ├── user.py                   # User + Role + Permission models
│   │   │   ├── gl.py                     # Chart of accounts, GL entries
│   │   │   ├── transaction.py            # Transaction model + GL rules
│   │   │   ├── inventory.py              # Inventory items + stock movements
│   │   │   ├── notification.py           # SMS/email notification log
│   │   │   ├── audit.py                  # Audit log entries
│   │   │   │
│   │   │   ├── patient.py                # Patient + identifiers + insurance
│   │   │   ├── appointment.py            # Schedules + slots + bookings
│   │   │   ├── encounter.py              # OPD/IPD encounters + triage
│   │   │   ├── clinical.py               # Consultation + diagnosis + notes
│   │   │   ├── prescription.py           # Prescriptions + items
│   │   │   ├── lab.py                    # LIS: orders, specimens, results
│   │   │   ├── radiology.py              # Radiology orders + reports
│   │   │   ├── pharmacy.py               # Dispensing (extends inventory)
│   │   │   ├── ward.py                   # Wards + beds + admissions + nursing
│   │   │   ├── billing.py                # Bills + line items + insurance claims
│   │   │   ├── dental.py                 # Dental charts, procedures
│   │   │   ├── physiotherapy.py          # Care plans, sessions
│   │   │   ├── accounting.py             # Expenses, accounting periods
│   │   │   ├── portal.py                 # Patient portal auth + scoped models
│   │   │   └── hmis_reports.py           # MOH report data models
│   │   │
│   │   ├── schemas/
│   │   │   ├── patient.py                # Pydantic schemas for patient
│   │   │   ├── encounter.py              # Encounter schemas
│   │   │   ├── clinical.py               # Clinical/EMR schemas
│   │   │   ├── lab.py                    # Lab schemas
│   │   │   ├── pharmacy.py               # Pharmacy schemas
│   │   │   ├── ward.py                   # Ward/IPD schemas
│   │   │   └── billing.py                # Billing schemas
│   │   │
│   │   ├── services/
│   │   │   ├── patient_service.py        # Patient CRUD + search + merge
│   │   │   ├── appointment_service.py    # Scheduling + queue management
│   │   │   ├── encounter_service.py      # Encounter lifecycle
│   │   │   ├── emr_service.py            # Consultation + diagnosis
│   │   │   ├── prescription_service.py   # Prescription management
│   │   │   ├── lab_service.py            # LIS + specimen + results
│   │   │   ├── pharmacy_service.py       # Dispensing + stock
│   │   │   ├── ward_service.py           # Admissions + beds + nursing
│   │   │   ├── billing_service.py        # Bill generation + payments
│   │   │   ├── insurance_service.py      # Claims + NHIF integration
│   │   │   ├── nhif_service.py           # NHIF API client
│   │   │   ├── dental_service.py         # Dental procedures + chart
│   │   │   ├── physio_service.py         # Care plans + sessions
│   │   │   ├── accounting_service.py     # Expenses + P&amp;L + period management
│   │   │   ├── portal_service.py         # Patient portal auth + scoped reads
│   │   │   └── hmis_report_service.py    # MOH report generation
│   │   │
│   │   ├── routes/
│   │   │   ├── patients.py               # /api/patients
│   │   │   ├── appointments.py           # /api/appointments
│   │   │   ├── encounters.py             # /api/encounters
│   │   │   ├── emr.py                    # /api/emr
│   │   │   ├── lab.py                    # /api/lab
│   │   │   ├── pharmacy.py               # /api/pharmacy
│   │   │   ├── wards.py                  # /api/wards
│   │   │   ├── admissions.py             # /api/admissions
│   │   │   ├── billing.py                # /api/billing
│   │   │   ├── insurance.py              # /api/insurance
│   │   │   ├── reports.py                # /api/reports
│   │   │   ├── dental.py                 # /api/dental
│   │   │   ├── physiotherapy.py          # /api/physiotherapy
│   │   │   ├── accounting.py             # /api/accounting
│   │   │   ├── portal.py                 # /api/portal (patient-facing)
│   │   │   │
│   │   │   ├── auth.py                   # /api/auth (login, token refresh)
│   │   │   ├── users.py                  # /api/users (user management)
│   │   │   ├── regions.py                # /api/regions (counties/sub-counties/wards — public)
│   │   │   ├── organizations.py          # /api/organizations + /api/entities
│   │   │   ├── gl.py                     # /api/gl (chart of accounts, entries)
│   │   │   ├── inventory.py              # /api/inventory (items, movements)
│   │   │   └── websocket.py              # WS /ws/queue, WS /ws/ward
│   │   │
│   │   ├── jobs/
│   │   │   ├── bed_charges.py            # Daily bed charge generation (00:05)
│   │   │   ├── appointment_reminders.py  # SMS appointment reminders (08:00)
│   │   │   ├── drug_expiry_alerts.py     # Batches expiring within 30/60/90 days (06:00)
│   │   │   ├── low_stock_alerts.py       # Drugs below min threshold notification (06:05)
│   │   │   └── insurance_claims.py       # Auto-submit pending claims (09:00)
│   │   │
│   │   └── utils/
│   │       ├── icd10.py                  # ICD-10 code lookup utilities
│   │       ├── patient_number.py         # Patient ID auto-generation
│   │       ├── hl7_parser.py             # HL7 v2.x message parsing
│   │       └── pdf_generator.py          # Lab reports, prescriptions, receipts
│   │
│   ├── alembic/                          # Database migrations
│   │   ├── versions/                     # Migration files
│   │   └── seed/
│   │       ├── global/                   # Tier 1 — global reference data
│   │       │   ├── 01_counties.py
│   │       │   ├── 02_sub_counties.py
│   │       │   ├── 03_admin_wards.py
│   │       │   ├── 04_icd10_codes.py
│   │       │   ├── 05_drug_master.py
│   │       │   ├── 06_lab_test_master.py
│   │       │   ├── 07_lab_test_materials.py
│   │       │   └── run_all.py            # Seeds all global tiers in order
│   │       ├── entity/                   # Tier 3 — per-entity setup functions
│   │       │   ├── departments.py
│   │       │   ├── drug_catalog.py
│   │       │   ├── lab_test_catalog.py
│   │       │   ├── service_catalog.py
│   │       │   ├── insurance_schemes.py
│   │       │   ├── accounting_period.py
│   │       │   └── seed_new_entity.py    # Orchestrates all entity seeds
│   │       ├── data/                     # Raw seed data files (JSON/CSV)
│   │       │   ├── drug_master.json      # ~600 drugs (Kenya KEML + WHO EML)
│   │       │   ├── lab_tests.json        # ~180 tests with reference ranges
│   │       │   ├── lab_materials.json    # ~500 material-test mappings
│   │       │   └── service_catalog.json  # ~30 default services
│   │       └── utils/
│   │           ├── parse_icd10_xml.py    # WHO ICD-10 XML → JSON converter
│   │           └── seed_runner.py        # Idempotent upsert helper
│   ├── tests/                            # Unit + integration tests
│   └── requirements.txt
│
├── frontend/
│   ├── src/
│   │   ├── api/
│   │   │   ├── patients.ts               # Patient API client
│   │   │   ├── encounters.ts             # Encounter API client
│   │   │   ├── emr.ts                    # EMR API client
│   │   │   ├── lab.ts                    # Lab API client
│   │   │   ├── pharmacy.ts               # Pharmacy API client
│   │   │   ├── ward.ts                   # Ward API client
│   │   │   ├── billing.ts                # Billing API client
│   │   │   ├── dental.ts                 # Dental API client
│   │   │   ├── physiotherapy.ts          # Physio API client
│   │   │   ├── accounting.ts             # Accounting API client
│   │   │   ├── portal.ts                 # Patient portal API client
│   │   │   └── regions.ts                # Counties/sub-counties/wards (public, cached)
│   │   │
│   │   ├── stores/
│   │   │   ├── patient/patientStore.ts
│   │   │   ├── encounter/encounterStore.ts
│   │   │   ├── queue/opdQueueStore.ts
│   │   │   ├── ward/wardStore.ts
│   │   │   ├── billing/billingStore.ts
│   │   │   ├── dental/dentalStore.ts
│   │   │   ├── physio/physioStore.ts
│   │   │   ├── accounting/accountingStore.ts
│   │   │   ├── portal/portalAuthStore.ts    # Separate auth store for patient portal
│   │   │   ├── ui/toastStore.ts             # Global toast notification queue
│   │   │   └── reference/regionsStore.ts    # Counties/sub-counties/wards (cached)
│   │   │
│   │   ├── composables/
│   │   │   ├── usePatientSearch.ts       # Debounced patient search
│   │   │   ├── useQueue.ts               # Real-time queue via WebSocket
│   │   │   ├── useICD10.ts               # ICD-10 search + cache
│   │   │   ├── usePrint.ts               # PDF/print utilities (jsPDF)
│   │   │   ├── useToast.ts               # Programmatic toast notifications
│   │   │   ├── useRegions.ts             # County/sub-county/ward cascading data
│   │   │   ├── useConfirm.ts             # Programmatic confirm dialog
│   │   │   └── useForm.ts                # Form state + validation helpers
│   │   │
│   │   ├── components/
│   │   │   ├── ui/                       # Base design system components
│   │   │   ├── patients/
│   │   │   ├── clinical/
│   │   │   ├── lab/
│   │   │   ├── pharmacy/
│   │   │   ├── ward/
│   │   │   └── billing/
│   │   │
│   │   ├── pages/
│   │   │   ├── patients/
│   │   │   ├── opd/
│   │   │   ├── ipd/
│   │   │   ├── lab/
│   │   │   ├── pharmacy/
│   │   │   └── billing/
│   │   │
│   │   └── layouts/
│   │       ├── AppLayout.vue             # Main shell with sidebar + top nav
│   │       ├── HospitalLayout.vue        # Clinical workspace with patient banner
│   │       └── WardLayout.vue            # IPD-specific layout
│   │
│   ├── package.json                      # Dependencies (see below)
│   ├── tailwind.config.ts                # HMIS design system theme
│   └── src/
│       └── plugins/
│           └── ui-components.ts          # Global registration of all ui/ components
│
├── docker-compose.yml                    # PostgreSQL + Redis
└── README.md
</code></pre>
<p><strong>Frontend key dependencies (<code>package.json</code>):</strong></p>
<pre class=" language-json"><code class="prism  language-json"><span class="token punctuation">{</span>
  <span class="token string">"dependencies"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"vue"</span><span class="token punctuation">:</span> <span class="token string">"^3.4.0"</span><span class="token punctuation">,</span>
    <span class="token string">"pinia"</span><span class="token punctuation">:</span> <span class="token string">"^2.1.0"</span><span class="token punctuation">,</span>
    <span class="token string">"vue-router"</span><span class="token punctuation">:</span> <span class="token string">"^4.3.0"</span><span class="token punctuation">,</span>
    <span class="token string">"axios"</span><span class="token punctuation">:</span> <span class="token string">"^1.6.0"</span><span class="token punctuation">,</span>
    <span class="token string">"rv-grid"</span><span class="token punctuation">:</span> <span class="token string">"latest"</span><span class="token punctuation">,</span>
    <span class="token string">"lucide-vue-next"</span><span class="token punctuation">:</span> <span class="token string">"latest"</span><span class="token punctuation">,</span>
    <span class="token string">"chart.js"</span><span class="token punctuation">:</span> <span class="token string">"^4.4.0"</span><span class="token punctuation">,</span>
    <span class="token string">"vue-chartjs"</span><span class="token punctuation">:</span> <span class="token string">"^5.3.0"</span><span class="token punctuation">,</span>
    <span class="token string">"jspdf"</span><span class="token punctuation">:</span> <span class="token string">"^2.5.0"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"devDependencies"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"typescript"</span><span class="token punctuation">:</span> <span class="token string">"^5.3.0"</span><span class="token punctuation">,</span>
    <span class="token string">"vite"</span><span class="token punctuation">:</span> <span class="token string">"^5.0.0"</span><span class="token punctuation">,</span>
    <span class="token string">"@vitejs/plugin-vue"</span><span class="token punctuation">:</span> <span class="token string">"^5.0.0"</span><span class="token punctuation">,</span>
    <span class="token string">"tailwindcss"</span><span class="token punctuation">:</span> <span class="token string">"^3.4.0"</span><span class="token punctuation">,</span>
    <span class="token string">"autoprefixer"</span><span class="token punctuation">:</span> <span class="token string">"^10.4.0"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<hr>
<h2 id="non-functional-requirements">12. Non-Functional Requirements</h2>
<h3 id="performance-targets">12.1 Performance Targets</h3>

<table>
<thead>
<tr>
<th>Operation</th>
<th>Target (p99)</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Patient search (by name/phone/QR)</td>
<td>&lt; 1 second</td>
<td>Indexed query on patients table</td>
</tr>
<tr>
<td>Dashboard page load</td>
<td>&lt; 2 seconds</td>
<td>Aggregated data, cacheable</td>
</tr>
<tr>
<td>OPD queue load</td>
<td>&lt; 1 second</td>
<td>Today’s encounters only</td>
</tr>
<tr>
<td>Lab result save</td>
<td>&lt; 1 second</td>
<td>Single row insert</td>
</tr>
<tr>
<td>M-Pesa callback processing</td>
<td>&lt; 3 seconds</td>
<td>End-to-end (receive → post GL)</td>
</tr>
<tr>
<td>Report generation (daily)</td>
<td>&lt; 5 seconds</td>
<td>Aggregate queries</td>
</tr>
<tr>
<td>File upload (20MB max)</td>
<td>&lt; 10 seconds</td>
<td>Direct-to-S3 multipart</td>
</tr>
<tr>
<td>Concurrent users per entity</td>
<td>50</td>
<td>Standard clinic load</td>
</tr>
</tbody>
</table><h3 id="responsive-ui-—-device-support">12.2 Responsive UI — Device Support</h3>
<p>The HMIS is optimized for clinical environments where tablets are the primary device:</p>

<table>
<thead>
<tr>
<th>Breakpoint</th>
<th>Width</th>
<th>Primary Use</th>
</tr>
</thead>
<tbody>
<tr>
<td>Mobile</td>
<td>375px+</td>
<td>Patient portal self-service, nurse mobile rounds</td>
</tr>
<tr>
<td>Tablet</td>
<td>768px+</td>
<td>Primary clinical workstation (triage, consultation, pharmacy)</td>
</tr>
<tr>
<td>Desktop</td>
<td>1280px+</td>
<td>Admin dashboards, accounting, reporting</td>
</tr>
</tbody>
</table><p>Tailwind breakpoint usage: <code>sm:</code> tablet adaptations, <code>lg:</code> desktop-only layouts. Critical clinical views (queue, triage, consultation) must be fully usable on a 768px tablet without horizontal scroll.</p>
<h3 id="accessibility-wcag-2.1-aa">12.3 Accessibility (WCAG 2.1 AA)</h3>
<ul>
<li><strong>Color contrast</strong>: All text on background must meet ≥ 4.5:1 ratio
<ul>
<li>Deep Medical Green <code>#1F7A4C</code> on white <code>#FFFFFF</code> = 5.2:1 ✅ (passes AA)</li>
<li>Text slate <code>#0F172A</code> on background <code>#F8FAFC</code> = 17.3:1 ✅</li>
</ul>
</li>
<li><strong>Keyboard navigation</strong>: All interactive elements reachable by Tab; no keyboard traps</li>
<li><strong>Form labels</strong>: Every input has an associated <code>&lt;label&gt;</code> or <code>aria-label</code></li>
<li><strong>Error association</strong>: Error messages linked to inputs via <code>aria-describedby</code></li>
<li><strong>Focus indicators</strong>: Visible focus ring on all focusable elements (not removed by CSS)</li>
<li><strong>Screen reader support</strong>: Lucide icons used decoratively carry <code>aria-hidden="true"</code>; functional icons carry <code>aria-label</code></li>
<li><strong>Status updates</strong>: Dynamic queue changes announced via <code>aria-live="polite"</code> regions</li>
</ul>
<h3 id="reliability--data-integrity">12.4 Reliability &amp; Data Integrity</h3>
<pre><code>Transactional integrity:
  - All billing mutations (create bill, add line item, record payment) wrapped in
    a single PostgreSQL transaction — partial updates never persist

M-Pesa idempotency:
  - Callbacks are deduplicated by MpesaTransactionId stored in payments table
  - Duplicate callbacks return 200 OK but do NOT create duplicate payment records

Background jobs:
  - All jobs log start/end/error to a job_runs table
  - Failed jobs retry up to 3 times with exponential backoff
  - Missed runs (server downtime) catch up on next execution

Database backup:
  - Automated daily snapshots with 30-day retention
  - Point-in-time recovery (PITR) enabled on production PostgreSQL

Uptime target: 99.5% monthly (≈ 3.6 hours downtime/month)
</code></pre>
<h3 id="security">12.5 Security</h3>
<pre><code>Authentication:
  - JWT access tokens: 1-hour expiry
  - Refresh tokens: 7-day expiry, stored in HttpOnly cookies
  - Patient portal OTP: 6-digit, 5-minute expiry, max 3 attempts

Transport:
  - HTTPS only in production (TLS 1.2+)
  - HSTS header enforced

Passwords:
  - bcrypt with cost factor 12 minimum
  - Minimum 8 characters, no maximum

Encryption at rest:
  - Sensitive JSONB fields (insurance credentials, HIV status) encrypted with AES-256
  - S3 bucket encryption enabled

Rate limiting:
  - Auth endpoints: 10 requests/minute per IP
  - OTP requests: 3 per phone per 15 minutes
  - General API: 300 requests/minute per authenticated user

SQL injection: Prevented by SQLAlchemy ORM (parameterized queries only)
XSS: Vue 3 template auto-escaping + Content-Security-Policy headers
CORS: Restricted to known frontend origins only
</code></pre>
<h3 id="auditability">12.6 Auditability</h3>
<p>All clinical and financial actions generate entries in the <code>audit_logs</code> table:</p>
<pre><code>Retention: 7 years minimum (Kenya Health Act requirement)
Immutability: Audit logs are INSERT-only — no UPDATE or DELETE permitted
Content per entry:
  - entity_id, user_id, impersonated_by (if applicable)
  - action, resource_type, resource_id
  - before_state (JSONB), after_state (JSONB) — for sensitive changes
  - ip_address, user_agent
  - created_at (UTC)

Admin override flag: All actions performed during admin impersonation are
flagged with is_admin_override=True for compliance reporting.
</code></pre>
<hr>
<h2 id="appendix-a-core-infrastructure-components">Appendix A: Core Infrastructure Components</h2>
<p>The following components are standard infrastructure that the HMIS shares with or is modeled after common enterprise patterns. Teams familiar with similar Python/Vue stacks will recognize these immediately.</p>

<table>
<thead>
<tr>
<th>Component</th>
<th>Description</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>core/auth.py</code></td>
<td>JWT token creation, verification, refresh</td>
<td>Standard JWT with bcrypt password hashing</td>
</tr>
<tr>
<td><code>core/middleware.py</code></td>
<td>Auth + tenant resolution on every request</td>
<td>Extracts org/entity from JWT claims</td>
</tr>
<tr>
<td><code>core/exceptions.py</code></td>
<td>Custom HTTP exceptions (404, 403, 422, etc.)</td>
<td>Consistent error response schema</td>
</tr>
<tr>
<td><code>core/logging.py</code></td>
<td>Structured JSON logging</td>
<td>Includes request_id, user_id, entity_id</td>
</tr>
<tr>
<td><code>models/base.py</code></td>
<td>BaseModel with UUID PK + audit fields</td>
<td>All healthcare models inherit from this</td>
</tr>
<tr>
<td><code>models/organization.py</code></td>
<td>Organization + Entity hierarchy</td>
<td>Drives multi-tenancy on all queries</td>
</tr>
<tr>
<td><code>models/user.py</code></td>
<td>User + Role + Permission models</td>
<td>Healthcare roles defined in Section 8</td>
</tr>
<tr>
<td><code>models/gl.py</code></td>
<td>Chart of accounts + GL entry model</td>
<td>Standard double-entry accounting</td>
</tr>
<tr>
<td><code>models/transaction.py</code></td>
<td>Central transaction model + GL rules</td>
<td>Extended with healthcare transaction types</td>
</tr>
<tr>
<td><code>models/inventory.py</code></td>
<td>Inventory items + stock movements</td>
<td>Extended by Pharmacy for drug dispensing</td>
</tr>
<tr>
<td><code>models/notification.py</code></td>
<td>SMS/email notification infrastructure</td>
<td>Used for lab alerts, appointment reminders</td>
</tr>
<tr>
<td><code>models/audit.py</code></td>
<td>Immutable audit log</td>
<td>Every clinical action writes here</td>
</tr>
<tr>
<td><code>routes/auth.py</code></td>
<td>Login, logout, token refresh endpoints</td>
<td>Standard JWT auth flow</td>
</tr>
<tr>
<td><code>routes/organizations.py</code></td>
<td>Organization + entity management</td>
<td>Admin-only setup</td>
</tr>
<tr>
<td><code>routes/gl.py</code></td>
<td>GL accounts + manual journal entries</td>
<td>Finance team access only</td>
</tr>
<tr>
<td><code>routes/mpesa.py</code></td>
<td>M-Pesa STK push + callback handling</td>
<td>Kenya mobile payments</td>
</tr>
<tr>
<td>Frontend auth store</td>
<td>Login state, token management, logout</td>
<td>Persisted in localStorage</td>
</tr>
<tr>
<td><code>AppLayout.vue</code></td>
<td>Main sidebar + nav shell</td>
<td>Adapts navigation to user role</td>
</tr>
<tr>
<td><code>LoginPage.vue</code></td>
<td>Login form + session bootstrap</td>
<td>Standard email+password</td>
</tr>
</tbody>
</table><hr>
<h2 id="appendix-b-key-decisions--rationale">Appendix B: Key Decisions &amp; Rationale</h2>
<p><strong>1. Standalone project, not an add-on to an existing system</strong><br>
Clinical data has fundamentally different compliance requirements. Mixing patient records with other business data in the same codebase creates compliance and audit complexity. A standalone project also allows the HMIS to scale independently.</p>
<p><strong>2. PostgreSQL JSONB for flexible clinical data</strong><br>
Vital signs, lab results, and examination findings vary greatly by specialty. Using JSONB for flexible structured data avoids schema migrations every time a new specialty is added while keeping data queryable with PostgreSQL’s JSONB operators.</p>
<p><strong>3. Immutable clinical records</strong><br>
Once a doctor finalizes a consultation or a lab result is released, it cannot be edited — only amended with a full audit trail. This is a medical-legal requirement in Kenya and globally (Kenya Health Act, 2017).</p>
<p><strong>4. Auto-billing from clinical events</strong><br>
Rather than billing staff manually entering charges, every clinical action (consultation, lab test, drug dispensed, bed night) automatically generates a bill line item. This prevents revenue leakage — a common problem in manual billing workflows.</p>
<p><strong>5. Unified GL posting via Transaction model</strong><br>
All hospital revenue flows through a central Transaction → GL posting mechanism. Each transaction type maps to a GL rule specifying which accounts to debit and credit, meaning one chart of accounts drives all financial reporting with zero manual journal entries.</p>
<p><strong>6. WebSocket for queue management</strong><br>
Queue display boards and nursing station alerts need real-time updates without polling. Litestar’s built-in WebSocket support enables push notifications to both queue screens and clinical staff.</p>
<p><strong>7. rv-grid for all data tables</strong><br>
Rather than building and maintaining custom table components for every clinical list (queues, results, claims, etc.), rv-grid provides a production-grade, high-performance grid with sorting, filtering, pagination, and custom cell rendering out of the box. This significantly reduces frontend development and testing effort.</p>
<p><strong>8. Lucide for icons</strong><br>
All icons use Lucide (stroke-based, consistent line weight). Fill-based icon sets look visually heavy in dense clinical interfaces. Stroke icons maintain readability at small sizes and align with the minimal medical brand.</p>
<p><strong>9. Modular monolith over microservices</strong><br>
Clinical billing, inventory, and GL must update atomically in a single transaction. A microservices architecture would require distributed transactions (saga pattern), adding significant complexity with no operational benefit at clinic scale. A modular monolith delivers clear module boundaries while maintaining transactional integrity and simple deployment.</p>
<p><strong>10. Patient Portal as a separate auth surface</strong><br>
The patient portal uses a distinct JWT claim (<code>patient_id</code>) and a separate Pinia store. This prevents any possibility of a patient session accidentally carrying staff permissions. The portal routes are isolated under <code>/portal</code> and protected by a <code>requiresPortalAuth</code> route guard distinct from the staff <code>requiresAuth</code> guard.</p>
<p><strong>11. QR code tokenization (not raw UUID)</strong><br>
Patient QR codes encode an HMAC-signed token derived from the patient number, not the raw UUID or patient_id. This prevents enumeration attacks: even if someone photographs a printed QR, they cannot derive any other patient’s token. Tokens are time-stable (valid indefinitely) for printed cards but can be regenerated if a card is lost.</p>
<p><strong>12. FEFO dispensing (First Expiry, First Out)</strong><br>
Pharmacy dispensing always selects the batch with the nearest expiry date first. This minimizes drug wastage and ensures patients never receive drugs near or past expiry. The batch selection is enforced at service layer — pharmacists see the selected batch but cannot override to a later-expiry batch without supervisor override.</p>
<p><strong>13. Per-entity configurable vital thresholds</strong><br>
Triage abnormal flagging thresholds (e.g., high BP cutoffs) are configurable per entity rather than hardcoded. A paediatric clinic may use different normal ranges than an adult general clinic. Defaults match Kenya Clinical Guidelines; entities can override through admin configuration.</p>
<p><strong>14. Kenya region tables as shared reference data (no org scope)</strong><br>
Counties, sub-counties, and administrative wards are national reference data — the same 47 counties exist for every hospital. Making them organization-scoped would require duplicating 1,450+ ward records per organization. Instead they are global seed data shared across all tenants. Patient and entity models reference them via FK. This also enables cross-facility geographic analytics and clean DHIS2 org unit mapping using official <code>dhis2_uid</code> codes.</p>
<p><strong>15. Global UI component registration over per-file imports</strong><br>
All <code>ui/</code> base components (AppButton, AppCard, AppMetricCard, etc.) are registered globally via a plugin. This eliminates repetitive import statements in every feature component, keeps feature code focused on business logic, and makes the design system components feel like first-class HTML elements. Since these components are small and always needed, there is no meaningful bundle-size penalty compared to per-file imports with tree shaking.</p>
<p><strong>17. Seed global disease, drug, and lab catalogs from public datasets</strong><br>
Requiring clinicians to manually type drug names, ICD-10 codes, and lab test names before going live creates two problems: data entry errors and significant onboarding delay. By seeding from authoritative public sources (WHO ICD-10, Kenya KEML, LOINC), every new entity starts with a complete, standardized catalog in minutes. Doctors get autocomplete on ~14,400 disease codes from day one; pharmacists get a drug list of ~600 medicines; lab technicians get ~180 tests with reference ranges pre-loaded. Facilities only need to set prices — the clinical content is ready.</p>
<p><strong>18. Drug catalog and lab catalog are entity-scoped copies of global master data</strong><br>
Although the drug_master and lab_test_master are global, each entity gets its own <code>drug_catalog</code> and <code>lab_test_catalog</code> rows. This allows entities to: set their own selling prices, disable drugs/tests they don’t offer, add custom local drugs not on the global list, and track stock independently. The global master is linked by FK (<code>drug_master_id</code>) so entities always benefit from master updates while retaining their own configuration.</p>
<p><strong>16. AppRegionSelect as a compound component</strong><br>
The county → sub-county → ward selection pattern appears everywhere (patient registration, entity setup, reporting filters). A single <code>AppRegionSelect</code> compound component encapsulates the three-level cascade, loading state, reset behavior, and DHIS2 UID resolution. Callers use three v-model bindings and get the full cascade for free without reimplementing it.</p>
<hr>
<p><em>Document maintained by the engineering team. Version history tracked in git.</em></p>
</div>
</body>

</html>
